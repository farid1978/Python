
----------------------------------------------------------------------Script Description -------------------------------------------------------------------
--Note:
--1. To facilitate script display, all output is saved as temporary tables. Some temporary tables are generated as basic tables to be invoked by other scripts to reduce the number of complex calculations. Tables exported from temporary tables that are generated by executing statements marked with "Export" are the input for Tableau. Temporary tables generated by executing unmarked statements do not need to be exported. (For details about how to export the tables, see the related delivery guide.)
--2. Statements in this script are executed in sequence unless otherwise specified.
--3. The output tables are used as the input source of Tableau, and the format of the table headers cannot be changed.
--4. The name format of an exported temporary table is tmp_ZCS_234GMigration_TER_Base0_@OutputName. tmp indicates that the table is a temporary one. ZCS indicates service analysis. 234GMigration indicates the theme name. TER_Base0 indicates the name of the temporary table under the theme. @OutputName indicates the file name extension which can be customized by a site and distinguishes the results of different subscribers or different dates or regions.
--5. Constraints on the script:
--   1) Possible errors in the platform device library have been considered and corrected using the script. However, there still may be a little incorrect information about device-supported RATs. 
--   2) The script execution may be slow because PS domain xDRs are involved. You are advised to spare one day to execute the script.
--   3) Some sites may not have PS xDRs. You need to delete xDRs that do not exist at related sites.
--   4) The script is applicable to 2G/3G-to-4G migration and is not applicable to 2G-to-3G migration. If the 2G-to-3G migration scenario is required, modify the final result table for the scenario.
--   5) The script is used for scenarios of single IMEI corresponding to dual IMSIs and does not focus on those of single IMEI corresponding to multiple IMSIs.
--   6) Dual-SIM subscribers are those using two SIM cards of one carrier on one device. Subscribers whose two SIM cards are served by different carriers cannot be identified.
--   7) Unavoidable defects: When the number of subscribers is measured, IMSIs are used for deduplication. However, subscribers are categorized by IMSI+IMEI (device capability).
--      An IMSI may correspond to multiple IMEIs (one IMSI is used on multiple devices in two days), and a subscriber is counted in different categories.
--      In this situation, the total number of subscribers in all category tables is greater than the actual total number of subscribers. Additionally, more categories lead to greater deviations. In general, the subscriber quantity deviation is generated only among subscribers who use one IMSI on multiple devices. The deviation proportion is within 1% or 2%.
--      If the proportion exceeds 1% or 2%, there may be errors in the IMS and IMEI association, which causes one IMSI to correspond to multiple IMEIs. The issue that an IMEI is empty after backfilling on the platform can be resolved by the script. However, incorrect association after backfilling can be corrected only by the platform. 
--6. Analysis dimensions and methods
--   1) The analysis results are organized by user group which can be categorized into any desired user group types in the output. Theoretically, more than 5000 types of user groups are supported.
--   2) The analysis results focus on key areas where device, 4G coverage, and traffic promotion activities need to be launched. 

--7. If data in the platform engineering parameter table is inaccurate, create an engineering parameter table named tmp_dim_loc_cgisai on the platform and containing accurate data before script execution. The table must contain engineering parameter fields Access_Type, Cell_Name, xpos, ypos, and CGISAI. For details about how to create a table, see the following example. Additionally, nethouse.dim_loc_cgisai in the script needs to be replaced with tmp_dim_loc_cgisai.
---Example for creating table tmp_dim_loc_cgisai:
---                    drop table if exists  tmp_dim_loc_cgisai;
---                    create table tmp_dim_loc_cgisai
---                      (Access_Type STRING,
---                        Cell_Name STRING,
---                        xpos bigint,
---                        ypos bigint,
---                        CGISAI STRING
---                       );
---                     insert into  table tmp_dim_loc_cgisai
---                        (Access_Type,Cell_Name,xpos,ypos,CGISAI)
---                     values
---                        ('2G','Tdde_29k',33086759,40131341,'470012715C914'),
---                        ('3G','IDMER',39919970,15254940,'4700104C064CD'),
---                        ('4G','KVIENSS',23590833,63529833,'470011B5980B')
---                        ;
--8. User-defined parameters related to this script:
--            @daytime: Indicates the date used in a loop statement. The format is YYYY-MM-DD, for example, 2018-07-23. Specific time is not required.
--      @Repeat_Begin: Indicates the start time in the "union all" statement.
--      @Repeat_End: Indicates the end time in the "union all" statement.
--      @begintime: Indicates the start date selected on the GUI.
--      @endtime: Indicates the end date selected on the GUI.
--     @MCCMNC: Indicates the MCC and MNC (currently collected) of the network that a subscriber camps on. Multiple codes are separated by commas (,), for example, '28063','28064'. This format ensures that data of all subscribers on a network can be collected.
--            (@timezone): Indicates the time zone of the current network.
--       @XDR_suffix: Indicates the xDR script date suffix. The CEM Insight Expert Tool converts the calendar date to the database date. If the data of multiple days is aggregated, the tool automatically executes the "union all" statement.
--      @OutputName: Indicates the output file name extension which is added to facilitate customized temporary table maintenance. It distinguishes the results for different subscribers or different dates or regions.
--      @4G_Freq: Indicates the 4G frequency band supported by the current network. The value must be in the format of 'LTE FDD BAND 3','LTE TDD BAND 38','LTE TDD BAND 41'. Use commas (,) to separate multiple values.
--      @3G_Mode: Indicates the 3G RAT type supported by the current network. WCDMA, CDMA2000, and TD-SCDMA 3 are available.
--      @High_Threshold: Indicates the threshold defining subscribers who consume heavy traffic. The default value is 0.2, indicating that top and bottom 20% subscribers consume heavy and light traffic, respectively. The remaining subscribers consume moderate traffic.
--      @Cover_Distance: Indicates the distance for determining whether there is 4G coverage in the cell with the heaviest traffic if a 4G site is deployed within the distance around the cell. The default value is 300 m, indicating that there is 4G coverage in the cell if a 4G site is deployed within the distance around the cell. 
--      @4GFallBack_Threshold: Indicates the threshold for determining whether a 4G subscriber has fallen back to the 2G or 3G network. The default value is 0.8, indicating that a 4G subscriber has fallen back to the 2G or 3G network if the traffic consumed by the subscriber on the 4G network is less than 80% of the total consumed traffic.
--      @Start_Time: Indicates the start time of the period when a cell is considered the resident cell. The default value is 9, which means 09: 00. The resident cell serves subscribers consuming light traffic and is located to launch service promotion activities. By default, the cell where subscribers consuming light traffic camps on during 09:00 to 11:00 is the resident cell.
--      @End_Time: Indicates the end time of the period when a cell is considered the resident cell. The default value is 11, which means 11: 00. The resident cell serves subscribers consuming light traffic and is located to launch service promotion activities. By default, the cell where subscribers consuming light traffic camps on during 09:00 to 11:00 is the resident cell.
--      @Camping_Ratio: Indicates the time ratio of camping on the resident cell. The default value is 0.3, indicating that a subscriber camps on the resident cell for more than 30% of the total on-net time. Only such subscribers are regarded as valid camping subscribers. Those do not meet this condition are regarded as continuous mobile subscribers whose resident cells do not need to be obtained.


----  The script and Tableau template are prepared by Zhao Chengshi (employee ID: z00344252).

--<subquery_01>
-----------------------------------------------------------------------Create a device basic table that contains data of device capabilities and frequency bands supported. -------------------------------------------------------------
----select  * from tmp_ZCS_234GMigration_TER_Base0_@OutputName where Band_Support_Mode ='4G' limit 100;
drop table if exists  tmp_ZCS_234GMigration_TER_Base0_py_5_11Abr21;
create table tmp_ZCS_234GMigration_TER_Base0_py_5_11Abr21
(
tac STRING,
Phone_Brand STRING,
Phone_Model STRING,
Phone_Mode  STRING,
Phone_Type STRING,
Phone_OS STRING,
TER_Support_Mode STRING,
Band_Support_Mode STRING
);
insert into tmp_ZCS_234GMigration_TER_Base0_py_5_11Abr21
select d.tac,Phone_Brand,Phone_Model,Phone_Mode,Phone_Type,Phone_OS,TER_Support_Mode,
        max(case  when upper(3G_Mode) in ('WCDMA') then ---3G RAT type supported by the onsite network
                             case when  (d.terbandname like '%WCDMA%')  or (d.terbandname like '%HSPA%') then '3G' 
                                     when  d.terbandname in ('LTE FDD BAND 31','LTE TDD BAND 33','LTE FDD BAND 1','LTE FDD BAND 10','LTE FDD BAND 3','LTE FDD BAND 23','LTE FDD BAND 30','LTE FDD BAND 17','LTE TDD BAND 43','LTE FDD BAND 66','LTE FDD BAND 6','LTE FDD BAND 24','LTE TDD BAND 39','LTE FDD BAND 32','LTE TDD BAND 44','LTE FDD BAND 11','LTE FDD BAND 28','LTE FDD BAND 20','LTE FDD BAND 71','LTE TDD BAND 38','LTE FDD BAND 8','LTE FDD BAND 14','LTE FDD BAND 26','LTE TDD BAND 42','LTE FDD BAND 7','LTE FDD BAND 13','LTE FDD BAND 5','LTE FDD BAND 12','LTE FDD BAND 18','LTE FDD BAND 21','LTE FDD BAND 22', 'LTE FDD BAND 25','LTE FDD BAND 29','LTE TDD BAND 40','LTE FDD BAND 4','LTE FDD BAND 2','LTE TDD BAND 41','LTE FDD BAND 15','LTE FDD BAND 19','LTE TDD BAND 34','LTE TDD BAND 48','LTE FDD BAND 9','LTE FDD BAND 16','LTE FDD BAND 27') then '4G' ---4G frequency band supported by the onsite network
                                     else '2G' end  
                  when upper(3G_Mode) in ('CDMA2000') then ---3G RAT type supported by the onsite network
                             case when  (d.terbandname like '%CDMA2000%')   then '3G'   
                                     when  d.terbandname in ('LTE FDD BAND 31','LTE TDD BAND 33','LTE FDD BAND 1','LTE FDD BAND 10','LTE FDD BAND 3','LTE FDD BAND 23','LTE FDD BAND 30','LTE FDD BAND 17','LTE TDD BAND 43','LTE FDD BAND 66','LTE FDD BAND 6','LTE FDD BAND 24','LTE TDD BAND 39','LTE FDD BAND 32','LTE TDD BAND 44','LTE FDD BAND 11','LTE FDD BAND 28','LTE FDD BAND 20','LTE FDD BAND 71','LTE TDD BAND 38','LTE FDD BAND 8','LTE FDD BAND 14','LTE FDD BAND 26','LTE TDD BAND 42','LTE FDD BAND 7','LTE FDD BAND 13','LTE FDD BAND 5','LTE FDD BAND 12','LTE FDD BAND 18','LTE FDD BAND 21','LTE FDD BAND 22', 'LTE FDD BAND 25','LTE FDD BAND 29','LTE TDD BAND 40','LTE FDD BAND 4','LTE FDD BAND 2','LTE TDD BAND 41','LTE FDD BAND 15','LTE FDD BAND 19','LTE TDD BAND 34','LTE TDD BAND 48','LTE FDD BAND 9','LTE FDD BAND 16','LTE FDD BAND 27') then '4G' ---4G frequency band supported by the onsite network
                                     else '2G'  end 
                  when upper(3G_Mode) in ('TD-SCDMA') then ---3G RAT type supported by the onsite network
                             case when  (d.terbandname like '%TD-SCDMA%')   then '3G'   
                                     when  d.terbandname in ('LTE FDD BAND 31','LTE TDD BAND 33','LTE FDD BAND 1','LTE FDD BAND 10','LTE FDD BAND 3','LTE FDD BAND 23','LTE FDD BAND 30','LTE FDD BAND 17','LTE TDD BAND 43','LTE FDD BAND 66','LTE FDD BAND 6','LTE FDD BAND 24','LTE TDD BAND 39','LTE FDD BAND 32','LTE TDD BAND 44','LTE FDD BAND 11','LTE FDD BAND 28','LTE FDD BAND 20','LTE FDD BAND 71','LTE TDD BAND 38','LTE FDD BAND 8','LTE FDD BAND 14','LTE FDD BAND 26','LTE TDD BAND 42','LTE FDD BAND 7','LTE FDD BAND 13','LTE FDD BAND 5','LTE FDD BAND 12','LTE FDD BAND 18','LTE FDD BAND 21','LTE FDD BAND 22', 'LTE FDD BAND 25','LTE FDD BAND 29','LTE TDD BAND 40','LTE FDD BAND 4','LTE FDD BAND 2','LTE TDD BAND 41','LTE FDD BAND 15','LTE FDD BAND 19','LTE TDD BAND 34','LTE TDD BAND 48','LTE FDD BAND 9','LTE FDD BAND 16','LTE FDD BAND 27') then '4G' ---4G frequency band supported by the onsite network
                                     else '2G'   end ---3G RAT type supported by the onsite network
                        else 'Wrong_3GMode_Input' end) 
        as Band_Support_Mode
from
    (select TER.tac,ter.ter_brand_name as Phone_Brand,TER.ter_model_name as Phone_Model,TER.ter_modename as Phone_Mode,TER.ter_type_name_en as Phone_Type,TER.ter_os_type_name as Phone_OS,
        case when ter_modename like '%LTE%' then '4G'
              when ter_modename like '%3G%' then '3G'
              else '2G'
            end as TER_Support_Mode,
     b.terbandname,'WCDMA' as 3G_Mode
        from nethouse.dim_TERMINAL TER,nethouse.CFG_TERMINAL_BAND b,nethouse.CFG_TERMINAL_BAND_REF c
        where ter.tac=c.tac and c.TERBAND=b.TERBAND
        group by TER.tac,Phone_Brand,Phone_Model,Phone_Mode,Phone_Type,Phone_OS,TER_Support_Mode,b.terbandname
    ) d
group by d.tac,Phone_Brand,Phone_Model,Phone_Mode,Phone_Type,Phone_OS,TER_Support_Mode
;
--</subquery_01>

--<subquery_02>
-- In the device library, some devices support 3G frequency bands which, however, are marked as 2G frequency bands. You need to correct the frequency bands.

----select  * from tmp_ZCS_234GMigration_TER_Base_@OutputName where max_support_mode ='4G' limit 100;
drop table if exists  tmp_ZCS_234GMigration_TER_Base_py_5_11Abr21;
create table tmp_ZCS_234GMigration_TER_Base_py_5_11Abr21
(
tac STRING,
Phone_Brand STRING,
Phone_Model STRING,
Phone_Mode  STRING,
Phone_Type STRING,
Phone_OS STRING,
TER_Support_Mode STRING,
Band_Support_Mode STRING
);
insert into tmp_ZCS_234GMigration_TER_Base_py_5_11Abr21
select tac ,Phone_Brand ,Phone_Model ,
case when Band_Support_Mode>TER_Support_Mode  then Band_Support_Mode
        else TER_Support_Mode end as Phone_Mode,
        Phone_Type ,Phone_OS ,
case when Band_Support_Mode>TER_Support_Mode  then Band_Support_Mode
        else TER_Support_Mode end as TER_Support_Mode,
        Band_Support_Mode
from tmp_ZCS_234GMigration_TER_Base0_py_5_11Abr21 
;
--</subquery_02>

--<subquery_03>
--------------------------------Create a PS traffic basic table.------------------------------------------------------------------
----select  * from tmp_ZCS_234GMigration_PSTraffic_Base0_@OutputName 
drop table if exists  tmp_ZCS_234GMigration_PSTraffic_Base0_py_5_11Abr21;
create table tmp_ZCS_234GMigration_PSTraffic_Base0_py_5_11Abr21
(
IMSI STRING,
IMEI STRING,
RAT INT,
SAI_CGI_ECGI STRING,
Traffic_MB DOUBLE,
L7_UL_GOODPUT_kb DOUBLE,
DATATRANS_UL_s DOUBLE,
L7_DW_GOODPUT_kb DOUBLE,
DATATRANS_DW_s DOUBLE
);
insert into tmp_ZCS_234GMigration_PSTraffic_Base0_py_5_11Abr21
select IMSI,IMEI,RAT,SAI_CGI_ECGI,
        1.0*sum(coalesce(l4_ul_throughput,0)+coalesce(l4_dw_throughput,0))/1024/1024 as  Traffic_MB,
        1.0*sum(L7_UL_GOODPUT_FULL_MSS)*8/1024 as L7_UL_GOODPUT_kb,
        1.0*sum(DATATRANS_UL_DURATION)/1000000000 as DATATRANS_UL_s,
        1.0*sum(L7_DW_GOODPUT_FULL_MSS)*8/1024 as L7_DW_GOODPUT_kb,
        1.0*sum(DATATRANS_DW_DURATION)/1000000000 as DATATRANS_DW_s
    from
        (
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')  and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-05 00:00:00') +cast(8*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')  and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-06 00:00:00') +cast(8*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')  and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-07 00:00:00') +cast(8*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')  and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-08 00:00:00') +cast(8*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')  and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-09 00:00:00') +cast(8*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')  and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-10 00:00:00') +cast(8*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')  and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-11 00:00:00') +cast(8*3600 as int)
       
       ) a
group by IMSI,IMEI,RAT,SAI_CGI_ECGI
;
--</subquery_03>

--<subquery_04>
insert into tmp_ZCS_234GMigration_PSTraffic_Base0_py_5_11Abr21
select IMSI,IMEI,RAT,SAI_CGI_ECGI,
        1.0*sum(coalesce(l4_ul_throughput,0)+coalesce(l4_dw_throughput,0))/1024/1024 as  Traffic_MB,
        1.0*sum(L7_UL_GOODPUT_FULL_MSS)*8/1024 as L7_UL_GOODPUT_kb,
        1.0*sum(DATATRANS_UL_DURATION)/1000000000 as DATATRANS_UL_s,
        1.0*sum(L7_DW_GOODPUT_FULL_MSS)*8/1024 as L7_DW_GOODPUT_kb,
        1.0*sum(DATATRANS_DW_DURATION)/1000000000 as DATATRANS_DW_s
    from
        (
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')  +cast(8*3600 as int)  and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-05 00:00:00') +cast(16*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')  +cast(8*3600 as int)  and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-06 00:00:00') +cast(16*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')  +cast(8*3600 as int)  and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-07 00:00:00') +cast(16*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')  +cast(8*3600 as int)  and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-08 00:00:00') +cast(16*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')  +cast(8*3600 as int)  and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-09 00:00:00') +cast(16*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')  +cast(8*3600 as int)  and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-10 00:00:00') +cast(16*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')  +cast(8*3600 as int)  and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-11 00:00:00') +cast(16*3600 as int)
       
       ) a
group by IMSI,IMEI,RAT,SAI_CGI_ECGI
;
--</subquery_04>

--<subquery_05>
insert into tmp_ZCS_234GMigration_PSTraffic_Base0_py_5_11Abr21
select IMSI,IMEI,RAT,SAI_CGI_ECGI,
        1.0*sum(coalesce(l4_ul_throughput,0)+coalesce(l4_dw_throughput,0))/1024/1024 as  Traffic_MB,
        1.0*sum(L7_UL_GOODPUT_FULL_MSS)*8/1024 as L7_UL_GOODPUT_kb,
        1.0*sum(DATATRANS_UL_DURATION)/1000000000 as DATATRANS_UL_s,
        1.0*sum(L7_DW_GOODPUT_FULL_MSS)*8/1024 as L7_DW_GOODPUT_kb,
        1.0*sum(DATATRANS_DW_DURATION)/1000000000 as DATATRANS_DW_s
    from
        (
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')    and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')  +cast(16*3600 as int) and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-05 00:00:00') +cast(20*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')    and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')  +cast(16*3600 as int) and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-06 00:00:00') +cast(20*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')    and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')  +cast(16*3600 as int) and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-07 00:00:00') +cast(20*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')    and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')  +cast(16*3600 as int) and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-08 00:00:00') +cast(20*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')    and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')  +cast(16*3600 as int) and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-09 00:00:00') +cast(20*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')    and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')  +cast(16*3600 as int) and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-10 00:00:00') +cast(20*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')    and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')  +cast(16*3600 as int) and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-11 00:00:00') +cast(20*3600 as int)
       
       ) a
group by IMSI,IMEI,RAT,SAI_CGI_ECGI
;
--</subquery_05>

--<subquery_06>
insert into tmp_ZCS_234GMigration_PSTraffic_Base0_py_5_11Abr21
select IMSI,IMEI,RAT,SAI_CGI_ECGI,
        1.0*sum(coalesce(l4_ul_throughput,0)+coalesce(l4_dw_throughput,0))/1024/1024 as  Traffic_MB,
        1.0*sum(L7_UL_GOODPUT_FULL_MSS)*8/1024 as L7_UL_GOODPUT_kb,
        1.0*sum(DATATRANS_UL_DURATION)/1000000000 as DATATRANS_UL_s,
        1.0*sum(L7_DW_GOODPUT_FULL_MSS)*8/1024 as L7_DW_GOODPUT_kb,
        1.0*sum(DATATRANS_DW_DURATION)/1000000000 as DATATRANS_DW_s
    from
        (
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')  +cast(20*3600 as int) and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-05 00:00:00') +cast(24*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')  +cast(20*3600 as int) and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-06 00:00:00') +cast(24*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')  +cast(20*3600 as int) and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-07 00:00:00') +cast(24*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')  +cast(20*3600 as int) and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-08 00:00:00') +cast(24*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')  +cast(20*3600 as int) and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-09 00:00:00') +cast(24*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')  +cast(20*3600 as int) and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-10 00:00:00') +cast(24*3600 as int)
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_other_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  and BEGIN_TIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')  +cast(20*3600 as int) and BEGIN_TIME<UNIX_TIMESTAMP('2021-04-11 00:00:00') +cast(24*3600 as int)
       
       ) a
group by IMSI,IMEI,RAT,SAI_CGI_ECGI
;
--</subquery_06>


--<subquery_07>
insert into tmp_ZCS_234GMigration_PSTraffic_Base0_py_5_11Abr21
select IMSI,IMEI,RAT,SAI_CGI_ECGI,
        1.0*sum(coalesce(l4_ul_throughput,0)+coalesce(l4_dw_throughput,0))/1024/1024 as  Traffic_MB,
        1.0*sum(L7_UL_GOODPUT_FULL_MSS)*8/1024 as L7_UL_GOODPUT_kb,
        1.0*sum(DATATRANS_UL_DURATION)/1000000000 as DATATRANS_UL_s,
        1.0*sum(L7_DW_GOODPUT_FULL_MSS)*8/1024 as L7_DW_GOODPUT_kb,
        1.0*sum(DATATRANS_DW_DURATION)/1000000000 as DATATRANS_DW_s
    from
        (
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,1000000*DATATRANS_UL_DURATION as DATATRANS_UL_DURATION,UNIX_TIMESTAMP('empty') as L7_DW_GOODPUT_FULL_MSS,UNIX_TIMESTAMP('empty') as DATATRANS_DW_DURATION,   ---The L7_DW_GOODPUT_FULL_MSS field is not in the table and therefore is assigned value null on the downlink. 
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_streaming_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_email_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,1000000*DATATRANS_UL_DURATION as DATATRANS_UL_DURATION,UNIX_TIMESTAMP('empty') as L7_DW_GOODPUT_FULL_MSS,UNIX_TIMESTAMP('empty') as DATATRANS_DW_DURATION,  ---The L7_DW_GOODPUT_FULL_MSS field is not in the table and therefore is assigned value null on the downlink. 

                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_http_browsing_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DL_GOODPUT_FULL_MSS as L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION, 
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_FTP_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_IM_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_VOIP_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_FILEACCESS_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
--        union all 
--         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
--                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--                          when RAT=2 then concat(MCC,MNC,LAC,CI)
--                          when RAT=6 then concat(MCC,MNC,ECI)  end      
--                as SAI_CGI_ECGI  --Cell ID       
--            from ps.DETAIL_UFDR_SNS_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,1000000*DATATRANS_UL_DURATION as DATATRANS_UL_DURATION,UNIX_TIMESTAMP('empty') as L7_DW_GOODPUT_FULL_MSS,UNIX_TIMESTAMP('empty') as DATATRANS_DW_DURATION,   ---The L7_DW_GOODPUT_FULL_MSS field is not in the table and therefore is assigned value null on the downlink. 
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_streaming_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_email_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,1000000*DATATRANS_UL_DURATION as DATATRANS_UL_DURATION,UNIX_TIMESTAMP('empty') as L7_DW_GOODPUT_FULL_MSS,UNIX_TIMESTAMP('empty') as DATATRANS_DW_DURATION,  ---The L7_DW_GOODPUT_FULL_MSS field is not in the table and therefore is assigned value null on the downlink. 

                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_http_browsing_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DL_GOODPUT_FULL_MSS as L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION, 
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_FTP_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_IM_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_VOIP_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_FILEACCESS_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
--        union all 
--         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
--                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--                          when RAT=2 then concat(MCC,MNC,LAC,CI)
--                          when RAT=6 then concat(MCC,MNC,ECI)  end      
--                as SAI_CGI_ECGI  --Cell ID       
--            from ps.DETAIL_UFDR_SNS_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,1000000*DATATRANS_UL_DURATION as DATATRANS_UL_DURATION,UNIX_TIMESTAMP('empty') as L7_DW_GOODPUT_FULL_MSS,UNIX_TIMESTAMP('empty') as DATATRANS_DW_DURATION,   ---The L7_DW_GOODPUT_FULL_MSS field is not in the table and therefore is assigned value null on the downlink. 
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_streaming_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_email_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,1000000*DATATRANS_UL_DURATION as DATATRANS_UL_DURATION,UNIX_TIMESTAMP('empty') as L7_DW_GOODPUT_FULL_MSS,UNIX_TIMESTAMP('empty') as DATATRANS_DW_DURATION,  ---The L7_DW_GOODPUT_FULL_MSS field is not in the table and therefore is assigned value null on the downlink. 

                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_http_browsing_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DL_GOODPUT_FULL_MSS as L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION, 
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_FTP_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_IM_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_VOIP_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_FILEACCESS_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
--        union all 
--         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
--                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--                          when RAT=2 then concat(MCC,MNC,LAC,CI)
--                          when RAT=6 then concat(MCC,MNC,ECI)  end      
--                as SAI_CGI_ECGI  --Cell ID       
--            from ps.DETAIL_UFDR_SNS_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,1000000*DATATRANS_UL_DURATION as DATATRANS_UL_DURATION,UNIX_TIMESTAMP('empty') as L7_DW_GOODPUT_FULL_MSS,UNIX_TIMESTAMP('empty') as DATATRANS_DW_DURATION,   ---The L7_DW_GOODPUT_FULL_MSS field is not in the table and therefore is assigned value null on the downlink. 
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_streaming_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_email_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,1000000*DATATRANS_UL_DURATION as DATATRANS_UL_DURATION,UNIX_TIMESTAMP('empty') as L7_DW_GOODPUT_FULL_MSS,UNIX_TIMESTAMP('empty') as DATATRANS_DW_DURATION,  ---The L7_DW_GOODPUT_FULL_MSS field is not in the table and therefore is assigned value null on the downlink. 

                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_http_browsing_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DL_GOODPUT_FULL_MSS as L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION, 
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_FTP_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_IM_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_VOIP_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_FILEACCESS_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
--        union all 
--         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
--                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--                          when RAT=2 then concat(MCC,MNC,LAC,CI)
--                          when RAT=6 then concat(MCC,MNC,ECI)  end      
--                as SAI_CGI_ECGI  --Cell ID       
--            from ps.DETAIL_UFDR_SNS_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,1000000*DATATRANS_UL_DURATION as DATATRANS_UL_DURATION,UNIX_TIMESTAMP('empty') as L7_DW_GOODPUT_FULL_MSS,UNIX_TIMESTAMP('empty') as DATATRANS_DW_DURATION,   ---The L7_DW_GOODPUT_FULL_MSS field is not in the table and therefore is assigned value null on the downlink. 
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_streaming_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_email_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,1000000*DATATRANS_UL_DURATION as DATATRANS_UL_DURATION,UNIX_TIMESTAMP('empty') as L7_DW_GOODPUT_FULL_MSS,UNIX_TIMESTAMP('empty') as DATATRANS_DW_DURATION,  ---The L7_DW_GOODPUT_FULL_MSS field is not in the table and therefore is assigned value null on the downlink. 

                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_http_browsing_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DL_GOODPUT_FULL_MSS as L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION, 
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_FTP_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_IM_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_VOIP_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_FILEACCESS_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
--        union all 
--         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
--                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--                          when RAT=2 then concat(MCC,MNC,LAC,CI)
--                          when RAT=6 then concat(MCC,MNC,ECI)  end      
--                as SAI_CGI_ECGI  --Cell ID       
--            from ps.DETAIL_UFDR_SNS_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,1000000*DATATRANS_UL_DURATION as DATATRANS_UL_DURATION,UNIX_TIMESTAMP('empty') as L7_DW_GOODPUT_FULL_MSS,UNIX_TIMESTAMP('empty') as DATATRANS_DW_DURATION,   ---The L7_DW_GOODPUT_FULL_MSS field is not in the table and therefore is assigned value null on the downlink. 
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_streaming_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_email_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,1000000*DATATRANS_UL_DURATION as DATATRANS_UL_DURATION,UNIX_TIMESTAMP('empty') as L7_DW_GOODPUT_FULL_MSS,UNIX_TIMESTAMP('empty') as DATATRANS_DW_DURATION,  ---The L7_DW_GOODPUT_FULL_MSS field is not in the table and therefore is assigned value null on the downlink. 

                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_http_browsing_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DL_GOODPUT_FULL_MSS as L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION, 
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_FTP_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_IM_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_VOIP_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_FILEACCESS_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
--        union all 
--         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
--                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--                          when RAT=2 then concat(MCC,MNC,LAC,CI)
--                          when RAT=6 then concat(MCC,MNC,ECI)  end      
--                as SAI_CGI_ECGI  --Cell ID       
--            from ps.DETAIL_UFDR_SNS_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
       union all
        select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,1000000*DATATRANS_UL_DURATION as DATATRANS_UL_DURATION,UNIX_TIMESTAMP('empty') as L7_DW_GOODPUT_FULL_MSS,UNIX_TIMESTAMP('empty') as DATATRANS_DW_DURATION,   ---The L7_DW_GOODPUT_FULL_MSS field is not in the table and therefore is assigned value null on the downlink. 
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_streaming_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_email_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,1000000*DATATRANS_UL_DURATION as DATATRANS_UL_DURATION,UNIX_TIMESTAMP('empty') as L7_DW_GOODPUT_FULL_MSS,UNIX_TIMESTAMP('empty') as DATATRANS_DW_DURATION,  ---The L7_DW_GOODPUT_FULL_MSS field is not in the table and therefore is assigned value null on the downlink. 

                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.detail_ufdr_http_browsing_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DL_GOODPUT_FULL_MSS as L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION, 
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_FTP_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_IM_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_VOIP_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
        union all 
         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
                          when RAT=2 then concat(MCC,MNC,LAC,CI)
                          when RAT=6 then concat(MCC,MNC,ECI)  end      
                as SAI_CGI_ECGI  --Cell ID       
            from ps.DETAIL_UFDR_FILEACCESS_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
--        union all 
--         select IMSI,IMEI,RAT, l4_ul_throughput,l4_dw_throughput,L7_UL_GOODPUT_FULL_MSS,DATATRANS_UL_DURATION,L7_DW_GOODPUT_FULL_MSS,DATATRANS_DW_DURATION,
--                case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--                          when RAT=2 then concat(MCC,MNC,LAC,CI)
--                          when RAT=6 then concat(MCC,MNC,ECI)  end      
--                as SAI_CGI_ECGI  --Cell ID       
--            from ps.DETAIL_UFDR_SNS_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
       
       ) a
group by IMSI,IMEI,RAT,SAI_CGI_ECGI
;
--</subquery_07>

--<subquery_08>
----select  * from tmp_ZCS_234GMigration_PSTraffic_Base_@OutputName 
drop table if exists  tmp_ZCS_234GMigration_PSTraffic_Base_py_5_11Abr21;
create table tmp_ZCS_234GMigration_PSTraffic_Base_py_5_11Abr21
(
IMSI STRING,
IMEI STRING,
RAT INT,
SAI_CGI_ECGI STRING,
Traffic_MB DOUBLE,
L7_UL_GOODPUT_kb DOUBLE,
DATATRANS_UL_s DOUBLE,
L7_DW_GOODPUT_kb DOUBLE,
DATATRANS_DW_s DOUBLE
);
insert into tmp_ZCS_234GMigration_PSTraffic_Base_py_5_11Abr21
select IMSI,IMEI,RAT,SAI_CGI_ECGI,
        1.0*sum(Traffic_MB) as  Traffic_MB,
        1.0*sum(L7_UL_GOODPUT_kb) as L7_UL_GOODPUT_kb,
        1.0*sum(DATATRANS_UL_s) as DATATRANS_UL_s,
        1.0*sum(L7_DW_GOODPUT_kb) as L7_DW_GOODPUT_kb,
        1.0*sum(DATATRANS_DW_s) as DATATRANS_DW_s
    from
        tmp_ZCS_234GMigration_PSTraffic_Base0_py_5_11Abr21 a
group by IMSI,IMEI,RAT,SAI_CGI_ECGI
;
--</subquery_08>

--<subquery_09>
--------------------------------Create a PS traffic table.----------------------------
----select  * from tmp_ZCS_234GMigration_PSTraffic_@OutputName limit 100;
drop table if exists  tmp_ZCS_234GMigration_PSTraffic_py_5_11Abr21;
create table tmp_ZCS_234GMigration_PSTraffic_py_5_11Abr21
(
IMSI STRING,
IMEI STRING,
2G_traffic_MB DOUBLE,
2G_L7_UL_GOODPUT_kb DOUBLE,
2G_DATATRANS_UL_s DOUBLE,
2G_L7_DW_GOODPUT_kb DOUBLE,
2G_DATATRANS_DW_s DOUBLE,
3G_traffic_MB DOUBLE,
3G_L7_UL_GOODPUT_kb DOUBLE,
3G_DATATRANS_UL_s DOUBLE,
3G_L7_DW_GOODPUT_kb DOUBLE,
3G_DATATRANS_DW_s DOUBLE,
4G_traffic_MB DOUBLE,
4G_L7_UL_GOODPUT_kb DOUBLE,
4G_DATATRANS_UL_s DOUBLE,
4G_L7_DW_GOODPUT_kb DOUBLE,
4G_DATATRANS_DW_s DOUBLE,
Total_traffic_MB DOUBLE,
Total_L7_UL_GOODPUT_kb DOUBLE,
Total_DATATRANS_UL_s DOUBLE,
Total_L7_DW_GOODPUT_kb DOUBLE,
Total_DATATRANS_DW_s DOUBLE,
Max_Cell_Traffic_MB DOUBLE,
Max_PSTraffic_ECGI STRING
);
insert into tmp_ZCS_234GMigration_PSTraffic_py_5_11Abr21
select a.IMSI,a.IMEI,
        2G_traffic_MB,2G_L7_UL_GOODPUT_kb,2G_DATATRANS_UL_s,2G_L7_DW_GOODPUT_kb,2G_DATATRANS_DW_s,
        3G_traffic_MB,3G_L7_UL_GOODPUT_kb,3G_DATATRANS_UL_s,3G_L7_DW_GOODPUT_kb,3G_DATATRANS_DW_s,
        4G_traffic_MB,4G_L7_UL_GOODPUT_kb,4G_DATATRANS_UL_s,4G_L7_DW_GOODPUT_kb,4G_DATATRANS_DW_s,
        Total_traffic_MB,Total_L7_UL_GOODPUT_kb,Total_DATATRANS_UL_s,Total_L7_DW_GOODPUT_kb,Total_DATATRANS_DW_s,
        Max_Traffic as Max_Cell_Traffic_MB,SAI_CGI_ECGI as Max_PSTraffic_ECGI
from
    (select IMSI,IMEI,
                sum(case when RAT = 2 then Traffic_MB end) as 2G_traffic_MB,
                sum(case when RAT=2 then L7_UL_GOODPUT_kb end) as 2G_L7_UL_GOODPUT_kb,
                sum(case when RAT=2 then DATATRANS_UL_s end) as 2G_DATATRANS_UL_s,
                sum(case when RAT=2 then L7_DW_GOODPUT_kb end) as 2G_L7_DW_GOODPUT_kb,
                sum(case when RAT=2 then DATATRANS_DW_s end) as 2G_DATATRANS_DW_s,
                sum(case when RAT in (1,5) then Traffic_MB  end) as 3G_traffic_MB,
                sum(case when RAT in (1,5) then L7_UL_GOODPUT_kb  end) as 3G_L7_UL_GOODPUT_kb,
                sum(case when RAT in (1,5) then DATATRANS_UL_s  end) as 3G_DATATRANS_UL_s,
                sum(case when RAT in (1,5) then L7_DW_GOODPUT_kb  end) as 3G_L7_DW_GOODPUT_kb,
                sum(case when RAT in (1,5) then DATATRANS_DW_s  end) as 3G_DATATRANS_DW_s,
                sum(case when RAT = 6 then Traffic_MB  end) as 4G_traffic_MB,
                sum(case when RAT = 6 then L7_UL_GOODPUT_kb  end) as 4G_L7_UL_GOODPUT_kb,
                sum(case when RAT = 6 then DATATRANS_UL_s  end) as 4G_DATATRANS_UL_s,
                sum(case when RAT = 6 then L7_DW_GOODPUT_kb  end) as 4G_L7_DW_GOODPUT_kb,
                sum(case when RAT = 6 then DATATRANS_DW_s  end) as 4G_DATATRANS_DW_s,
                sum(Traffic_MB ) as Total_traffic_MB,
                sum(L7_UL_GOODPUT_kb ) as Total_L7_UL_GOODPUT_kb,
                sum(DATATRANS_UL_s ) as Total_DATATRANS_UL_s,
                sum(L7_DW_GOODPUT_kb ) as Total_L7_DW_GOODPUT_kb,
                sum(DATATRANS_DW_s ) as Total_DATATRANS_DW_s,
                max(Traffic_MB) as Max_Traffic
        from tmp_ZCS_234GMigration_PSTraffic_Base_py_5_11Abr21 
        group by IMSI,IMEI
    )a
left join 
(
     select IMSI,IMEI,SAI_CGI_ECGI,Traffic_MB from
         (   select IMSI,IMEI,SAI_CGI_ECGI,Traffic_MB,row_number() over (partition by IMSI,IMEI order by coalesce(Traffic_MB,0) desc) as traffic_Order
                from tmp_ZCS_234GMigration_PSTraffic_Base_py_5_11Abr21
        )c
            where traffic_Order=1
)b    on a.Max_Traffic=b.Traffic_MB and a.IMSI=b.IMSI and a.IMEI=b.IMEI 
 ;
--</subquery_09>


--<subquery_10>
--------------------------------Create a CS traffic table.------------------------------------------------------------------
----select  * from tmp_ZCS_234GMigration_CSTraffic_@OutputName limit 100;
drop table if exists  tmp_ZCS_234GMigration_CSTraffic_py_5_11Abr21;
create table tmp_ZCS_234GMigration_CSTraffic_py_5_11Abr21
(
IMSI STRING,
IMEI STRING,
2G_Call_Duration_s DOUBLE,
3G_Call_Duration_s DOUBLE,
MO_Call_Duration_s DOUBLE,
MT_Call_Duration_s DOUBLE,
Total_Call_Duration_s DOUBLE
);

insert into tmp_ZCS_234GMigration_CSTraffic_py_5_11Abr21
select IMSI,IMEI,
                sum(case when RAT =0 then coalesce(MOC_Call_Duration_s,0)+coalesce(MTC_Call_Duration_s,0)  end) as 2G_Call_Duration_s,
                sum(case when RAT =1 then coalesce(MOC_Call_Duration_s,0)+coalesce(MTC_Call_Duration_s,0)  end) as 3G_Call_Duration_s,
                sum(MOC_Call_Duration_s) as MO_Call_Duration_s,
                sum(MTC_Call_Duration_s) as MT_Call_Duration_s,
                sum(coalesce(MOC_Call_Duration_s,0)+coalesce(MTC_Call_Duration_s,0))   as Total_Call_Duration_s
        from 
  (select 
        case when c.IMSI is not null then c.IMSI 
                else d.IMSI end as IMSI,
        case when c.IMEI is not null then c.IMEI
                else d.IMEI end as IMEI,
       case when c.RAT is not null then c.RAT
                else d.RAT end as RAT,
        MOC_Call_Duration_s,MTC_Call_Duration_s 
    from  (select IMSI,IMEI,ACCESS_TYPE as RAT,
                  1.0*(SUM(CASE WHEN RELCMP_TIME IS NOT NULL AND ANSWER_TIME IS NOT NULL THEN COALESCE(RELCMP_TIME,0) - COALESCE(ANSWER_TIME,0)
                            WHEN REL_TIME IS NOT NULL AND ANSWER_TIME IS NOT NULL THEN COALESCE(REL_TIME,0) - COALESCE(ANSWER_TIME,0)
                            WHEN DISCONN_TIME IS NOT NULL AND ANSWER_TIME IS NOT NULL  THEN COALESCE(DISCONN_TIME,0) - COALESCE(ANSWER_TIME,0)
                            WHEN RABREL_TIME IS NOT NULL AND ANSWER_TIME IS NOT NULL THEN COALESCE(RABREL_TIME,0) - COALESCE(ANSWER_TIME,0)
                            WHEN END_TIME IS NOT NULL AND ANSWER_TIME IS NOT NULL  THEN COALESCE(END_TIME,0) - COALESCE(ANSWER_TIME,0)
                            END)/1000) as MOC_Call_Duration_s        ----MO Call Duration
                   from
                   ( 
                    select IMSI,IMEI,ACCESS_TYPE,RELCMP_TIME,ANSWER_TIME,REL_TIME,DISCONN_TIME,RABREL_TIME,END_TIME 
                        from cs.CDR_AIU_MOC_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   
                    union all
                    select IMSI,IMEI,ACCESS_TYPE,RELCMP_TIME,ANSWER_TIME,REL_TIME,DISCONN_TIME,RABREL_TIME,END_TIME 
                        from cs.CDR_AIU_MOC_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   
                    union all
                    select IMSI,IMEI,ACCESS_TYPE,RELCMP_TIME,ANSWER_TIME,REL_TIME,DISCONN_TIME,RABREL_TIME,END_TIME 
                        from cs.CDR_AIU_MOC_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   
                    union all
                    select IMSI,IMEI,ACCESS_TYPE,RELCMP_TIME,ANSWER_TIME,REL_TIME,DISCONN_TIME,RABREL_TIME,END_TIME 
                        from cs.CDR_AIU_MOC_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   
                    union all
                    select IMSI,IMEI,ACCESS_TYPE,RELCMP_TIME,ANSWER_TIME,REL_TIME,DISCONN_TIME,RABREL_TIME,END_TIME 
                        from cs.CDR_AIU_MOC_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   
                    union all
                    select IMSI,IMEI,ACCESS_TYPE,RELCMP_TIME,ANSWER_TIME,REL_TIME,DISCONN_TIME,RABREL_TIME,END_TIME 
                        from cs.CDR_AIU_MOC_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   
                    union all
                    select IMSI,IMEI,ACCESS_TYPE,RELCMP_TIME,ANSWER_TIME,REL_TIME,DISCONN_TIME,RABREL_TIME,END_TIME 
                        from cs.CDR_AIU_MOC_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   
                    
                   ) a
                   group by IMSI,IMEI,RAT
                )c
    full join 
              (select IMSI,IMEI,ACCESS_TYPE as RAT,
                  1.0*(SUM(CASE WHEN RELCMP_TIME IS NOT NULL AND ANSWER_TIME IS NOT NULL THEN COALESCE(RELCMP_TIME,0) - COALESCE(ANSWER_TIME,0)
                            WHEN REL_TIME IS NOT NULL AND ANSWER_TIME IS NOT NULL THEN COALESCE(REL_TIME,0) - COALESCE(ANSWER_TIME,0)
                            WHEN DISCONN_TIME IS NOT NULL AND ANSWER_TIME IS NOT NULL  THEN COALESCE(DISCONN_TIME,0) - COALESCE(ANSWER_TIME,0)
                            WHEN RABREL_TIME IS NOT NULL AND ANSWER_TIME IS NOT NULL THEN COALESCE(RABREL_TIME,0) - COALESCE(ANSWER_TIME,0)
                            WHEN END_TIME IS NOT NULL AND ANSWER_TIME IS NOT NULL  THEN COALESCE(END_TIME,0) - COALESCE(ANSWER_TIME,0)
                            END)/1000) as MTC_Call_Duration_s        ----MT Call Duration
                from
                   (
             select IMSI,IMEI,ACCESS_TYPE,RELCMP_TIME,ANSWER_TIME,REL_TIME,DISCONN_TIME,RABREL_TIME,END_TIME 
                        from cs.CDR_AIU_MTC_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
                    union all
             select IMSI,IMEI,ACCESS_TYPE,RELCMP_TIME,ANSWER_TIME,REL_TIME,DISCONN_TIME,RABREL_TIME,END_TIME 
                        from cs.CDR_AIU_MTC_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
                    union all
             select IMSI,IMEI,ACCESS_TYPE,RELCMP_TIME,ANSWER_TIME,REL_TIME,DISCONN_TIME,RABREL_TIME,END_TIME 
                        from cs.CDR_AIU_MTC_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
                    union all
             select IMSI,IMEI,ACCESS_TYPE,RELCMP_TIME,ANSWER_TIME,REL_TIME,DISCONN_TIME,RABREL_TIME,END_TIME 
                        from cs.CDR_AIU_MTC_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
                    union all
             select IMSI,IMEI,ACCESS_TYPE,RELCMP_TIME,ANSWER_TIME,REL_TIME,DISCONN_TIME,RABREL_TIME,END_TIME 
                        from cs.CDR_AIU_MTC_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
                    union all
             select IMSI,IMEI,ACCESS_TYPE,RELCMP_TIME,ANSWER_TIME,REL_TIME,DISCONN_TIME,RABREL_TIME,END_TIME 
                        from cs.CDR_AIU_MTC_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
                    union all
             select IMSI,IMEI,ACCESS_TYPE,RELCMP_TIME,ANSWER_TIME,REL_TIME,DISCONN_TIME,RABREL_TIME,END_TIME 
                        from cs.CDR_AIU_MTC_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405') 
                    
                   ) a
                group by IMSI,IMEI,RAT
             )d  on c.IMSI=d.IMSI and c.IMEI=d.IMEI  and c.RAT=d.RAT
)f
        group by IMSI,IMEI
;
--</subquery_10>

--<subquery_11>
--------------------------------Create a PS signaling-plane basic table.------------------------------------------------------------------
----select  * from tmp_ZCS_234GMigration_PSsignaling_@OutputName limit 100;
drop table if exists  tmp_ZCS_234GMigration_PSsignaling_py_5_11Abr21;
create table tmp_ZCS_234GMigration_PSsignaling_py_5_11Abr21
(
IMSI STRING,
IMEI STRING,
2G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
2G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
3G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
3G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
4G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
4G_ATTACH_SUCC_RATE DOUBLE   ---Successful Attach Times
);
insert into tmp_ZCS_234GMigration_PSsignaling_py_5_11Abr21
select IMSI,IMEI,
      sum(case when RAT =2 then ATTACH_REQ_TIMES end) as 2G_ATTACH_REQ_TIMES,
      sum(case when RAT =2 and ATTACH_REQ_TIMES>0 then 1.0*ATTACH_SUCC_TIMES/ATTACH_REQ_TIMES  end) as 2G_ATTACH_SUCC_RATE,
      sum(case when RAT =1 then ATTACH_REQ_TIMES end) as 3G_ATTACH_REQ_TIMES,
      sum(case when RAT =1 and ATTACH_REQ_TIMES>0 then 1.0*ATTACH_SUCC_TIMES/ATTACH_REQ_TIMES  end) as 3G_ATTACH_SUCC_RATE,
      sum(case when RAT =6 then ATTACH_REQ_TIMES end) as 4G_ATTACH_REQ_TIMES,
      sum(case when RAT =6 and ATTACH_REQ_TIMES>0 then 1.0*ATTACH_SUCC_TIMES/ATTACH_REQ_TIMES  end) as 4G_ATTACH_SUCC_RATE
from
   (
    select IMSI,IMEI,RAT,
            count(MM_TRANS_SUCCED_FLAG is not NULL) as ATTACH_REQ_TIMES,
            count(MM_TRANS_SUCCED_FLAG = 0)  as ATTACH_SUCC_TIMES
        from
            ( 
         select IMSI,IMEI,RAT, MM_TRANS_SUCCED_FLAG
                from ps.DETAIL_CDR_GbIuPS_18722  where MM_TRAN_TYPE=23 and substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   
            union all 
              select IMSI,IMEI,RAT,EMM_REQ_SUCCED_FLAG as MM_TRANS_SUCCED_FLAG
                from ps.DETAIL_CDR_S1MME_18722 where  EMM_TRANS_TYPE=48 and substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
            union all
         select IMSI,IMEI,RAT, MM_TRANS_SUCCED_FLAG
                from ps.DETAIL_CDR_GbIuPS_18723  where MM_TRAN_TYPE=23 and substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   
            union all 
              select IMSI,IMEI,RAT,EMM_REQ_SUCCED_FLAG as MM_TRANS_SUCCED_FLAG
                from ps.DETAIL_CDR_S1MME_18723 where  EMM_TRANS_TYPE=48 and substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
            union all
         select IMSI,IMEI,RAT, MM_TRANS_SUCCED_FLAG
                from ps.DETAIL_CDR_GbIuPS_18724  where MM_TRAN_TYPE=23 and substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   
            union all 
              select IMSI,IMEI,RAT,EMM_REQ_SUCCED_FLAG as MM_TRANS_SUCCED_FLAG
                from ps.DETAIL_CDR_S1MME_18724 where  EMM_TRANS_TYPE=48 and substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
            union all
         select IMSI,IMEI,RAT, MM_TRANS_SUCCED_FLAG
                from ps.DETAIL_CDR_GbIuPS_18725  where MM_TRAN_TYPE=23 and substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   
            union all 
              select IMSI,IMEI,RAT,EMM_REQ_SUCCED_FLAG as MM_TRANS_SUCCED_FLAG
                from ps.DETAIL_CDR_S1MME_18725 where  EMM_TRANS_TYPE=48 and substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
            union all
         select IMSI,IMEI,RAT, MM_TRANS_SUCCED_FLAG
                from ps.DETAIL_CDR_GbIuPS_18726  where MM_TRAN_TYPE=23 and substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   
            union all 
              select IMSI,IMEI,RAT,EMM_REQ_SUCCED_FLAG as MM_TRANS_SUCCED_FLAG
                from ps.DETAIL_CDR_S1MME_18726 where  EMM_TRANS_TYPE=48 and substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
            union all
         select IMSI,IMEI,RAT, MM_TRANS_SUCCED_FLAG
                from ps.DETAIL_CDR_GbIuPS_18727  where MM_TRAN_TYPE=23 and substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   
            union all 
              select IMSI,IMEI,RAT,EMM_REQ_SUCCED_FLAG as MM_TRANS_SUCCED_FLAG
                from ps.DETAIL_CDR_S1MME_18727 where  EMM_TRANS_TYPE=48 and substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
            union all
         select IMSI,IMEI,RAT, MM_TRANS_SUCCED_FLAG
                from ps.DETAIL_CDR_GbIuPS_18728  where MM_TRAN_TYPE=23 and substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')   
            union all 
              select IMSI,IMEI,RAT,EMM_REQ_SUCCED_FLAG as MM_TRANS_SUCCED_FLAG
                from ps.DETAIL_CDR_S1MME_18728 where  EMM_TRANS_TYPE=48 and substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
            
            ) a
    group by IMSI,IMEI,RAT
    )c
  group by IMSI,IMEI
;
--</subquery_11>

--<subquery_12>
----------------------------------Create a subscriber-level initial basic table. (A large number of subscribers perform neither CS services nor PS services in a few days. To ensure that all subscriber data is collected, obtain detailed data on the signaling plane.)-----------------------
----select  * from tmp_ZCS_234GMigration_SigUser_@OutputName limit 100;
drop table if exists  tmp_ZCS_234GMigration_SigUser_py_5_11Abr21;
create table tmp_ZCS_234GMigration_SigUser_py_5_11Abr21
(
IMSI STRING,
IMEI STRING
);
insert into tmp_ZCS_234GMigration_SigUser_py_5_11Abr21
select IMSI,IMEI from
(

   select IMSI,IMEI from ps.DETAIL_CDR_S1MME_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from ps.DETAIL_CDR_GbIuPS_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.TDR_AIU_MM_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.CDR_AIU_MOC_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.CDR_AIU_MTC_18722 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')     
union all
   select IMSI,IMEI from ps.DETAIL_CDR_S1MME_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from ps.DETAIL_CDR_GbIuPS_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.TDR_AIU_MM_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.CDR_AIU_MOC_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.CDR_AIU_MTC_18723 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')     
union all
   select IMSI,IMEI from ps.DETAIL_CDR_S1MME_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from ps.DETAIL_CDR_GbIuPS_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.TDR_AIU_MM_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.CDR_AIU_MOC_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.CDR_AIU_MTC_18724 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')     
union all
   select IMSI,IMEI from ps.DETAIL_CDR_S1MME_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from ps.DETAIL_CDR_GbIuPS_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.TDR_AIU_MM_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.CDR_AIU_MOC_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.CDR_AIU_MTC_18725 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')     
union all
   select IMSI,IMEI from ps.DETAIL_CDR_S1MME_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from ps.DETAIL_CDR_GbIuPS_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.TDR_AIU_MM_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.CDR_AIU_MOC_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.CDR_AIU_MTC_18726 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')     
union all
   select IMSI,IMEI from ps.DETAIL_CDR_S1MME_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from ps.DETAIL_CDR_GbIuPS_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.TDR_AIU_MM_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.CDR_AIU_MOC_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.CDR_AIU_MTC_18727 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')     
union all
   select IMSI,IMEI from ps.DETAIL_CDR_S1MME_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from ps.DETAIL_CDR_GbIuPS_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.TDR_AIU_MM_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.CDR_AIU_MOC_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')  
union all
   select IMSI,IMEI from cs.CDR_AIU_MTC_18728 where substr(imsi,1,5) in ('74405') and concat(MCC,MNC) in ('74405')     

) a
    group by IMSI,IMEI
;
--</subquery_12>

--<subquery_13>
------------------------------------------------------------------------------------------------Create a subscriber-level information summary table.-------------------------------
----select  * from tmp_ZCS_234GMigration_Base00_@OutputName limit 10;
drop table if exists  tmp_ZCS_234GMigration_Base00_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Base00_py_5_11Abr21
(
IMSI STRING,
IMEI STRING,
Phone_Brand STRING,
Phone_Model STRING,
Phone_Mode  STRING,
Phone_Type STRING,
Phone_OS STRING,
TER_Support_Mode STRING,
Band_Support_Mode STRING,
2G_traffic_MB DOUBLE,
2G_L7_UL_GOODPUT_kb DOUBLE,
2G_DATATRANS_UL_s DOUBLE,
2G_L7_DW_GOODPUT_kb DOUBLE,
2G_DATATRANS_DW_s DOUBLE,
3G_traffic_MB DOUBLE,
3G_L7_UL_GOODPUT_kb DOUBLE,
3G_DATATRANS_UL_s DOUBLE,
3G_L7_DW_GOODPUT_kb DOUBLE,
3G_DATATRANS_DW_s DOUBLE,
4G_traffic_MB DOUBLE,
4G_L7_UL_GOODPUT_kb DOUBLE,
4G_DATATRANS_UL_s DOUBLE,
4G_L7_DW_GOODPUT_kb DOUBLE,
4G_DATATRANS_DW_s DOUBLE,
Total_traffic_MB DOUBLE,
Total_L7_UL_GOODPUT_kb DOUBLE,
Total_DATATRANS_UL_s DOUBLE,
Total_L7_DW_GOODPUT_kb DOUBLE,
Total_DATATRANS_DW_s DOUBLE,
Max_Cell_Traffic_MB DOUBLE,
Max_PSTraffic_ECGI STRING,
Max_PSTraffic_Cell_access_type STRING,
Max_PSTraffic_Cell_xpos BIGINT,
Max_PSTraffic_Cell_ypos BIGINT,
2G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
2G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
3G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
3G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
4G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
4G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
2G_Call_Duration_s DOUBLE,
3G_Call_Duration_s DOUBLE,
MO_Call_Duration_s DOUBLE,
MT_Call_Duration_s DOUBLE,
Total_Call_Duration_s DOUBLE
);

insert into tmp_ZCS_234GMigration_Base00_py_5_11Abr21
select userbase.IMSI,userbase.IMEI,Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Support_Mode ,Band_Support_Mode ,
        2G_traffic_MB,2G_L7_UL_GOODPUT_kb,2G_DATATRANS_UL_s,2G_L7_DW_GOODPUT_kb,2G_DATATRANS_DW_s,
        3G_traffic_MB,3G_L7_UL_GOODPUT_kb,3G_DATATRANS_UL_s,3G_L7_DW_GOODPUT_kb,3G_DATATRANS_DW_s,
        4G_traffic_MB,4G_L7_UL_GOODPUT_kb,4G_DATATRANS_UL_s,4G_L7_DW_GOODPUT_kb,4G_DATATRANS_DW_s,
        Total_traffic_MB,Total_L7_UL_GOODPUT_kb,Total_DATATRANS_UL_s,Total_L7_DW_GOODPUT_kb,Total_DATATRANS_DW_s,
        Max_Cell_Traffic_MB ,Max_PSTraffic_ECGI ,access_type as Max_PSTraffic_Cell_access_type,xpos as Max_PSTraffic_Cell_xpos,ypos as Max_PSTraffic_Cell_ypos,
        2G_ATTACH_REQ_TIMES ,2G_ATTACH_SUCC_RATE ,3G_ATTACH_REQ_TIMES ,3G_ATTACH_SUCC_RATE , 4G_ATTACH_REQ_TIMES ,4G_ATTACH_SUCC_RATE ,   
        2G_Call_Duration_s ,3G_Call_Duration_s ,MO_Call_Duration_s,MT_Call_Duration_s,Total_Call_Duration_s 
from 
(   select IMSI,IMEI from
    ( select IMSI,IMEI from tmp_ZCS_234GMigration_PSTraffic_py_5_11Abr21
        union all 
            select IMSI,IMEI from tmp_ZCS_234GMigration_CSTraffic_py_5_11Abr21
        union all 
            select IMSI,IMEI from tmp_ZCS_234GMigration_SigUser_py_5_11Abr21
    ) a
    group by IMSI,IMEI
) userbase
left join
    tmp_ZCS_234GMigration_TER_Base_py_5_11Abr21 TER on substr(userbase.IMEI,1,8)=TER.TAC
left join
    tmp_ZCS_234GMigration_PSTraffic_py_5_11Abr21 PSTraffic on userbase.IMSI=PSTraffic.IMSI and userbase.IMEI=PSTraffic.IMEI
left join
    tmp_ZCS_234GMigration_PSsignaling_py_5_11Abr21 PSsig on userbase.IMSI=PSsig.IMSI and userbase.IMEI=PSsig.IMEI
left join
    tmp_ZCS_234GMigration_CSTraffic_py_5_11Abr21 CSTraffic on userbase.IMSI=CSTraffic.IMSI and userbase.IMEI=CSTraffic.IMEI
left join 
    (     select CGISAI,access_type,xpos,ypos from
             (   select CGISAI,access_type,xpos,ypos,row_number() over (partition by CGISAI order by xpos desc) as cgi_Order
                    from nethouse.dim_loc_cgisai
            )c
                where cgi_Order=1
    )dim    on PSTraffic.Max_PSTraffic_ECGI = dim.CGISAI 
;
--</subquery_13>

--<subquery_14>
---------------------------------------Optimize the scenario where some IMEIs are not backfilled. (Analyze IMEI backfilling.) ------------------------------
----select  * from tmp_ZCS_234GMigration_IMEIStatus_@OutputName limit 10;
drop table if exists  tmp_ZCS_234GMigration_IMEIStatus_py_5_11Abr21;
create table tmp_ZCS_234GMigration_IMEIStatus_py_5_11Abr21
(
IMSI STRING,
IMEIcount BIGINT,
IMEI_FLAG STRING
);

insert into tmp_ZCS_234GMigration_IMEIStatus_py_5_11Abr21
select  IMSI,IMEIcount,
        'One_IMEI' as IMEI_FLAG
from 
    (select  IMSI,count(DISTINCT IMEI) as IMEIcount 
    from tmp_ZCS_234GMigration_Base00_py_5_11Abr21 group by IMSI 
    )a
    where IMEIcount=1
;
--</subquery_14>


--<subquery_15>
insert into tmp_ZCS_234GMigration_IMEIStatus_py_5_11Abr21
select  a.IMSI,b.IMEIcount2,
        'Have_Empty_IMEI' as IMEI_FLAG
 from 
       (select IMSI,count(DISTINCT IMEI) as IMEIcount
            from    tmp_ZCS_234GMigration_Base00_py_5_11Abr21 group by IMSI 
        )a
        left join 
       (select IMSI,count(DISTINCT IMEI) as IMEIcount2 
           from
            tmp_ZCS_234GMigration_Base00_py_5_11Abr21  where IMEI is not null and IMEI!=''
            group by IMSI 
        )b on a.imsi=b.imsi 
where a.IMEIcount>1 and a.IMEIcount>b.IMEIcount2
;
--</subquery_15>

--<subquery_16>
insert into tmp_ZCS_234GMigration_IMEIStatus_py_5_11Abr21
select  a.IMSI,a.IMEIcount,
        'Normal_Multi_IMEI' as IMEI_FLAG
 from 
       (select IMSI,count(DISTINCT IMEI) as IMEIcount
            from    tmp_ZCS_234GMigration_Base00_py_5_11Abr21 group by IMSI 
        )a
        left join 
       (select IMSI,count(DISTINCT IMEI) as IMEIcount2 
           from
            tmp_ZCS_234GMigration_Base00_py_5_11Abr21  where IMEI is not null and IMEI!=''
            group by IMSI 
        )b on a.imsi=b.imsi 
where a.IMEIcount>1 and a.IMEIcount=b.IMEIcount2
;
--</subquery_16>
    
--<subquery_17>
------------------------------------------------------------------------------------------------Create a subscriber-level information summary table.-------------------------------
----select  * from tmp_ZCS_234GMigration_Base0_@OutputName limit 10;
drop table if exists  tmp_ZCS_234GMigration_Base0_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Base0_py_5_11Abr21
(
IMSI STRING,
IMEI STRING,
Phone_Brand STRING,
Phone_Model STRING,
Phone_Mode  STRING,
Phone_Type STRING,
Phone_OS STRING,
TER_Support_Mode STRING,
Band_Support_Mode STRING,
2G_traffic_MB DOUBLE,
2G_L7_UL_GOODPUT_kb DOUBLE,
2G_DATATRANS_UL_s DOUBLE,
2G_L7_DW_GOODPUT_kb DOUBLE,
2G_DATATRANS_DW_s DOUBLE,
3G_traffic_MB DOUBLE,
3G_L7_UL_GOODPUT_kb DOUBLE,
3G_DATATRANS_UL_s DOUBLE,
3G_L7_DW_GOODPUT_kb DOUBLE,
3G_DATATRANS_DW_s DOUBLE,
4G_traffic_MB DOUBLE,
4G_L7_UL_GOODPUT_kb DOUBLE,
4G_DATATRANS_UL_s DOUBLE,
4G_L7_DW_GOODPUT_kb DOUBLE,
4G_DATATRANS_DW_s DOUBLE,
Total_traffic_MB DOUBLE,
Total_L7_UL_GOODPUT_kb DOUBLE,
Total_DATATRANS_UL_s DOUBLE,
Total_L7_DW_GOODPUT_kb DOUBLE,
Total_DATATRANS_DW_s DOUBLE,
Max_Cell_Traffic_MB DOUBLE,
Max_PSTraffic_ECGI STRING,
Max_PSTraffic_Cell_access_type STRING,
Max_PSTraffic_Cell_xpos BIGINT,
Max_PSTraffic_Cell_ypos BIGINT,
2G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
2G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
3G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
3G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
4G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
4G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
2G_Call_Duration_s DOUBLE,
3G_Call_Duration_s DOUBLE,
MO_Call_Duration_s DOUBLE,
MT_Call_Duration_s DOUBLE,
Total_Call_Duration_s DOUBLE
);

insert into tmp_ZCS_234GMigration_Base0_py_5_11Abr21
select  IMSI,IMEI,
        Phone_Brand,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Support_Mode ,Band_Support_Mode ,
        2G_traffic_MB,
        2G_L7_UL_GOODPUT_kb,
        2G_DATATRANS_UL_s,
        2G_L7_DW_GOODPUT_kb,
        2G_DATATRANS_DW_s,
        3G_traffic_MB,
        3G_L7_UL_GOODPUT_kb,
        3G_DATATRANS_UL_s,
        3G_L7_DW_GOODPUT_kb,
        3G_DATATRANS_DW_s,
        4G_traffic_MB,
        4G_L7_UL_GOODPUT_kb,
        4G_DATATRANS_UL_s,
        4G_L7_DW_GOODPUT_kb,
        4G_DATATRANS_DW_s,
        Total_traffic_MB,
        Total_L7_UL_GOODPUT_kb,
        Total_DATATRANS_UL_s,
        Total_L7_DW_GOODPUT_kb,
        Total_DATATRANS_DW_s,
        Max_Cell_Traffic_MB,
        Max_PSTraffic_ECGI ,Max_PSTraffic_Cell_access_type,Max_PSTraffic_Cell_xpos,Max_PSTraffic_Cell_ypos,
        2G_ATTACH_REQ_TIMES,
        2G_ATTACH_SUCC_RATE,
        3G_ATTACH_REQ_TIMES,
        3G_ATTACH_SUCC_RATE, 
        4G_ATTACH_REQ_TIMES,
        4G_ATTACH_SUCC_RATE,   
        2G_Call_Duration_s,
        3G_Call_Duration_s,
        MO_Call_Duration_s,
        MT_Call_Duration_s,
        Total_Call_Duration_s
from 
tmp_ZCS_234GMigration_Base00_py_5_11Abr21 
    where imsi in 
    (select imsi from  tmp_ZCS_234GMigration_IMEIStatus_py_5_11Abr21 where IMEI_FLAG='One_IMEI' or IMEI_FLAG='Normal_Multi_IMEI') 
;
--</subquery_17>

--<subquery_18>
insert into tmp_ZCS_234GMigration_Base0_py_5_11Abr21
select  d.IMSI,d.IMEI,
        d.Phone_Brand,d.Phone_Model ,d.Phone_Mode  ,d.Phone_Type ,d.Phone_OS ,d.TER_Support_Mode ,d.Band_Support_Mode ,
        coalesce(2G_traffic_MB,0)+coalesce(2G_traffic_MB_c,0) as 2G_traffic_MB,
        coalesce(2G_L7_UL_GOODPUT_kb,0)+coalesce(2G_L7_UL_GOODPUT_kb_c,0) as 2G_L7_UL_GOODPUT_kb,
        coalesce(2G_DATATRANS_UL_s,0)+coalesce(2G_DATATRANS_UL_s_c,0) as 2G_DATATRANS_UL_s,
        coalesce(2G_L7_DW_GOODPUT_kb,0)+coalesce(2G_L7_DW_GOODPUT_kb_c,0) as 2G_L7_DW_GOODPUT_kb,
        coalesce(2G_DATATRANS_DW_s,0)+coalesce(2G_DATATRANS_DW_s_c,0) as 2G_DATATRANS_DW_s,
        coalesce(3G_traffic_MB,0)+coalesce(3G_traffic_MB_c,0) as 3G_traffic_MB,
        coalesce(3G_L7_UL_GOODPUT_kb,0)+coalesce(3G_L7_UL_GOODPUT_kb_c,0) as 3G_L7_UL_GOODPUT_kb,
        coalesce(3G_DATATRANS_UL_s,0)+coalesce(3G_DATATRANS_UL_s_c,0) as 3G_DATATRANS_UL_s,
        coalesce(3G_L7_DW_GOODPUT_kb,0)+coalesce(3G_L7_DW_GOODPUT_kb_c,0) as 3G_L7_DW_GOODPUT_kb,
        coalesce(3G_DATATRANS_DW_s,0)+coalesce(3G_DATATRANS_DW_s_c,0) as 3G_DATATRANS_DW_s,
        coalesce(4G_traffic_MB,0)+coalesce(4G_traffic_MB_c,0) as 4G_traffic_MB,
        coalesce(4G_L7_UL_GOODPUT_kb,0)+coalesce(4G_L7_UL_GOODPUT_kb_c,0) as 4G_L7_UL_GOODPUT_kb,
        coalesce(4G_DATATRANS_UL_s,0)+coalesce(4G_DATATRANS_UL_s_c,0) as 4G_DATATRANS_UL_s,
        coalesce(4G_L7_DW_GOODPUT_kb,0)+coalesce(4G_L7_DW_GOODPUT_kb_c,0) as 4G_L7_DW_GOODPUT_kb,
        coalesce(4G_DATATRANS_DW_s,0)+coalesce(4G_DATATRANS_DW_s_c,0) as 4G_DATATRANS_DW_s,
        coalesce(Total_traffic_MB,0)+coalesce(Total_traffic_MB_c,0) as Total_traffic_MB,
        coalesce(Total_L7_UL_GOODPUT_kb,0)+coalesce(Total_L7_UL_GOODPUT_kb_c,0) as Total_L7_UL_GOODPUT_kb,
        coalesce(Total_DATATRANS_UL_s,0)+coalesce(Total_DATATRANS_UL_s_c,0) as Total_DATATRANS_UL_s,
        coalesce(Total_L7_DW_GOODPUT_kb,0)+coalesce(Total_L7_DW_GOODPUT_kb_c,0) as Total_L7_DW_GOODPUT_kb,
        coalesce(Total_DATATRANS_DW_s,0)+coalesce(Total_DATATRANS_DW_s_c,0) as Total_DATATRANS_DW_s,
        coalesce( Max_Cell_Traffic_MB,0)+coalesce(Max_Cell_Traffic_MB_c,0) as Max_Cell_Traffic_MB,
        Max_PSTraffic_ECGI ,Max_PSTraffic_Cell_access_type,Max_PSTraffic_Cell_xpos,Max_PSTraffic_Cell_ypos,
        cast(coalesce(2G_ATTACH_REQ_TIMES,0)+coalesce(2G_ATTACH_REQ_TIMES_c,0) as bigint) as 2G_ATTACH_REQ_TIMES,
        coalesce(2G_ATTACH_SUCC_RATE,0)+coalesce(2G_ATTACH_SUCC_RATE_c,0) as 2G_ATTACH_SUCC_RATE,
        cast(coalesce(3G_ATTACH_REQ_TIMES,0)+coalesce(3G_ATTACH_REQ_TIMES_c,0) as bigint) as 3G_ATTACH_REQ_TIMES,
        coalesce(3G_ATTACH_SUCC_RATE,0)+coalesce(3G_ATTACH_SUCC_RATE_c,0) as 3G_ATTACH_SUCC_RATE, 
        cast(coalesce(4G_ATTACH_REQ_TIMES,0)+coalesce(4G_ATTACH_REQ_TIMES_c,0) as bigint) as 4G_ATTACH_REQ_TIMES,
        coalesce(4G_ATTACH_SUCC_RATE,0)+coalesce(4G_ATTACH_SUCC_RATE_c,0) as 4G_ATTACH_SUCC_RATE,   
        coalesce(2G_Call_Duration_s,0)+coalesce(2G_Call_Duration_s_c,0) as 2G_Call_Duration_s,
        coalesce(3G_Call_Duration_s,0)+coalesce(3G_Call_Duration_s_c,0) as 3G_Call_Duration_s,
        coalesce(MO_Call_Duration_s,0)+coalesce(MO_Call_Duration_s_c,0) as MO_Call_Duration_s,
        coalesce(MT_Call_Duration_s,0)+coalesce(MT_Call_Duration_s_c,0) as MT_Call_Duration_s,
        coalesce(Total_Call_Duration_s,0)+coalesce(Total_Call_Duration_s_c,0) as Total_Call_Duration_s
from
(
select * from
tmp_ZCS_234GMigration_Base00_py_5_11Abr21 where imei is not null and imei !='' and imsi in 
          (select imsi from tmp_ZCS_234GMigration_IMEIStatus_py_5_11Abr21 where IMEI_FLAG='Have_Empty_IMEI')
)d
left join 
(    select a.IMSI,
            2G_traffic_MB/IMEIcount as 2G_traffic_MB_c,
            2G_L7_UL_GOODPUT_kb/IMEIcount as 2G_L7_UL_GOODPUT_kb_c,
            2G_DATATRANS_UL_s/IMEIcount as 2G_DATATRANS_UL_s_c,
            2G_L7_DW_GOODPUT_kb/IMEIcount as 2G_L7_DW_GOODPUT_kb_c,
            2G_DATATRANS_DW_s/IMEIcount as 2G_DATATRANS_DW_s_c,
            3G_traffic_MB/IMEIcount as 3G_traffic_MB_c,
            3G_L7_UL_GOODPUT_kb/IMEIcount as 3G_L7_UL_GOODPUT_kb_c,
            3G_DATATRANS_UL_s/IMEIcount as 3G_DATATRANS_UL_s_c,
            3G_L7_DW_GOODPUT_kb/IMEIcount as 3G_L7_DW_GOODPUT_kb_c,
            3G_DATATRANS_DW_s/IMEIcount as 3G_DATATRANS_DW_s_c,
            4G_traffic_MB/IMEIcount as 4G_traffic_MB_c,
            4G_L7_UL_GOODPUT_kb/IMEIcount as 4G_L7_UL_GOODPUT_kb_c,
            4G_DATATRANS_UL_s/IMEIcount as 4G_DATATRANS_UL_s_c,
            4G_L7_DW_GOODPUT_kb/IMEIcount as 4G_L7_DW_GOODPUT_kb_c,
            4G_DATATRANS_DW_s/IMEIcount as 4G_DATATRANS_DW_s_c,
            Total_traffic_MB/IMEIcount as Total_traffic_MB_c,
            Total_L7_UL_GOODPUT_kb/IMEIcount as Total_L7_UL_GOODPUT_kb_c,
            Total_DATATRANS_UL_s/IMEIcount as Total_DATATRANS_UL_s_c,
            Total_L7_DW_GOODPUT_kb/IMEIcount as Total_L7_DW_GOODPUT_kb_c,
            Total_DATATRANS_DW_s/IMEIcount as Total_DATATRANS_DW_s_c,
            Max_Cell_Traffic_MB /IMEIcount as Max_Cell_Traffic_MB_c,
            2G_ATTACH_REQ_TIMES /IMEIcount as 2G_ATTACH_REQ_TIMES_c,
            2G_ATTACH_SUCC_RATE /IMEIcount as 2G_ATTACH_SUCC_RATE_c,
            3G_ATTACH_REQ_TIMES /IMEIcount as 3G_ATTACH_REQ_TIMES_c,
            3G_ATTACH_SUCC_RATE /IMEIcount as 3G_ATTACH_SUCC_RATE_c, 
            4G_ATTACH_REQ_TIMES /IMEIcount as 4G_ATTACH_REQ_TIMES_c,
            4G_ATTACH_SUCC_RATE /IMEIcount as 4G_ATTACH_SUCC_RATE_c,   
            2G_Call_Duration_s /IMEIcount as 2G_Call_Duration_s_c,
            3G_Call_Duration_s /IMEIcount as 3G_Call_Duration_s_c,
            MO_Call_Duration_s/IMEIcount as MO_Call_Duration_s_c,
            MT_Call_Duration_s/IMEIcount as MT_Call_Duration_s_c,
            Total_Call_Duration_s /IMEIcount as Total_Call_Duration_s_c
    from 
        (
        select * from tmp_ZCS_234GMigration_Base00_py_5_11Abr21 
          where (imei is null or imei ='') and imsi in 
          (select imsi from tmp_ZCS_234GMigration_IMEIStatus_py_5_11Abr21 where IMEI_FLAG='Have_Empty_IMEI') 
        )a
    left join 
        (select imsi,IMEIcount from tmp_ZCS_234GMigration_IMEIStatus_py_5_11Abr21 where IMEI_FLAG='Have_Empty_IMEI' 
        )b   on a.imsi=b.imsi
)c on c.imsi=d.imsi
;
--</subquery_18>
    
--<subquery_19>
------------------------------------------------------------------------------------------------Create a subscriber-level extended information summary table that contains the number of subscribers used for ranking.-------------------------------
----select  * from tmp_ZCS_234GMigration_Base1_@OutputName limit 10;
drop table if exists  tmp_ZCS_234GMigration_Base1_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Base1_py_5_11Abr21
(
IMSI STRING,
IMEI STRING,
Phone_Brand STRING,
Phone_Model STRING,
Phone_Mode  STRING,
Phone_Type STRING,
Phone_OS STRING,
TER_Support_Mode STRING,
Band_Support_Mode STRING,
2G_traffic_MB DOUBLE,
2G_L7_UL_GOODPUT_kb DOUBLE,
2G_DATATRANS_UL_s DOUBLE,
2G_L7_DW_GOODPUT_kb DOUBLE,
2G_DATATRANS_DW_s DOUBLE,
2G_traffic_Users BIGINT,
3G_traffic_MB DOUBLE,
3G_L7_UL_GOODPUT_kb DOUBLE,
3G_DATATRANS_UL_s DOUBLE,
3G_L7_DW_GOODPUT_kb DOUBLE,
3G_DATATRANS_DW_s DOUBLE,
3G_traffic_Users BIGINT,
23G_traffic_Users BIGINT,
4G_traffic_MB DOUBLE,
4G_L7_UL_GOODPUT_kb DOUBLE,
4G_DATATRANS_UL_s DOUBLE,
4G_L7_DW_GOODPUT_kb DOUBLE,
4G_DATATRANS_DW_s DOUBLE,
4G_traffic_Users BIGINT,
Total_traffic_MB DOUBLE,
Total_L7_UL_GOODPUT_kb DOUBLE,
Total_DATATRANS_UL_s DOUBLE,
Total_L7_DW_GOODPUT_kb DOUBLE,
Total_DATATRANS_DW_s DOUBLE,
Total_traffic_Users BIGINT,
Max_Cell_Traffic_MB DOUBLE,
Max_PSTraffic_ECGI STRING,
Max_PSTraffic_Cell_access_type STRING,
Max_PSTraffic_Cell_xpos BIGINT,
Max_PSTraffic_Cell_ypos BIGINT,
2G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
2G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
3G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
3G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
4G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
4G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
2G_Call_Duration_s DOUBLE,
2G_Call_Users BIGINT,
3G_Call_Duration_s DOUBLE,
3G_Call_Users BIGINT,
MO_Call_Duration_s DOUBLE,
MT_Call_Duration_s DOUBLE,
Total_Call_Duration_s DOUBLE,
Total_Call_Users BIGINT
);

insert into tmp_ZCS_234GMigration_Base1_py_5_11Abr21
select a.IMSI,a.IMEI,Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Support_Mode ,Band_Support_Mode ,
        2G_traffic_MB,2G_L7_UL_GOODPUT_kb,2G_DATATRANS_UL_s,2G_L7_DW_GOODPUT_kb,2G_DATATRANS_DW_s,2G_traffic_Users, 
        3G_traffic_MB,3G_L7_UL_GOODPUT_kb,3G_DATATRANS_UL_s,3G_L7_DW_GOODPUT_kb,3G_DATATRANS_DW_s,3G_traffic_Users,
        23G_traffic_Users,
        4G_traffic_MB,4G_L7_UL_GOODPUT_kb,4G_DATATRANS_UL_s,4G_L7_DW_GOODPUT_kb,4G_DATATRANS_DW_s,4G_traffic_Users,
        Total_traffic_MB,Total_L7_UL_GOODPUT_kb,Total_DATATRANS_UL_s,Total_L7_DW_GOODPUT_kb,Total_DATATRANS_DW_s,Total_traffic_Users,
        Max_Cell_Traffic_MB ,Max_PSTraffic_ECGI ,Max_PSTraffic_Cell_access_type,Max_PSTraffic_Cell_xpos,Max_PSTraffic_Cell_ypos,
        2G_ATTACH_REQ_TIMES ,2G_ATTACH_SUCC_RATE ,3G_ATTACH_REQ_TIMES ,3G_ATTACH_SUCC_RATE , 4G_ATTACH_REQ_TIMES ,4G_ATTACH_SUCC_RATE ,   
        2G_Call_Duration_s ,2G_Call_Users,3G_Call_Duration_s ,3G_Call_Users,MO_Call_Duration_s,MT_Call_Duration_s,Total_Call_Duration_s ,Total_Call_Users
from
   (select s.*  from tmp_ZCS_234GMigration_Base0_py_5_11Abr21 s) a
cross join 
    (select count(distinct IMSI) as 2G_traffic_Users  from tmp_ZCS_234GMigration_Base0_py_5_11Abr21 where 2G_traffic_MB>0) b 
cross join 
    (select count(distinct IMSI) as 3G_traffic_Users  from tmp_ZCS_234GMigration_Base0_py_5_11Abr21 where 3G_traffic_MB>0) c 
cross join 
    (select count(distinct IMSI) as 23G_traffic_Users  from tmp_ZCS_234GMigration_Base0_py_5_11Abr21 where coalesce(2G_traffic_MB,0)+coalesce(3G_traffic_MB,0)>0)  j 
cross join 
    (select count(distinct IMSI) as 4G_traffic_Users  from tmp_ZCS_234GMigration_Base0_py_5_11Abr21 where 4G_traffic_MB>0) d 
cross join 
    (select count(distinct IMSI) as Total_traffic_Users  from tmp_ZCS_234GMigration_Base0_py_5_11Abr21 where Total_traffic_MB>0) e  
cross join 
    (select count(distinct IMSI) as 2G_Call_Users  from tmp_ZCS_234GMigration_Base0_py_5_11Abr21 where 2G_Call_Duration_s>0) f 
cross join 
    (select count(distinct IMSI) as 3G_Call_Users  from tmp_ZCS_234GMigration_Base0_py_5_11Abr21 where 3G_Call_Duration_s>0) g 
cross join 
    (select count(distinct IMSI) as Total_Call_Users  from tmp_ZCS_234GMigration_Base0_py_5_11Abr21 where Total_Call_Duration_s>0) h  
;
--</subquery_19>

--<subquery_20>
--------------------------------Create a subscriber-level information table that contains CS traffic, PS traffic and traffic categories.------------------------------------------------------------------
----select  * from tmp_ZCS_234GMigration_Base2_@OutputName limit 10;
drop table if exists  tmp_ZCS_234GMigration_Base2_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Base2_py_5_11Abr21
(
IMSI STRING,
IMEI STRING,
Phone_Brand STRING,
Phone_Model STRING,
Phone_Mode  STRING,
Phone_Type STRING,
Phone_OS STRING,
TER_Support_Mode STRING,
Band_Support_Mode STRING,
2G_traffic_MB DOUBLE,
2G_L7_UL_GOODPUT_kb DOUBLE,
2G_DATATRANS_UL_s DOUBLE,
2G_L7_DW_GOODPUT_kb DOUBLE,
2G_DATATRANS_DW_s DOUBLE,
2G_Traffic_Flag STRING,
3G_traffic_MB DOUBLE,
3G_L7_UL_GOODPUT_kb DOUBLE,
3G_DATATRANS_UL_s DOUBLE,
3G_L7_DW_GOODPUT_kb DOUBLE,
3G_DATATRANS_DW_s DOUBLE,
3G_Traffic_Flag STRING,
23G_Traffic_Flag STRING,
4G_traffic_MB DOUBLE,
4G_L7_UL_GOODPUT_kb DOUBLE,
4G_DATATRANS_UL_s DOUBLE,
4G_L7_DW_GOODPUT_kb DOUBLE,
4G_DATATRANS_DW_s DOUBLE,
4G_Traffic_Flag STRING,
Total_traffic_MB DOUBLE,
Total_L7_UL_GOODPUT_kb DOUBLE,
Total_DATATRANS_UL_s DOUBLE,
Total_L7_DW_GOODPUT_kb DOUBLE,
Total_DATATRANS_DW_s DOUBLE,
Total_Traffic_Flag STRING,
Max_Cell_Traffic_MB DOUBLE,
Max_PSTraffic_ECGI STRING,
Max_PSTraffic_Cell_access_type STRING,
Max_PSTraffic_Cell_xpos BIGINT,
Max_PSTraffic_Cell_ypos BIGINT,
2G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
2G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
3G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
3G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
4G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
4G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
2G_Call_Duration_s DOUBLE,
2G_Call_Flag STRING,
3G_Call_Duration_s DOUBLE,
3G_Call_Flag STRING,
MO_Call_Duration_s DOUBLE,
MT_Call_Duration_s DOUBLE,
Total_Call_Duration_s DOUBLE,
Total_Call_Flag STRING
);

insert into tmp_ZCS_234GMigration_Base2_py_5_11Abr21
select a.IMSI,a.IMEI,Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Support_Mode ,Band_Support_Mode ,
        2G_traffic_MB,2G_L7_UL_GOODPUT_kb,2G_DATATRANS_UL_s,2G_L7_DW_GOODPUT_kb,2G_DATATRANS_DW_s,
        case when 2G_traffic_Order<0.2*2G_traffic_Users then '2G_High_Traffic_User'
                                        ---
---It can also be an absolute traffic threshold. The format is 2G_traffic_MB>Absolute value 1 (daily traffic) x Analysis days. You can replace the one in the statement with it. It also applies to the following statements. 
---                            when 2G_traffic_Order>(1-0.2)*2G_traffic_Users then '2G_Low_Traffic_User'
---                                        ---It can also be an absolute traffic threshold. The format is 2G_traffic_MB<Absolute value 2 (daily traffic) x Analysis days and coalesce(2G_traffic_MB,0)>0. You can replace the one in the statement with it. It also applies to the following statements. 
---                            when 2G_traffic_Order<=(1-0.2)*2G_traffic_Users
---                             and 2G_traffic_Order>=0.2*2G_traffic_Users then '2G_Mid_Traffic_User' 
---								---                                        ---It can also be an absolute traffic threshold. The format is 2G_traffic_MB<=Absolute value 1 (daily traffic) x Analysis days and 2G_traffic_MB>=Absolute value 2 (daily traffic) x Analysis days. You can replace the one in the statement with it. Note that absolute values 1 and 2 must be the consistent with those mentioned above. It also applies to the following statements. 
                            else 'NO_2G_Traffic_User' end as 2G_Traffic_Flag,
        3G_traffic_MB,3G_L7_UL_GOODPUT_kb,3G_DATATRANS_UL_s,3G_L7_DW_GOODPUT_kb,3G_DATATRANS_DW_s,
        case when 3G_traffic_Order<0.2*3G_traffic_Users then '3G_High_Traffic_User'
                            when 3G_traffic_Order>(1-0.2)*3G_traffic_Users then '3G_Low_Traffic_User'
                            when 3G_traffic_Order<=(1-0.2)*3G_traffic_Users
                             and 3G_traffic_Order>=0.2*3G_traffic_Users then '3G_Mid_Traffic_User' 
                            else 'NO_3G_Traffic_User' end as 3G_Traffic_Flag,
        case when 23G_traffic_Order<0.2*23G_traffic_Users then '23G_High_Traffic_User'
                            when 23G_traffic_Order>(1-0.2)*23G_traffic_Users then '23G_Low_Traffic_User'
                            when 23G_traffic_Order<=(1-0.2)*23G_traffic_Users
                             and 23G_traffic_Order>=0.2*23G_traffic_Users then '23G_Mid_Traffic_User' 
                            else 'NO_23G_Traffic_User' end as 23G_Traffic_Flag,
        4G_traffic_MB,4G_L7_UL_GOODPUT_kb,4G_DATATRANS_UL_s,4G_L7_DW_GOODPUT_kb,4G_DATATRANS_DW_s,
        case when 4G_traffic_Order<0.2*4G_traffic_Users then '4G_High_Traffic_User'
                            when 4G_traffic_Order>(1-0.2)*4G_traffic_Users then '4G_Low_Traffic_User'
                            when 4G_traffic_Order<=(1-0.2)*4G_traffic_Users
                             and 4G_traffic_Order>=0.2*4G_traffic_Users then '4G_Mid_Traffic_User' 
                            else 'NO_4G_Traffic_User' end as 4G_Traffic_Flag,
        Total_traffic_MB,Total_L7_UL_GOODPUT_kb,Total_DATATRANS_UL_s,Total_L7_DW_GOODPUT_kb,Total_DATATRANS_DW_s,
        case when Total_traffic_Order<0.2*Total_traffic_Users then 'Total_High_Traffic_User'
                            when Total_traffic_Order>(1-0.2)*Total_traffic_Users then 'Total_Low_Traffic_User'
                            when Total_traffic_Order<=(1-0.2)*Total_traffic_Users
                             and Total_traffic_Order>=0.2*Total_traffic_Users then 'Total_Mid_Traffic_User' 
                            else 'NO_Total_Traffic_User' end as Total_Traffic_Flag,
        Max_Cell_Traffic_MB ,Max_PSTraffic_ECGI ,Max_PSTraffic_Cell_access_type,Max_PSTraffic_Cell_xpos,Max_PSTraffic_Cell_ypos,
        2G_ATTACH_REQ_TIMES ,2G_ATTACH_SUCC_RATE ,3G_ATTACH_REQ_TIMES ,3G_ATTACH_SUCC_RATE , 4G_ATTACH_REQ_TIMES ,4G_ATTACH_SUCC_RATE ,   
        2G_Call_Duration_s,case when 2G_Call_Order<0.2*2G_Call_Users then '2G_High_Call_User'
                            when 2G_Call_Order>(1-0.2)*2G_Call_Users then '2G_Low_Call_User'
                            when 2G_Call_Order<=(1-0.2)*2G_Call_Users
                             and 2G_Call_Order>=0.2*2G_Call_Users then '2G_Mid_Call_User' 
                            else 'NO_2G_Call_User' end as 2G_Call_Flag,
        3G_Call_Duration_s,case when 3G_Call_Order<0.2*3G_Call_Users then '3G_High_Call_User'
                            when 3G_Call_Order>(1-0.2)*3G_Call_Users then '3G_Low_Call_User'
                            when 3G_Call_Order<=(1-0.2)*3G_Call_Users
                             and 3G_Call_Order>=0.2*3G_Call_Users then '3G_Mid_Call_User' 
                            else 'NO_3G_Call_User' end as 3G_Call_Flag,
        MO_Call_Duration_s,MT_Call_Duration_s,
        Total_Call_Duration_s,case when Total_Call_Order<0.2*Total_Call_Users then 'Total_High_Call_User'
                            when Total_Call_Order>(1-0.2)*Total_Call_Users then 'Total_Low_Call_User'
                            when Total_Call_Order<=(1-0.2)*Total_Call_Users
                             and Total_Call_Order>=0.2*Total_Call_Users then 'Total_Mid_Call_User' 
                            else 'NO_Total_Call_User' end as Total_Call_Flag
   from 
  tmp_ZCS_234GMigration_Base1_py_5_11Abr21 a
 left join 
    (select IMSI,IMEI,row_number() over (order by coalesce(2G_traffic_MB,0) desc) as 2G_traffic_Order  from tmp_ZCS_234GMigration_Base1_py_5_11Abr21 where 2G_traffic_MB>0) b
        on a.IMSI=b.IMSI and a.IMEI=b.IMEI
  left join 
    (select IMSI,IMEI,row_number() over (order by coalesce(3G_traffic_MB,0) desc) as 3G_traffic_Order  from tmp_ZCS_234GMigration_Base1_py_5_11Abr21 where 3G_traffic_MB>0) c
        on a.IMSI=c.IMSI and a.IMEI=c.IMEI
   left join 
    (select IMSI,IMEI,row_number() over (order by coalesce(2G_traffic_MB,0)+coalesce(3G_traffic_MB,0) desc) as 23G_traffic_Order  from tmp_ZCS_234GMigration_Base1_py_5_11Abr21 where coalesce(2G_traffic_MB,0)+coalesce(3G_traffic_MB,0)>0) j
        on a.IMSI=j.IMSI and a.IMEI=j.IMEI
left join 
    (select IMSI,IMEI,row_number() over (order by coalesce(4G_traffic_MB,0) desc) as 4G_traffic_Order  from tmp_ZCS_234GMigration_Base1_py_5_11Abr21 where 4G_traffic_MB>0) d
        on a.IMSI=d.IMSI and a.IMEI=d.IMEI
 left join 
    (select IMSI,IMEI,row_number() over (order by coalesce(Total_traffic_MB,0) desc) as Total_traffic_Order  from tmp_ZCS_234GMigration_Base1_py_5_11Abr21 where Total_traffic_MB>0) e
        on a.IMSI=e.IMSI and a.IMEI=e.IMEI
 left join 
    (select IMSI,IMEI,row_number() over (order by coalesce(2G_Call_Duration_s,0) desc) as 2G_Call_Order  from tmp_ZCS_234GMigration_Base1_py_5_11Abr21 where 2G_Call_Duration_s>0) f
        on a.IMSI=f.IMSI and a.IMEI=f.IMEI
  left join 
    (select IMSI,IMEI,row_number() over (order by coalesce(3G_Call_Duration_s,0) desc) as 3G_Call_Order  from tmp_ZCS_234GMigration_Base1_py_5_11Abr21 where 3G_Call_Duration_s>0) g
        on a.IMSI=g.IMSI and a.IMEI=g.IMEI
  left join 
    (select IMSI,IMEI,row_number() over (order by coalesce(Total_Call_Duration_s,0) desc) as Total_Call_Order  from tmp_ZCS_234GMigration_Base1_py_5_11Abr21 where Total_Call_Duration_s>0) h
        on a.IMSI=h.IMSI and a.IMEI=h.IMEI
;
--</subquery_20>

--<subquery_21>
---------------------------------------------------------------------Obtain the name of the 4G cell within 300 m away from the source cell. --------------------------------------------------------------
----select  * from tmp_ZCS_234GMigration_AroundCell_@OutputName ;
drop table if exists  tmp_ZCS_234GMigration_AroundCell_py_5_11Abr21;
create table tmp_ZCS_234GMigration_AroundCell_py_5_11Abr21
(
Max_PSTraffic_ECGI STRING,
Around_4G_ECGI STRING,
Around_4G_Cell_Name STRING,
distance DOUBLE)
;
insert into tmp_ZCS_234GMigration_AroundCell_py_5_11Abr21
select  Max_PSTraffic_ECGI,Around_4G_ECGI,Around_4G_Cell_Name,distance from
(
    select Max_PSTraffic_ECGI,b.CGISAI as Around_4G_ECGI,b.cell_name as Around_4G_Cell_Name,
               6378137*ACOS(SIN(a.Max_PSTraffic_Cell_ypos/1000000/180*PI())*SIN(b.ypos/1000000/180*PI())+COS(a.Max_PSTraffic_Cell_ypos/1000000/180*PI())*COS(b.ypos/1000000/180*PI())*COS((b.xpos/1000000-a.Max_PSTraffic_Cell_xpos/1000000)/180*PI())) as distance
    from
            (select Max_PSTraffic_ECGI,Max_PSTraffic_Cell_xpos,Max_PSTraffic_Cell_ypos
                from tmp_ZCS_234GMigration_Base2_py_5_11Abr21  where Max_PSTraffic_ECGI is not null 
                group by Max_PSTraffic_ECGI,Max_PSTraffic_Cell_xpos,Max_PSTraffic_Cell_ypos
            )a
        cross join 
            (select CGISAI,cell_name,xpos,ypos from nethouse.dim_loc_cgisai where access_type='4G'
            ) b  
)  c  where distance<=300
;
--</subquery_21>

--<subquery_22>
---------------------------------------------------------------------Obtain the name of the nearest 4G cell. --------------------------------------------------------------
----select  * from tmp_ZCS_234GMigration_Nearest_Cell_@OutputName ;
drop table if exists  tmp_ZCS_234GMigration_Nearest_Cell_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Nearest_Cell_py_5_11Abr21
(
Max_PSTraffic_ECGI STRING,
Around_4G_ECGI STRING,
Around_4G_Cell_Name STRING,
distance DOUBLE
);

insert into tmp_ZCS_234GMigration_Nearest_Cell_py_5_11Abr21
select Max_PSTraffic_ECGI,Around_4G_ECGI,Around_4G_Cell_Name,distance from 
    (select Max_PSTraffic_ECGI,Around_4G_ECGI,Around_4G_Cell_Name,distance,row_number() over (partition by Max_PSTraffic_ECGI order by distance) as Distance_Order  
        from tmp_ZCS_234GMigration_AroundCell_py_5_11Abr21 
     ) c
 where Distance_Order=1
;
--</subquery_22>

--<subquery_23>
-------------------------------------------------------Create a subscriber-level information table. (Add data about whether there is 4G coverage around the cell with heaviest traffic.) -------------------------------------------------
----select  * from tmp_ZCS_234GMigration_Base3_@OutputName limit 10;
drop table if exists  tmp_ZCS_234GMigration_Base3_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Base3_py_5_11Abr21
(
IMSI STRING,
IMEI STRING,
Phone_Brand STRING,
Phone_Model STRING,
Phone_Mode  STRING,
Phone_Type STRING,
Phone_OS STRING,
TER_Support_Mode STRING,
Band_Support_Mode STRING,
2G_traffic_MB DOUBLE,
2G_L7_UL_GOODPUT_kb DOUBLE,
2G_DATATRANS_UL_s DOUBLE,
2G_L7_DW_GOODPUT_kb DOUBLE,
2G_DATATRANS_DW_s DOUBLE,
2G_Traffic_Flag STRING,
3G_traffic_MB DOUBLE,
3G_L7_UL_GOODPUT_kb DOUBLE,
3G_DATATRANS_UL_s DOUBLE,
3G_L7_DW_GOODPUT_kb DOUBLE,
3G_DATATRANS_DW_s DOUBLE,
3G_Traffic_Flag STRING,
23G_Traffic_Flag STRING,
4G_traffic_MB DOUBLE,
4G_L7_UL_GOODPUT_kb DOUBLE,
4G_DATATRANS_UL_s DOUBLE,
4G_L7_DW_GOODPUT_kb DOUBLE,
4G_DATATRANS_DW_s DOUBLE,
4G_Traffic_Flag STRING,
Total_traffic_MB DOUBLE,
Total_L7_UL_GOODPUT_kb DOUBLE,
Total_DATATRANS_UL_s DOUBLE,
Total_L7_DW_GOODPUT_kb DOUBLE,
Total_DATATRANS_DW_s DOUBLE,
Total_Traffic_Flag STRING,
Max_Cell_Traffic_MB DOUBLE,
Max_PSTraffic_ECGI STRING,
Max_PSTraffic_Cell_access_type STRING,
Max_PSTraffic_Cell_xpos BIGINT,
Max_PSTraffic_Cell_ypos BIGINT,
Nearest_4G_ECGI STRING,
Nearest_4G_Cell_Name STRING,
Nearest_4G_Cell_distance DOUBLE,
2G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
2G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
3G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
3G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
4G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
4G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
2G_Call_Duration_s DOUBLE,
2G_Call_Flag STRING,
3G_Call_Duration_s DOUBLE,
3G_Call_Flag STRING,
MO_Call_Duration_s DOUBLE,
MT_Call_Duration_s DOUBLE,
Total_Call_Duration_s DOUBLE,
Total_Call_Flag STRING
);

insert into tmp_ZCS_234GMigration_Base3_py_5_11Abr21
select a.IMSI,a.IMEI,Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Support_Mode ,Band_Support_Mode ,
        2G_traffic_MB,2G_L7_UL_GOODPUT_kb,2G_DATATRANS_UL_s,2G_L7_DW_GOODPUT_kb,2G_DATATRANS_DW_s,2G_Traffic_Flag,
        3G_traffic_MB,3G_L7_UL_GOODPUT_kb,3G_DATATRANS_UL_s,3G_L7_DW_GOODPUT_kb,3G_DATATRANS_DW_s,3G_Traffic_Flag,
        23G_Traffic_Flag ,
        4G_traffic_MB,4G_L7_UL_GOODPUT_kb,4G_DATATRANS_UL_s,4G_L7_DW_GOODPUT_kb,4G_DATATRANS_DW_s,4G_Traffic_Flag,
        Total_traffic_MB,Total_L7_UL_GOODPUT_kb,Total_DATATRANS_UL_s,Total_L7_DW_GOODPUT_kb,Total_DATATRANS_DW_s,Total_Traffic_Flag,
        Max_Cell_Traffic_MB ,a.Max_PSTraffic_ECGI ,Max_PSTraffic_Cell_access_type,Max_PSTraffic_Cell_xpos,Max_PSTraffic_Cell_ypos,
        b.Around_4G_ECGI as Nearest_4G_ECGI,
        b.Around_4G_Cell_Name as Nearest_4G_Cell_Name,
        b.distance as Nearest_4G_Cell_distance,
        2G_ATTACH_REQ_TIMES ,2G_ATTACH_SUCC_RATE ,3G_ATTACH_REQ_TIMES ,3G_ATTACH_SUCC_RATE , 4G_ATTACH_REQ_TIMES ,4G_ATTACH_SUCC_RATE ,   
        2G_Call_Duration_s,2G_Call_Flag,3G_Call_Duration_s,3G_Call_Flag,MO_Call_Duration_s,MT_Call_Duration_s,Total_Call_Duration_s,Total_Call_Flag
from 
     tmp_ZCS_234GMigration_Base2_py_5_11Abr21  a
left join 
    tmp_ZCS_234GMigration_Nearest_Cell_py_5_11Abr21 b on a.Max_PSTraffic_ECGI=b.Max_PSTraffic_ECGI
;
--</subquery_23>

--<subquery_24>
------------------------------------------------------------------------------------------------Create a subscriber-level information table. (Add data about whether a subscriber uses dual SIM cards.)-------------------------------
----select  * from tmp_ZCS_234GMigration_2CardsUser_@OutputName limit 10;
drop table if exists  tmp_ZCS_234GMigration_2CardsUser_py_5_11Abr21;
create table tmp_ZCS_234GMigration_2CardsUser_py_5_11Abr21
(
Primary_IMSI STRING,
Primary_IMEI STRING,
Secondary_IMSI STRING,
Secondary_IMEI STRING
);
--</subquery_24>

--<subquery_25>
insert into tmp_ZCS_234GMigration_2CardsUser_py_5_11Abr21
select Primary_IMSI,Primary_IMEI,Secondary_IMSI,Secondary_IMEI from
(    select aa.IMSI as Primary_IMSI,aa.IMEI as Primary_IMEI,bb.IMSI as Secondary_IMSI,bb.IMEI as Secondary_IMEI from
          (select IMSI,IMEI from
               (select IMSI,IMEI,Total_traffic_MB,row_number() over (partition by IMEI order by coalesce(Total_traffic_MB,0) desc) as traffic_Order from tmp_ZCS_234GMigration_Base3_py_5_11Abr21 
                   where  imsi is not null and imsi !='' and imei in
                   (select imei from
                        (select IMEI,count(distinct IMSI) as num from tmp_ZCS_234GMigration_Base3_py_5_11Abr21  where imei is not null and imei !='' and imsi is not null and imsi !='' group by IMEI) a 
                     where num=2  -----One IMEI corresponds two IMSIs.
                   ) 
                )c 
             where traffic_Order=1 and coalesce(Total_traffic_MB,0)>0   -----IMSI with the heavier traffic
           )aa
        left join
           (select IMSI,IMEI from
               (select IMSI,IMEI,Total_traffic_MB,2G_ATTACH_REQ_TIMES,3G_ATTACH_REQ_TIMES,4G_ATTACH_REQ_TIMES,row_number() over (partition by IMEI order by  coalesce(Total_traffic_MB,0)  desc) as traffic_Order from tmp_ZCS_234GMigration_Base3_py_5_11Abr21 
                   where  imsi is not null and imsi !='' and imei in
                   (select imei from
                        (select IMEI,count(distinct IMSI) as num from tmp_ZCS_234GMigration_Base3_py_5_11Abr21 where imei is not null and imei !='' and imsi is not null and imsi !='' group by IMEI) a 
                     where num=2 -----One IMEI corresponds two IMSIs.
                   )
                )c 
              where traffic_Order=2  and (coalesce(Total_traffic_MB,0)=0 and (coalesce(2g_attach_req_times,0)+coalesce(3g_attach_req_times,0)+coalesce(4g_attach_req_times,0)=0))   -----IMSI with lighter traffic or IMSI having never attached to a 4G network
           )bb 
         on aa.imei=bb.imei  ---The secondary card consumes no traffic and has never attached to the PS network. (No device supports dual 4G primary SIM cards.)
)ccc
where Primary_IMSI is not null and Primary_IMEI is not null and Secondary_IMSI is not null and Secondary_IMEI is not null
;
--</subquery_25>

--<subquery_26>
----select  * from tmp_ZCS_234GMigration_Base4_@OutputName limit 10;
drop table if exists  tmp_ZCS_234GMigration_Base4_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Base4_py_5_11Abr21
(
IMSI STRING,
IMEI STRING,
Phone_Brand STRING,
Phone_Model STRING,
Phone_Mode  STRING,
Phone_Type STRING,
Phone_OS STRING,
TER_Support_Mode STRING,
Band_Support_Mode STRING,
2G_traffic_MB DOUBLE,
2G_L7_UL_GOODPUT_kb DOUBLE,
2G_DATATRANS_UL_s DOUBLE,
2G_L7_DW_GOODPUT_kb DOUBLE,
2G_DATATRANS_DW_s DOUBLE,
2G_Traffic_Flag STRING,
3G_traffic_MB DOUBLE,
3G_L7_UL_GOODPUT_kb DOUBLE,
3G_DATATRANS_UL_s DOUBLE,
3G_L7_DW_GOODPUT_kb DOUBLE,
3G_DATATRANS_DW_s DOUBLE,
3G_Traffic_Flag STRING,
23G_Traffic_Flag STRING,
4G_traffic_MB DOUBLE,
4G_L7_UL_GOODPUT_kb DOUBLE,
4G_DATATRANS_UL_s DOUBLE,
4G_L7_DW_GOODPUT_kb DOUBLE,
4G_DATATRANS_DW_s DOUBLE,
4G_Traffic_Flag STRING,
Total_traffic_MB DOUBLE,
Total_L7_UL_GOODPUT_kb DOUBLE,
Total_DATATRANS_UL_s DOUBLE,
Total_L7_DW_GOODPUT_kb DOUBLE,
Total_DATATRANS_DW_s DOUBLE,
Total_Traffic_Flag STRING,
Max_Cell_Traffic_MB DOUBLE,
Max_PSTraffic_ECGI STRING,
Max_PSTraffic_Cell_access_type STRING,
Max_PSTraffic_Cell_xpos BIGINT,
Max_PSTraffic_Cell_ypos BIGINT,
Nearest_4G_ECGI STRING,
Nearest_4G_Cell_Name STRING,
Nearest_4G_Cell_distance DOUBLE,
2G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
2G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
3G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
3G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
4G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
4G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
2G_Call_Duration_s DOUBLE,
2G_Call_Flag STRING,
3G_Call_Duration_s DOUBLE,
3G_Call_Flag STRING,
MO_Call_Duration_s DOUBLE,
MT_Call_Duration_s DOUBLE,
Total_Call_Duration_s DOUBLE,
Total_Call_Flag STRING,
Primary_Secondary_CardSlot STRING
);

insert into tmp_ZCS_234GMigration_Base4_py_5_11Abr21
select a.*,b.CardSlot as Primary_Secondary_CardSlot
from 
     tmp_ZCS_234GMigration_Base3_py_5_11Abr21  a
left join 
 (select IMSI,IMEI,CardSlot from
    ( select Primary_IMSI as IMSI,Primary_IMEI as IMEI,'Primary_Card' as CardSlot from  tmp_ZCS_234GMigration_2CardsUser_py_5_11Abr21 
     union all
      select Secondary_IMSI as IMSI,Secondary_IMEI as IMEI,'Secondary_Card' as CardSlot from tmp_ZCS_234GMigration_2CardsUser_py_5_11Abr21
    )cc
 )b
on a.imsi=b.imsi and a.imei=b.imei
;
--</subquery_26>

--<subquery_27>
------------------------------------------------------------------------------------------------Create a subscriber-level information table. (Add some tag fields.)-------------------------------
----select  * from tmp_ZCS_234GMigration_Base_@OutputName limit 10;
drop table if exists  tmp_ZCS_234GMigration_Base_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Base_py_5_11Abr21
(
IMSI STRING,
IMEI STRING,
Phone_Brand STRING,
Phone_Model STRING,
Phone_Mode  STRING,
Phone_Type STRING,
Phone_OS STRING,
TER_Supported_Mode STRING,
Band_Supported_Mode STRING,
Setting_Status STRING,
4G_Cover STRING,
2G_Type STRING,
Traffic_Type STRING,
2G_traffic_MB DOUBLE,
2G_L7_UL_GOODPUT_kb DOUBLE,
2G_DATATRANS_UL_s DOUBLE,
2G_L7_DW_GOODPUT_kb DOUBLE,
2G_DATATRANS_DW_s DOUBLE,
2G_Traffic_Flag STRING,
3G_traffic_MB DOUBLE,
3G_L7_UL_GOODPUT_kb DOUBLE,
3G_DATATRANS_UL_s DOUBLE,
3G_L7_DW_GOODPUT_kb DOUBLE,
3G_DATATRANS_DW_s DOUBLE,
3G_Traffic_Flag STRING,
23G_Traffic_Flag STRING,
4G_traffic_MB DOUBLE,
4G_L7_UL_GOODPUT_kb DOUBLE,
4G_DATATRANS_UL_s DOUBLE,
4G_L7_DW_GOODPUT_kb DOUBLE,
4G_DATATRANS_DW_s DOUBLE,
4G_Traffic_Flag STRING,
Total_traffic_MB DOUBLE,
Total_L7_UL_GOODPUT_kb DOUBLE,
Total_DATATRANS_UL_s DOUBLE,
Total_L7_DW_GOODPUT_kb DOUBLE,
Total_DATATRANS_DW_s DOUBLE,
Total_Traffic_Flag STRING,
Max_Cell_Traffic_MB DOUBLE,
Max_PSTraffic_ECGI STRING,
Max_PSTraffic_Cell_access_type STRING,
Max_PSTraffic_Cell_xpos BIGINT,
Max_PSTraffic_Cell_ypos BIGINT,
Nearest_4G_ECGI STRING,
Nearest_4G_Cell_Name STRING,
Nearest_4G_Cell_distance DOUBLE,
2G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
2G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
3G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
3G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
4G_ATTACH_REQ_TIMES BIGINT,  ----Attach Request Times
4G_ATTACH_SUCC_RATE DOUBLE,   ---Successful Attach Times
2G_Call_Duration_s DOUBLE,
2G_Call_Flag STRING,
3G_Call_Duration_s DOUBLE,
3G_Call_Flag STRING,
MO_Call_Duration_s DOUBLE,
MT_Call_Duration_s DOUBLE,
Total_Call_Duration_s DOUBLE,
Total_Call_Flag STRING,
Primary_Secondary_CardSlot STRING
);

insert into tmp_ZCS_234GMigration_Base_py_5_11Abr21
select IMSI,IMEI,Phone_Brand,Phone_Model,Phone_Mode,Phone_Type,Phone_OS,TER_Supported_Mode,Band_Supported_Mode,
        case when coalesce(Total_traffic_MB,0)=0 and coalesce(MO_Call_Duration_s,0)=0 then 'Maybe_Arrears'
             when TER_Supported_Mode='4G' and Band_Supported_Mode ='4G' and coalesce(4G_traffic_MB,0)=0 and coalesce(4G_ATTACH_REQ_TIMES,0)=0 and Primary_Secondary_CardSlot is null then '4G_Locked'
             when TER_Supported_Mode='4G' and Band_Supported_Mode ='4G' and coalesce(4G_traffic_MB,0)=0 and coalesce(4G_ATTACH_REQ_TIMES,0)=0 and Primary_Secondary_CardSlot = 'Secondary_Card' then 'Secondary_Card'
             when TER_Supported_Mode='4G' and Band_Supported_Mode ='4G' and coalesce(4G_traffic_MB,0)=0 and coalesce(4G_ATTACH_REQ_TIMES,0)>10 and coalesce(4G_ATTACH_SUCC_RATE,0)<0.1 then '4G_Fail_Actived'
             when TER_Supported_Mode='4G' and Band_Supported_Mode ='4G' and coalesce(4G_traffic_MB,0)=0 and coalesce(2G_traffic_MB,0)+coalesce(3G_traffic_MB,0)=0 and coalesce(4G_ATTACH_REQ_TIMES,0)>10 and coalesce(4G_ATTACH_SUCC_RATE,0)>0 and coalesce(2G_ATTACH_REQ_TIMES,0)+coalesce(3G_ATTACH_REQ_TIMES,0)=0  then 'Data_Closed'
             when TER_Supported_Mode='4G' and Band_Supported_Mode ='4G' and coalesce(4G_traffic_MB,0)=0  then 'Check_4G_Coverage'
            else 'No_Care'
        end as Setting_Status,
        case when  coalesce(Total_traffic_MB,0)>0 and Nearest_4G_ECGI is not null then '4G_Cell_Around_300'
                when  coalesce(Total_traffic_MB,0)>0 and Nearest_4G_ECGI is null then 'NO_4G_Cell_Around_300'
                else 'No_Care' 
        end as 4G_Cover,
        case when (TER_Supported_Mode='2G' or Band_Supported_Mode='2G') and coalesce(2G_traffic_MB,0)=0 and 2G_Call_Duration_s>0 then '2G_Voice_Only'
             when (TER_Supported_Mode='2G' or Band_Supported_Mode='2G') and coalesce(2G_traffic_MB,0)=0 and coalesce(2G_Call_Duration_s,0)=0 then '2G_Zero_PSCS'
             when (TER_Supported_Mode='2G' or Band_Supported_Mode='2G') and 2G_traffic_MB>0 and coalesce(2G_Call_Duration_s,0)=0 then '2G_PS_Only'
             when (TER_Supported_Mode='2G' or Band_Supported_Mode='2G') and 2G_traffic_MB>0 and 2G_Call_Duration_s>0 then '2G_Nomal'
             else 'No_Care'     end as 2G_Type,
        case when 4G_traffic_MB>0 and coalesce(2G_traffic_MB,0)=0  and  coalesce(3G_traffic_MB,0)=0 then 'With_4G_Traffic_Only'
             when 4G_traffic_MB>0 and (coalesce(2G_traffic_MB,0)>0  or coalesce(3G_traffic_MB,0)>0 ) and 1.0*4G_traffic_MB/(coalesce(2G_traffic_MB,0)+coalesce(3G_traffic_MB,0)+coalesce(4G_traffic_MB,0))>=0.8 then 'Normal_234G_Traffic'
             when 4G_traffic_MB>0 and (coalesce(2G_traffic_MB,0)>0  or coalesce(3G_traffic_MB,0)>0 ) and 1.0*4G_traffic_MB/(coalesce(2G_traffic_MB,0)+coalesce(3G_traffic_MB,0)+coalesce(4G_traffic_MB,0))<0.8 then '4G_Fallback_to_23G'
             when coalesce(4G_traffic_MB,0)=0 and (coalesce(2G_traffic_MB,0)>0  or coalesce(3G_traffic_MB,0)>0 ) then 'With_23G_Traffic_Only'
             when coalesce(4G_traffic_MB,0)=0 and ( coalesce(2G_traffic_MB,0)=0 ) and ( coalesce(3G_traffic_MB,0)=0 ) then 'With_No_Traffic'
             else 'No_Care'      end as Traffic_Type,
        2G_traffic_MB ,2G_L7_UL_GOODPUT_kb ,2G_DATATRANS_UL_s ,2G_L7_DW_GOODPUT_kb ,2G_DATATRANS_DW_s ,2G_Traffic_Flag ,
        3G_traffic_MB ,3G_L7_UL_GOODPUT_kb ,3G_DATATRANS_UL_s ,3G_L7_DW_GOODPUT_kb ,3G_DATATRANS_DW_s ,3G_Traffic_Flag ,
        23G_Traffic_Flag ,
        4G_traffic_MB ,4G_L7_UL_GOODPUT_kb ,4G_DATATRANS_UL_s ,4G_L7_DW_GOODPUT_kb ,4G_DATATRANS_DW_s ,4G_Traffic_Flag ,
        Total_traffic_MB ,Total_L7_UL_GOODPUT_kb ,Total_DATATRANS_UL_s ,Total_L7_DW_GOODPUT_kb ,Total_DATATRANS_DW_s ,Total_Traffic_Flag ,
        Max_Cell_Traffic_MB ,Max_PSTraffic_ECGI ,Max_PSTraffic_Cell_access_type ,Max_PSTraffic_Cell_xpos ,Max_PSTraffic_Cell_ypos ,
        Nearest_4G_ECGI ,Nearest_4G_Cell_Name ,Nearest_4G_Cell_distance ,
        2G_ATTACH_REQ_TIMES , 2G_ATTACH_SUCC_RATE , 3G_ATTACH_REQ_TIMES ,3G_ATTACH_SUCC_RATE , 4G_ATTACH_REQ_TIMES , 4G_ATTACH_SUCC_RATE ,
        2G_Call_Duration_s ,2G_Call_Flag ,3G_Call_Duration_s ,3G_Call_Flag ,MO_Call_Duration_s ,MT_Call_Duration_s ,
        Total_Call_Duration_s ,Total_Call_Flag ,
        Primary_Secondary_CardSlot     
from
    (select IMSI ,IMEI ,Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,
            case when (TER_Support_Mode='2G' or TER_Support_Mode='3G' or TER_Support_Mode is null) and (4G_ATTACH_REQ_TIMES>0 or 4G_traffic_MB>0) then  '4G'
                  when (TER_Support_Mode='2G' or TER_Support_Mode is null) and (3G_ATTACH_REQ_TIMES>0 or 3G_traffic_MB>0 or 3G_Call_Duration_s>0) then  '3G'
                  when(TER_Support_Mode is null) and (2G_ATTACH_REQ_TIMES>0 or 2G_traffic_MB>0 or 2G_Call_Duration_s>0) then  '2G'
                  else TER_Support_Mode
                  end as TER_Supported_Mode,    ----Correct errors in the platform TAC library.
            case when (Band_Support_Mode='2G' or Band_Support_Mode='3G' or Band_Support_Mode is null) and (4G_ATTACH_REQ_TIMES>0 or 4G_traffic_MB>0) then  '4G'
                  when (Band_Support_Mode='2G' or Band_Support_Mode is null) and (3G_ATTACH_REQ_TIMES>0 or 3G_traffic_MB>0 or 3G_Call_Duration_s>0) then  '3G'
                  when(Band_Support_Mode is null) and (2G_ATTACH_REQ_TIMES>0 or 2G_traffic_MB>0 or 2G_Call_Duration_s>0) then  '2G'
                  else Band_Support_Mode
                  end as Band_Supported_Mode,    ----Correct errors in the platform TAC library.
            2G_traffic_MB ,2G_L7_UL_GOODPUT_kb ,2G_DATATRANS_UL_s ,2G_L7_DW_GOODPUT_kb ,2G_DATATRANS_DW_s ,2G_Traffic_Flag ,
            3G_traffic_MB ,3G_L7_UL_GOODPUT_kb ,3G_DATATRANS_UL_s ,3G_L7_DW_GOODPUT_kb ,3G_DATATRANS_DW_s ,3G_Traffic_Flag ,
            23G_Traffic_Flag ,
            4G_traffic_MB ,4G_L7_UL_GOODPUT_kb ,4G_DATATRANS_UL_s ,4G_L7_DW_GOODPUT_kb ,4G_DATATRANS_DW_s ,4G_Traffic_Flag ,
            Total_traffic_MB ,Total_L7_UL_GOODPUT_kb ,Total_DATATRANS_UL_s ,Total_L7_DW_GOODPUT_kb ,Total_DATATRANS_DW_s ,Total_Traffic_Flag ,
            Max_Cell_Traffic_MB ,Max_PSTraffic_ECGI ,Max_PSTraffic_Cell_access_type ,Max_PSTraffic_Cell_xpos ,Max_PSTraffic_Cell_ypos ,
            Nearest_4G_ECGI ,Nearest_4G_Cell_Name ,Nearest_4G_Cell_distance ,
            2G_ATTACH_REQ_TIMES , 2G_ATTACH_SUCC_RATE , 3G_ATTACH_REQ_TIMES ,3G_ATTACH_SUCC_RATE , 4G_ATTACH_REQ_TIMES , 4G_ATTACH_SUCC_RATE ,
            2G_Call_Duration_s ,2G_Call_Flag ,3G_Call_Duration_s ,3G_Call_Flag ,MO_Call_Duration_s ,MT_Call_Duration_s ,
            Total_Call_Duration_s ,Total_Call_Flag ,
            Primary_Secondary_CardSlot 
        from tmp_ZCS_234GMigration_Base4_py_5_11Abr21
    )a
;
--</subquery_27>

--<subquery_28>
--------------------------------------------------------------Collects statistics on and display subscriber categories based on the basic table. --------------------------------------------------
---------Export: Convert the basic table into a statistics table (basic category table for reference). -------------
----select  * from tmp_ZCS_234GMigration_Base_Trans_@OutputName limit 10;
drop table if exists  tmp_ZCS_234GMigration_Base_Trans_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Base_Trans_py_5_11Abr21
(
TER_Supported_Mode STRING,
Band_Supported_Mode STRING,
Traffic_Type STRING,
2G_Type STRING,
2G_Traffic_Flag STRING,
3G_Traffic_Flag STRING,
23G_Traffic_Flag STRING,
4G_Traffic_Flag STRING,
Total_Traffic_Flag STRING,
2G_Call_Flag STRING,
3G_Call_Flag STRING,
Total_Call_Flag STRING,
4G_Cover STRING,
Setting_Status STRING,
CardSlot STRING,
User_Count BIGINT,
2G_traffic_MB DOUBLE,
2G_L7_UL_GOODPUT_kb DOUBLE,
2G_DATATRANS_UL_s DOUBLE,
2G_L7_DW_GOODPUT_kb DOUBLE,
2G_DATATRANS_DW_s DOUBLE,
3G_traffic_MB DOUBLE,
3G_L7_UL_GOODPUT_kb DOUBLE,
3G_DATATRANS_UL_s DOUBLE,
3G_L7_DW_GOODPUT_kb DOUBLE,
3G_DATATRANS_DW_s DOUBLE,
4G_traffic_MB DOUBLE,
4G_L7_UL_GOODPUT_kb DOUBLE,
4G_DATATRANS_UL_s DOUBLE,
4G_L7_DW_GOODPUT_kb DOUBLE,
4G_DATATRANS_DW_s DOUBLE,
Total_traffic_MB DOUBLE,
Total_L7_UL_GOODPUT_kb DOUBLE,
Total_DATATRANS_UL_s DOUBLE,
Total_L7_DW_GOODPUT_kb DOUBLE,
Total_DATATRANS_DW_s DOUBLE,
2G_Call_Duration_s DOUBLE,
3G_Call_Duration_s DOUBLE,
MO_Call_Duration_s DOUBLE,
MT_Call_Duration_s DOUBLE,
Total_Call_Duration_s DOUBLE
);

insert into tmp_ZCS_234GMigration_Base_Trans_py_5_11Abr21
select TER_Supported_Mode,Band_Supported_Mode,Traffic_Type,2G_Type,2G_Traffic_Flag,3G_Traffic_Flag,23G_Traffic_Flag,4G_Traffic_Flag,Total_Traffic_Flag,
       2G_Call_Flag,3G_Call_Flag,Total_Call_Flag,4G_Cover,Setting_Status,
       case when Primary_Secondary_CardSlot is not null then Primary_Secondary_CardSlot
       else 'Normal_One_Card' end as CardSlot,
        count(distinct IMSI) as User_Count,
        sum(2G_traffic_MB) as 2G_traffic_MB,
        sum(2G_L7_UL_GOODPUT_kb) as 2G_L7_UL_GOODPUT_kb,
        sum(2G_DATATRANS_UL_s) as 2G_DATATRANS_UL_s,
        sum(2G_L7_DW_GOODPUT_kb) as 2G_L7_DW_GOODPUT_kb,
        sum(2G_DATATRANS_DW_s) as 2G_DATATRANS_DW_s,
        sum(3G_traffic_MB) as 3G_traffic_MB,
        sum(3G_L7_UL_GOODPUT_kb) as 3G_L7_UL_GOODPUT_kb,
        sum(3G_DATATRANS_UL_s) as 3G_DATATRANS_UL_s,
        sum(3G_L7_DW_GOODPUT_kb) as 3G_L7_DW_GOODPUT_kb,
        sum(3G_DATATRANS_DW_s) as 3G_DATATRANS_DW_s,
        sum(4G_traffic_MB) as 4G_traffic_MB,
        sum(4G_L7_UL_GOODPUT_kb) as 4G_L7_UL_GOODPUT_kb,
        sum(4G_DATATRANS_UL_s) as 4G_DATATRANS_UL_s,
        sum(4G_L7_DW_GOODPUT_kb) as 4G_L7_DW_GOODPUT_kb,
        sum(4G_DATATRANS_DW_s) as 4G_DATATRANS_DW_s,
        sum(Total_traffic_MB) as Total_traffic_MB,
        sum(Total_L7_UL_GOODPUT_kb) as Total_L7_UL_GOODPUT_kb,
        sum(Total_DATATRANS_UL_s) as Total_DATATRANS_UL_s,
        sum(Total_L7_DW_GOODPUT_kb) as Total_L7_DW_GOODPUT_kb,
        sum(Total_DATATRANS_DW_s) as Total_DATATRANS_DW_s,
        sum(2G_Call_Duration_s) as 2G_Call_Duration_s,
        sum(3G_Call_Duration_s) as 3G_Call_Duration_s,
        sum(MO_Call_Duration_s) as MO_Call_Duration_s,
        sum(MT_Call_Duration_s) as MT_Call_Duration_s,
        sum(Total_Call_Duration_s) as Total_Call_Duration_s
from 
     tmp_ZCS_234GMigration_Base_py_5_11Abr21  a
group by TER_Supported_Mode,Band_Supported_Mode,Traffic_Type,2G_Type,2G_Traffic_Flag,3G_Traffic_Flag,23G_Traffic_Flag,4G_Traffic_Flag,Total_Traffic_Flag,2G_Call_Flag,3G_Call_Flag,Total_Call_Flag,4G_Cover,Setting_Status,CardSlot
;
--</subquery_28>

--<subquery_29>
---------Export: display-oriented category analysis-------------
----select  * from tmp_ZCS_234GMigration_Output_@OutputName;
drop table if exists  tmp_ZCS_234GMigration_Output_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Output_py_5_11Abr21
(TER_Supported_Mode STRING,
Band_Supported_Mode STRING,
Traffic_Type STRING,
2G_Traffic_Flag STRING,
3G_Traffic_Flag STRING,
23G_Traffic_Flag STRING,
4G_Traffic_Flag STRING,
Total_Traffic_Flag STRING,
Call_Flag STRING,
2G_Type STRING,
Setting_Status STRING,
4G_Coverage STRING,
User_Count BIGINT,
2G_traffic_MB DOUBLE,
2G_L7_UL_GOODPUT_kb DOUBLE,
2G_DATATRANS_UL_s DOUBLE,
2G_L7_DW_GOODPUT_kb DOUBLE,
2G_DATATRANS_DW_s DOUBLE,
3G_traffic_MB DOUBLE,
3G_L7_UL_GOODPUT_kb DOUBLE,
3G_DATATRANS_UL_s DOUBLE,
3G_L7_DW_GOODPUT_kb DOUBLE,
3G_DATATRANS_DW_s DOUBLE,
4G_traffic_MB DOUBLE,
4G_L7_UL_GOODPUT_kb DOUBLE,
4G_DATATRANS_UL_s DOUBLE,
4G_L7_DW_GOODPUT_kb DOUBLE,
4G_DATATRANS_DW_s DOUBLE,
Total_traffic_MB DOUBLE,
Total_L7_UL_GOODPUT_kb DOUBLE,
Total_DATATRANS_UL_s DOUBLE,
Total_L7_DW_GOODPUT_kb DOUBLE,
Total_DATATRANS_DW_s DOUBLE,
2G_Call_Duration_s DOUBLE,
3G_Call_Duration_s DOUBLE,
MO_Call_Duration_s DOUBLE,
MT_Call_Duration_s DOUBLE,
Total_Call_Duration_s DOUBLE
);

insert into tmp_ZCS_234GMigration_Output_py_5_11Abr21
select TER_Supported_Mode,Band_Supported_Mode,Traffic_Type,2G_Traffic_Flag,3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag,Call_Flag,2G_Type,Setting_Status,
        case when Setting_Status='Check_4G_Coverage'and Nearest_4G_ECGI is not null then '4G_Cell_Around_300'
             when Setting_Status='Check_4G_Coverage'and Nearest_4G_ECGI is null then 'NO_4G_Cell_Around_300'
             when Traffic_Type='4G_Fallback_to_23G' and Nearest_4G_ECGI is not null then '4G_Cell_Around_300'
             when Traffic_Type='4G_Fallback_to_23G' and Nearest_4G_ECGI is null then 'NO_4G_Cell_Around_300'
             else  'No_Care'  end as 4G_Coverage,
        count(distinct IMSI) as User_Count,
        sum(2G_traffic_MB) as 2G_traffic_MB,
        sum(2G_L7_UL_GOODPUT_kb) as 2G_L7_UL_GOODPUT_kb,
        sum(2G_DATATRANS_UL_s) as 2G_DATATRANS_UL_s,
        sum(2G_L7_DW_GOODPUT_kb) as 2G_L7_DW_GOODPUT_kb,
        sum(2G_DATATRANS_DW_s) as 2G_DATATRANS_DW_s,
        sum(3G_traffic_MB) as 3G_traffic_MB,
        sum(3G_L7_UL_GOODPUT_kb) as 3G_L7_UL_GOODPUT_kb,
        sum(3G_DATATRANS_UL_s) as 3G_DATATRANS_UL_s,
        sum(3G_L7_DW_GOODPUT_kb) as 3G_L7_DW_GOODPUT_kb,
        sum(3G_DATATRANS_DW_s) as 3G_DATATRANS_DW_s,
        sum(4G_traffic_MB) as 4G_traffic_MB,
        sum(4G_L7_UL_GOODPUT_kb) as 4G_L7_UL_GOODPUT_kb,
        sum(4G_DATATRANS_UL_s) as 4G_DATATRANS_UL_s,
        sum(4G_L7_DW_GOODPUT_kb) as 4G_L7_DW_GOODPUT_kb,
        sum(4G_DATATRANS_DW_s) as 4G_DATATRANS_DW_s,
        sum(Total_traffic_MB) as Total_traffic_MB,
        sum(Total_L7_UL_GOODPUT_kb) as Total_L7_UL_GOODPUT_kb,
        sum(Total_DATATRANS_UL_s) as Total_DATATRANS_UL_s,
        sum(Total_L7_DW_GOODPUT_kb) as Total_L7_DW_GOODPUT_kb,
        sum(Total_DATATRANS_DW_s) as Total_DATATRANS_DW_s,
        sum(2G_Call_Duration_s) as 2G_Call_Duration_s,
        sum(3G_Call_Duration_s) as 3G_Call_Duration_s,
        sum(MO_Call_Duration_s) as MO_Call_Duration_s,
        sum(MT_Call_Duration_s) as MT_Call_Duration_s,
        sum(Total_Call_Duration_s) as Total_Call_Duration_s
from
        (select  a.*,  
                 case when coalesce(4G_traffic_MB,0)=0 and coalesce(2G_traffic_MB,0)=0  and coalesce(3G_traffic_MB,0)=0  then Total_Call_Flag
                      else 'No_Care'     end as Call_Flag
        from  tmp_ZCS_234GMigration_Base_py_5_11Abr21  a
        )b
 group by TER_Supported_Mode,Band_Supported_Mode,Traffic_Type,2G_Traffic_Flag,3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag,
        Call_Flag,2G_Type,Setting_Status,4G_Coverage
;
--</subquery_29>

--<subquery_30>
---------Export: Base station engineering parameter diagram, which is used to analyze the 2G, 3G, and 4G coverage area.----
----select  * from tmp_ZCS_234GMigration_Cells_@OutputName where access_type='4G' limit 10;
drop table if exists  tmp_ZCS_234GMigration_Cells_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Cells_py_5_11Abr21
(
cgisai STRING,
cell_name STRING,
xpos BIGINT,
ypos BIGINT,
access_type STRING
);

insert into tmp_ZCS_234GMigration_Cells_py_5_11Abr21
select  cgisai,cell_name,xpos,ypos,access_type from  nethouse.dim_loc_cgisai 
;
--</subquery_30>

--<subquery_31>
---------Export: Obtain the list of 2G and 3G cells (in the network planning) from which subscribers cannot migrate to a 4G cell because there is no 4G coverage around the cells.-------------
----select  * from tmp_ZCS_234GMigration_Planning_Cells_@OutputName   where Affected_High_PS_User_Count>10 limit 30;
drop table if exists  tmp_ZCS_234GMigration_Planning_Cells_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Planning_Cells_py_5_11Abr21
(Max_PSTraffic_ECGI STRING,
cell_name STRING,
xpos BIGINT,
ypos BIGINT,
access_type STRING,
Affected_High_PS_User_Count BIGINT
);

insert into tmp_ZCS_234GMigration_Planning_Cells_py_5_11Abr21
select Max_PSTraffic_ECGI,cell_name,xpos,ypos,access_type,Affected_High_PS_User_Count
from
        (select Max_PSTraffic_ECGI,Affected_High_PS_User_Count from
        (select Max_PSTraffic_ECGI,count(distinct IMSI ) as Affected_High_PS_User_Count
         from 
                  (select b.*,
                            case when (Setting_Status='Check_4G_Coverage'and Nearest_4G_ECGI is not null) or 
                                        (TER_Supported_Mode='4G' and Band_Supported_Mode ='4G' and coalesce(4G_traffic_MB,0)=0  and  coalesce(Total_traffic_MB,0)>0 and Nearest_4G_ECGI is not null ) then '4G_Cell_Around_300'
                                 when (Setting_Status='Check_4G_Coverage'and Nearest_4G_ECGI is null) or
                                        (TER_Supported_Mode='4G' and Band_Supported_Mode ='4G' and coalesce(4G_traffic_MB,0)=0  and  coalesce(Total_traffic_MB,0)>0 and Nearest_4G_ECGI is null ) then 'NO_4G_Cell_Around_300'
                                 when Traffic_Type='4G_Fallback_to_23G' and Nearest_4G_ECGI is not null then '4G_Cell_Around_300'
                                 when Traffic_Type='4G_Fallback_to_23G' and Nearest_4G_ECGI is null then 'NO_4G_Cell_Around_300'
                                 else  'No_Care'  end as 4G_Coverage
                    from
                         (  select a.*,
                                    case when 2G_traffic_MB>0 or 3G_traffic_MB>0  then 23G_Traffic_Flag
                                         else 'No_Care'     end as 23G_Traffic
                                from  tmp_ZCS_234GMigration_Base_py_5_11Abr21 a
                         )b  
                 )d
        where 4G_Coverage='NO_4G_Cell_Around_300' and  23g_traffic = '23G_High_Traffic_User' 
        group by Max_PSTraffic_ECGI
       )e  where Affected_High_PS_User_Count>0
       )f
left join nethouse.dim_loc_cgisai dim on f.Max_PSTraffic_ECGI =dim.cgisai
;
--</subquery_31>

--<subquery_32>
------Export: Cells that need to be optimized on the entire network
--select * from tmp_ZCS_234GMigration_Optimiz_Cells_@OutputName limit 30;
drop table if exists  tmp_ZCS_234GMigration_Optimiz_Cells_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Optimiz_Cells_py_5_11Abr21
(Max_PSTraffic_ECGI STRING,
cell_name STRING,
xpos BIGINT,
ypos BIGINT,
access_type STRING,
Affected_High_PS_User_Count BIGINT
);

insert into tmp_ZCS_234GMigration_Optimiz_Cells_py_5_11Abr21
select Max_PSTraffic_ECGI,cell_name,xpos,ypos,access_type,Affected_High_PS_User_Count
from
        (select Max_PSTraffic_ECGI,Affected_High_PS_User_Count from
           (select Max_PSTraffic_ECGI,count(distinct IMSI ) as Affected_High_PS_User_Count
              from 
                  (select c.*,
                            case when (Setting_Status='Check_4G_Coverage'and Nearest_4G_ECGI is not null) or 
                                              (TER_Supported_Mode='4G' and Band_Supported_Mode ='4G' and coalesce(4G_traffic_MB,0)=0  and  coalesce(Total_traffic_MB,0)>0 and Nearest_4G_ECGI is not null ) then '4G_Cell_Around_300'
                                 when (Setting_Status='Check_4G_Coverage'and Nearest_4G_ECGI is null) or
                                           (TER_Supported_Mode='4G' and Band_Supported_Mode ='4G' and coalesce(4G_traffic_MB,0)=0  and  coalesce(Total_traffic_MB,0)>0 and Nearest_4G_ECGI is null ) then 'NO_4G_Cell_Around_300'
                                 when Traffic_Type='4G_Fallback_to_23G' and Nearest_4G_ECGI is not null then '4G_Cell_Around_300'
                                 when Traffic_Type='4G_Fallback_to_23G' and Nearest_4G_ECGI is null then 'NO_4G_Cell_Around_300'
                                 else  'No_Care'   end as 4G_Coverage
                    from
                         (  select a.*,
                                    case when 2G_traffic_MB>0 or 3G_traffic_MB>0  then 23G_Traffic_Flag
                                         else 'No_Care'     end as 23G_Traffic
                                from   tmp_ZCS_234GMigration_Base_py_5_11Abr21 a
                           )c    
                 )d
        where 4G_Coverage='4G_Cell_Around_300' and Max_PSTraffic_Cell_access_type in ('2G','3G') and 23g_traffic = '23G_High_Traffic_User'
        group by Max_PSTraffic_ECGI
       )e       where  Affected_High_PS_User_Count>0
     )f
left join nethouse.dim_loc_cgisai dim on f.Max_PSTraffic_ECGI =dim.cgisai
;
--</subquery_32>

--<subquery_33>
------Export: Information about cells on the entire network where MBB traffic marketing activities need to be launched. (MBB services need to be developed in areas where 4G traffic is normal).
--select * from tmp_ZCS_234GMigration_Promote_MBB_@OutputName limit 30;
drop table if exists  tmp_ZCS_234GMigration_Promote_MBB_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Promote_MBB_py_5_11Abr21
(Max_PSTraffic_ECGI STRING,
cell_name STRING,
xpos BIGINT,
ypos BIGINT,
access_type STRING,
User_Count BIGINT
);

insert into tmp_ZCS_234GMigration_Promote_MBB_py_5_11Abr21
select Max_PSTraffic_ECGI,cell_name,xpos,ypos,access_type,User_Count
from
    (select Max_PSTraffic_ECGI,User_Count from
        (select Max_PSTraffic_ECGI,count(distinct IMSI) as User_Count
              from  tmp_ZCS_234GMigration_Base_py_5_11Abr21 a
               where 4G_Cover='4G_Cell_Around_300' and  Traffic_Type in ('Normal_234G_Traffic','With_4G_Traffic_Only') 
         group by Max_PSTraffic_ECGI
        )e   where  User_Count>0
    )f
left join nethouse.dim_loc_cgisai dim on f.Max_PSTraffic_ECGI =dim.cgisai
;
--</subquery_33>

--<subquery_34>
---------Export: Obtain the distribution of key cells where devices need to be promoted.-------------
----select  * from tmp_ZCS_234GMigration_ChangeTER_Cells_@OutputName   limit 30;
drop table if exists  tmp_ZCS_234GMigration_ChangeTER_Cells_py_5_11Abr21;
create table tmp_ZCS_234GMigration_ChangeTER_Cells_py_5_11Abr21
(Max_PSTraffic_ECGI STRING,
cell_name STRING,
xpos BIGINT,
ypos BIGINT,
access_type STRING,
Affected_High_PS_User_Count BIGINT
);

insert into tmp_ZCS_234GMigration_ChangeTER_Cells_py_5_11Abr21
select Max_PSTraffic_ECGI,cell_name,xpos,ypos,access_type,Affected_High_PS_User_Count
from
        (select Max_PSTraffic_ECGI,Affected_High_PS_User_Count from
        (select Max_PSTraffic_ECGI,count(distinct IMSI ) as Affected_High_PS_User_Count
         from 
                  (select  a.*, 
                              case when 2G_traffic_MB>0 or 3G_traffic_MB>0  then 23G_Traffic_Flag
                                else 'No_Care'     
                           end as 23G_Traffic
                        from  tmp_ZCS_234GMigration_Base_py_5_11Abr21  a
                )b
             where Band_Supported_Mode !='4G' and  23g_traffic = '23G_High_Traffic_User'
             group by Max_PSTraffic_ECGI
       )e where Affected_High_PS_User_Count>0
       )f
left join nethouse.dim_loc_cgisai dim on f.Max_PSTraffic_ECGI =dim.cgisai
;
--</subquery_34>

--<subquery_35>
---------Obtain the list of cells where subscriber traffic consuming behavior needs to be guided. (In these cells, the total consumed traffic is light even when 4G coverage, subscriber network locking, secondary card, and device issues are excluded.). -------------
----Find out the subscribers consuming light traffic, and then locate resident cells based on the camping duration of the subscribers.
----select  * from tmp_ZCS_234GMigration_Promote_Data_IMSI_@OutputName   limit 30;
drop table if exists  tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21
(IMSI STRING
);
insert into tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21
select IMSI  from 
                  (select c.*,
                            case when (Setting_Status='Check_4G_Coverage'and Nearest_4G_ECGI is not null) or 
                                            (TER_Supported_Mode='4G' and Band_Supported_Mode ='4G' and coalesce(4G_traffic_MB,0)=0  and  coalesce(Total_traffic_MB,0)>0 and Nearest_4G_ECGI is not null ) then '4G_Cell_Around_300'
                                 when (Setting_Status='Check_4G_Coverage'and Nearest_4G_ECGI is null) or
                                           (TER_Supported_Mode='4G' and Band_Supported_Mode ='4G' and coalesce(4G_traffic_MB,0)=0  and  coalesce(Total_traffic_MB,0)>0 and Nearest_4G_ECGI is null ) then 'NO_4G_Cell_Around_300'
                                 when Traffic_Type='4G_Fallback_to_23G' and Nearest_4G_ECGI is not null then '4G_Cell_Around_300'
                                 when Traffic_Type='4G_Fallback_to_23G' and Nearest_4G_ECGI is null then 'NO_4G_Cell_Around_300'
                                 else  'No_Care'   end as 4G_Coverage
                    from
                         (  select a.*,
                                    case when 2G_traffic_MB>0 or 3G_traffic_MB>0  then 23G_Traffic_Flag
                                         else 'No_Care'     end as 23G_Traffic
                                from tmp_ZCS_234GMigration_Base_py_5_11Abr21  a
                         )c    
                 )d
            where  (4G_Coverage='4G_Cell_Around_300' and 4G_Traffic_Flag in ( 'NO_4G_Traffic_User','4G_Low_Traffic_User') )  ---light 4G traffic not due to 4G coverage issues
                     or 
                   (TER_Supported_Mode='4G' and Band_Supported_Mode ='4G' and Setting_Status='No_Care' and  4G_Coverage='No_Care' and 4G_Traffic_Flag in ( 'NO_4G_Traffic_User','4G_Low_Traffic_User') )   ---light 4G traffic not due to device, secondary card, and network locking issues
;
--</subquery_35>



--<subquery_36>
----Find the resident cells which this batch of subscribers camp on in the morning from 09:00 to 11: 00.
--select * from tmp_ZCS_234GMigration_User_Location_@OutputName  limit 30;
drop table if exists  tmp_ZCS_234GMigration_User_Location_py_5_11Abr21;
create table tmp_ZCS_234GMigration_User_Location_py_5_11Abr21 
(IMSI STRING,
  ECGI STRING,
Days_Total_Time BIGINT
);

insert into tmp_ZCS_234GMigration_User_Location_py_5_11Abr21
    select IMSI,ECGI,sum(Total_Time) as Days_Total_Time from
( 
    select tbl1.IMSI,tbl1.SAI_CGI_ECGI as ECGI, sum(sum_timediff) as Total_Time
    from 
    (select aa.IMSI,aa.SAI_CGI_ECGI,sum(bb.PROC_STARTTIME - aa.PROC_STARTTIME) as sum_timediff from
            (select a.*,row_number() over(partition by a.IMSI order by PROC_STARTTIME,SAI_CGI_ECGI,PROC_TYPE)  rn  
            from 
                (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                 from  ps.DETAIL_CDR_GbIuPS_18722
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(11*3600 as int) 
                union all 
                 select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                    from ps.DETAIL_CDR_S1MME_18722
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(11*3600 as int) 
               union all 
                 select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                   from cs.TDR_AIU_MM_18722
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and STARTTIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(11*3600 as int)  
               union all ---Add a record about the end time for each subscriber.
                    select 'DAY_END' as SAI_CGI_ECGI, IMSI,UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(11*3600 as int) as PROC_STARTTIME ,199 as PROC_TYPE from  ---  PROC_STARTTIME is used as the end time.
                       (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                         from  ps.DETAIL_CDR_GbIuPS_18722
                         where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(11*3600 as int) 
                   union all 
                        select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                        from ps.DETAIL_CDR_S1MME_18722
                        where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                        from cs.TDR_AIU_MM_18722
                        where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and   STARTTIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(11*3600 as int)
                        )c  
                      group by IMSI
                     )  a
            ) aa
        left join 
            (select a.*,row_number() over(partition by a.IMSI order by PROC_STARTTIME,SAI_CGI_ECGI,PROC_TYPE)  rn  
            from 
                (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                 from  ps.DETAIL_CDR_GbIuPS_18722
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(11*3600 as int) 
                union all 
                 select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                    from ps.DETAIL_CDR_S1MME_18722
                 where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(11*3600 as int) 
                union all 
                 select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                   from cs.TDR_AIU_MM_18722
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and STARTTIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(11*3600 as int)  
               union all ---Add a record about the end time for each subscriber.
                    select 'DAY_END' as SAI_CGI_ECGI, IMSI,UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(11*3600 as int) as PROC_STARTTIME ,199 as PROC_TYPE from  ---  PROC_STARTTIME is used as the end time.
                       (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                         from  ps.DETAIL_CDR_GbIuPS_18722
                         where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)    and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                        from ps.DETAIL_CDR_S1MME_18722
                        where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                        from cs.TDR_AIU_MM_18722
                        where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and STARTTIME>=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-05 00:00:00')+cast(11*3600 as int)
                        )c  
                      group by IMSI
                     )  a
            ) bb  on aa.IMSI = bb.IMSI and aa.rn = bb.rn-1 
       group by aa.IMSI,aa.SAI_CGI_ECGI
    )tbl1
    group by tbl1.IMSI,tbl1.SAI_CGI_ECGI
 union all
    select tbl1.IMSI,tbl1.SAI_CGI_ECGI as ECGI, sum(sum_timediff) as Total_Time
    from 
    (select aa.IMSI,aa.SAI_CGI_ECGI,sum(bb.PROC_STARTTIME - aa.PROC_STARTTIME) as sum_timediff from
            (select a.*,row_number() over(partition by a.IMSI order by PROC_STARTTIME,SAI_CGI_ECGI,PROC_TYPE)  rn  
            from 
                (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                 from  ps.DETAIL_CDR_GbIuPS_18723
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(11*3600 as int) 
                union all 
                 select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                    from ps.DETAIL_CDR_S1MME_18723
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(11*3600 as int) 
               union all 
                 select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                   from cs.TDR_AIU_MM_18723
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and STARTTIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(11*3600 as int)  
               union all ---Add a record about the end time for each subscriber.
                    select 'DAY_END' as SAI_CGI_ECGI, IMSI,UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(11*3600 as int) as PROC_STARTTIME ,199 as PROC_TYPE from  ---  PROC_STARTTIME is used as the end time.
                       (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                         from  ps.DETAIL_CDR_GbIuPS_18723
                         where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(11*3600 as int) 
                   union all 
                        select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                        from ps.DETAIL_CDR_S1MME_18723
                        where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                        from cs.TDR_AIU_MM_18723
                        where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and   STARTTIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(11*3600 as int)
                        )c  
                      group by IMSI
                     )  a
            ) aa
        left join 
            (select a.*,row_number() over(partition by a.IMSI order by PROC_STARTTIME,SAI_CGI_ECGI,PROC_TYPE)  rn  
            from 
                (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                 from  ps.DETAIL_CDR_GbIuPS_18723
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(11*3600 as int) 
                union all 
                 select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                    from ps.DETAIL_CDR_S1MME_18723
                 where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(11*3600 as int) 
                union all 
                 select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                   from cs.TDR_AIU_MM_18723
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and STARTTIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(11*3600 as int)  
               union all ---Add a record about the end time for each subscriber.
                    select 'DAY_END' as SAI_CGI_ECGI, IMSI,UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(11*3600 as int) as PROC_STARTTIME ,199 as PROC_TYPE from  ---  PROC_STARTTIME is used as the end time.
                       (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                         from  ps.DETAIL_CDR_GbIuPS_18723
                         where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)    and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                        from ps.DETAIL_CDR_S1MME_18723
                        where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                        from cs.TDR_AIU_MM_18723
                        where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and STARTTIME>=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-06 00:00:00')+cast(11*3600 as int)
                        )c  
                      group by IMSI
                     )  a
            ) bb  on aa.IMSI = bb.IMSI and aa.rn = bb.rn-1 
       group by aa.IMSI,aa.SAI_CGI_ECGI
    )tbl1
    group by tbl1.IMSI,tbl1.SAI_CGI_ECGI
 union all
    select tbl1.IMSI,tbl1.SAI_CGI_ECGI as ECGI, sum(sum_timediff) as Total_Time
    from 
    (select aa.IMSI,aa.SAI_CGI_ECGI,sum(bb.PROC_STARTTIME - aa.PROC_STARTTIME) as sum_timediff from
            (select a.*,row_number() over(partition by a.IMSI order by PROC_STARTTIME,SAI_CGI_ECGI,PROC_TYPE)  rn  
            from 
                (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                 from  ps.DETAIL_CDR_GbIuPS_18724
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(11*3600 as int) 
                union all 
                 select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                    from ps.DETAIL_CDR_S1MME_18724
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(11*3600 as int) 
               union all 
                 select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                   from cs.TDR_AIU_MM_18724
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and STARTTIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(11*3600 as int)  
               union all ---Add a record about the end time for each subscriber.
                    select 'DAY_END' as SAI_CGI_ECGI, IMSI,UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(11*3600 as int) as PROC_STARTTIME ,199 as PROC_TYPE from  ---  PROC_STARTTIME is used as the end time.
                       (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                         from  ps.DETAIL_CDR_GbIuPS_18724
                         where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(11*3600 as int) 
                   union all 
                        select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                        from ps.DETAIL_CDR_S1MME_18724
                        where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                        from cs.TDR_AIU_MM_18724
                        where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and   STARTTIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(11*3600 as int)
                        )c  
                      group by IMSI
                     )  a
            ) aa
        left join 
            (select a.*,row_number() over(partition by a.IMSI order by PROC_STARTTIME,SAI_CGI_ECGI,PROC_TYPE)  rn  
            from 
                (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                 from  ps.DETAIL_CDR_GbIuPS_18724
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(11*3600 as int) 
                union all 
                 select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                    from ps.DETAIL_CDR_S1MME_18724
                 where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(11*3600 as int) 
                union all 
                 select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                   from cs.TDR_AIU_MM_18724
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and STARTTIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(11*3600 as int)  
               union all ---Add a record about the end time for each subscriber.
                    select 'DAY_END' as SAI_CGI_ECGI, IMSI,UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(11*3600 as int) as PROC_STARTTIME ,199 as PROC_TYPE from  ---  PROC_STARTTIME is used as the end time.
                       (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                         from  ps.DETAIL_CDR_GbIuPS_18724
                         where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)    and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                        from ps.DETAIL_CDR_S1MME_18724
                        where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                        from cs.TDR_AIU_MM_18724
                        where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and STARTTIME>=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-07 00:00:00')+cast(11*3600 as int)
                        )c  
                      group by IMSI
                     )  a
            ) bb  on aa.IMSI = bb.IMSI and aa.rn = bb.rn-1 
       group by aa.IMSI,aa.SAI_CGI_ECGI
    )tbl1
    group by tbl1.IMSI,tbl1.SAI_CGI_ECGI
 union all
    select tbl1.IMSI,tbl1.SAI_CGI_ECGI as ECGI, sum(sum_timediff) as Total_Time
    from 
    (select aa.IMSI,aa.SAI_CGI_ECGI,sum(bb.PROC_STARTTIME - aa.PROC_STARTTIME) as sum_timediff from
            (select a.*,row_number() over(partition by a.IMSI order by PROC_STARTTIME,SAI_CGI_ECGI,PROC_TYPE)  rn  
            from 
                (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                 from  ps.DETAIL_CDR_GbIuPS_18725
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(11*3600 as int) 
                union all 
                 select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                    from ps.DETAIL_CDR_S1MME_18725
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(11*3600 as int) 
               union all 
                 select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                   from cs.TDR_AIU_MM_18725
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and STARTTIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(11*3600 as int)  
               union all ---Add a record about the end time for each subscriber.
                    select 'DAY_END' as SAI_CGI_ECGI, IMSI,UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(11*3600 as int) as PROC_STARTTIME ,199 as PROC_TYPE from  ---  PROC_STARTTIME is used as the end time.
                       (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                         from  ps.DETAIL_CDR_GbIuPS_18725
                         where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(11*3600 as int) 
                   union all 
                        select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                        from ps.DETAIL_CDR_S1MME_18725
                        where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                        from cs.TDR_AIU_MM_18725
                        where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and   STARTTIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(11*3600 as int)
                        )c  
                      group by IMSI
                     )  a
            ) aa
        left join 
            (select a.*,row_number() over(partition by a.IMSI order by PROC_STARTTIME,SAI_CGI_ECGI,PROC_TYPE)  rn  
            from 
                (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                 from  ps.DETAIL_CDR_GbIuPS_18725
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(11*3600 as int) 
                union all 
                 select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                    from ps.DETAIL_CDR_S1MME_18725
                 where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(11*3600 as int) 
                union all 
                 select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                   from cs.TDR_AIU_MM_18725
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and STARTTIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(11*3600 as int)  
               union all ---Add a record about the end time for each subscriber.
                    select 'DAY_END' as SAI_CGI_ECGI, IMSI,UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(11*3600 as int) as PROC_STARTTIME ,199 as PROC_TYPE from  ---  PROC_STARTTIME is used as the end time.
                       (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                         from  ps.DETAIL_CDR_GbIuPS_18725
                         where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)    and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                        from ps.DETAIL_CDR_S1MME_18725
                        where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                        from cs.TDR_AIU_MM_18725
                        where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and STARTTIME>=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-08 00:00:00')+cast(11*3600 as int)
                        )c  
                      group by IMSI
                     )  a
            ) bb  on aa.IMSI = bb.IMSI and aa.rn = bb.rn-1 
       group by aa.IMSI,aa.SAI_CGI_ECGI
    )tbl1
    group by tbl1.IMSI,tbl1.SAI_CGI_ECGI
 union all
    select tbl1.IMSI,tbl1.SAI_CGI_ECGI as ECGI, sum(sum_timediff) as Total_Time
    from 
    (select aa.IMSI,aa.SAI_CGI_ECGI,sum(bb.PROC_STARTTIME - aa.PROC_STARTTIME) as sum_timediff from
            (select a.*,row_number() over(partition by a.IMSI order by PROC_STARTTIME,SAI_CGI_ECGI,PROC_TYPE)  rn  
            from 
                (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                 from  ps.DETAIL_CDR_GbIuPS_18726
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(11*3600 as int) 
                union all 
                 select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                    from ps.DETAIL_CDR_S1MME_18726
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(11*3600 as int) 
               union all 
                 select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                   from cs.TDR_AIU_MM_18726
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and STARTTIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(11*3600 as int)  
               union all ---Add a record about the end time for each subscriber.
                    select 'DAY_END' as SAI_CGI_ECGI, IMSI,UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(11*3600 as int) as PROC_STARTTIME ,199 as PROC_TYPE from  ---  PROC_STARTTIME is used as the end time.
                       (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                         from  ps.DETAIL_CDR_GbIuPS_18726
                         where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(11*3600 as int) 
                   union all 
                        select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                        from ps.DETAIL_CDR_S1MME_18726
                        where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                        from cs.TDR_AIU_MM_18726
                        where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and   STARTTIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(11*3600 as int)
                        )c  
                      group by IMSI
                     )  a
            ) aa
        left join 
            (select a.*,row_number() over(partition by a.IMSI order by PROC_STARTTIME,SAI_CGI_ECGI,PROC_TYPE)  rn  
            from 
                (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                 from  ps.DETAIL_CDR_GbIuPS_18726
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(11*3600 as int) 
                union all 
                 select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                    from ps.DETAIL_CDR_S1MME_18726
                 where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(11*3600 as int) 
                union all 
                 select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                   from cs.TDR_AIU_MM_18726
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and STARTTIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(11*3600 as int)  
               union all ---Add a record about the end time for each subscriber.
                    select 'DAY_END' as SAI_CGI_ECGI, IMSI,UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(11*3600 as int) as PROC_STARTTIME ,199 as PROC_TYPE from  ---  PROC_STARTTIME is used as the end time.
                       (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                         from  ps.DETAIL_CDR_GbIuPS_18726
                         where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)    and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                        from ps.DETAIL_CDR_S1MME_18726
                        where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                        from cs.TDR_AIU_MM_18726
                        where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and STARTTIME>=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-09 00:00:00')+cast(11*3600 as int)
                        )c  
                      group by IMSI
                     )  a
            ) bb  on aa.IMSI = bb.IMSI and aa.rn = bb.rn-1 
       group by aa.IMSI,aa.SAI_CGI_ECGI
    )tbl1
    group by tbl1.IMSI,tbl1.SAI_CGI_ECGI
 union all
    select tbl1.IMSI,tbl1.SAI_CGI_ECGI as ECGI, sum(sum_timediff) as Total_Time
    from 
    (select aa.IMSI,aa.SAI_CGI_ECGI,sum(bb.PROC_STARTTIME - aa.PROC_STARTTIME) as sum_timediff from
            (select a.*,row_number() over(partition by a.IMSI order by PROC_STARTTIME,SAI_CGI_ECGI,PROC_TYPE)  rn  
            from 
                (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                 from  ps.DETAIL_CDR_GbIuPS_18727
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(11*3600 as int) 
                union all 
                 select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                    from ps.DETAIL_CDR_S1MME_18727
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(11*3600 as int) 
               union all 
                 select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                   from cs.TDR_AIU_MM_18727
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and STARTTIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(11*3600 as int)  
               union all ---Add a record about the end time for each subscriber.
                    select 'DAY_END' as SAI_CGI_ECGI, IMSI,UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(11*3600 as int) as PROC_STARTTIME ,199 as PROC_TYPE from  ---  PROC_STARTTIME is used as the end time.
                       (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                         from  ps.DETAIL_CDR_GbIuPS_18727
                         where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(11*3600 as int) 
                   union all 
                        select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                        from ps.DETAIL_CDR_S1MME_18727
                        where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                        from cs.TDR_AIU_MM_18727
                        where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and   STARTTIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(11*3600 as int)
                        )c  
                      group by IMSI
                     )  a
            ) aa
        left join 
            (select a.*,row_number() over(partition by a.IMSI order by PROC_STARTTIME,SAI_CGI_ECGI,PROC_TYPE)  rn  
            from 
                (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                 from  ps.DETAIL_CDR_GbIuPS_18727
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(11*3600 as int) 
                union all 
                 select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                    from ps.DETAIL_CDR_S1MME_18727
                 where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(11*3600 as int) 
                union all 
                 select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                   from cs.TDR_AIU_MM_18727
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and STARTTIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(11*3600 as int)  
               union all ---Add a record about the end time for each subscriber.
                    select 'DAY_END' as SAI_CGI_ECGI, IMSI,UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(11*3600 as int) as PROC_STARTTIME ,199 as PROC_TYPE from  ---  PROC_STARTTIME is used as the end time.
                       (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                         from  ps.DETAIL_CDR_GbIuPS_18727
                         where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)    and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                        from ps.DETAIL_CDR_S1MME_18727
                        where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                        from cs.TDR_AIU_MM_18727
                        where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and STARTTIME>=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-10 00:00:00')+cast(11*3600 as int)
                        )c  
                      group by IMSI
                     )  a
            ) bb  on aa.IMSI = bb.IMSI and aa.rn = bb.rn-1 
       group by aa.IMSI,aa.SAI_CGI_ECGI
    )tbl1
    group by tbl1.IMSI,tbl1.SAI_CGI_ECGI
 union all
    select tbl1.IMSI,tbl1.SAI_CGI_ECGI as ECGI, sum(sum_timediff) as Total_Time
    from 
    (select aa.IMSI,aa.SAI_CGI_ECGI,sum(bb.PROC_STARTTIME - aa.PROC_STARTTIME) as sum_timediff from
            (select a.*,row_number() over(partition by a.IMSI order by PROC_STARTTIME,SAI_CGI_ECGI,PROC_TYPE)  rn  
            from 
                (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                 from  ps.DETAIL_CDR_GbIuPS_18728
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(11*3600 as int) 
                union all 
                 select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                    from ps.DETAIL_CDR_S1MME_18728
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(11*3600 as int) 
               union all 
                 select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                   from cs.TDR_AIU_MM_18728
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and STARTTIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(11*3600 as int)  
               union all ---Add a record about the end time for each subscriber.
                    select 'DAY_END' as SAI_CGI_ECGI, IMSI,UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(11*3600 as int) as PROC_STARTTIME ,199 as PROC_TYPE from  ---  PROC_STARTTIME is used as the end time.
                       (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                         from  ps.DETAIL_CDR_GbIuPS_18728
                         where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(11*3600 as int) 
                   union all 
                        select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                        from ps.DETAIL_CDR_S1MME_18728
                        where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                        from cs.TDR_AIU_MM_18728
                        where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and   STARTTIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(11*3600 as int)
                        )c  
                      group by IMSI
                     )  a
            ) aa
        left join 
            (select a.*,row_number() over(partition by a.IMSI order by PROC_STARTTIME,SAI_CGI_ECGI,PROC_TYPE)  rn  
            from 
                (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                 from  ps.DETAIL_CDR_GbIuPS_18728
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(11*3600 as int) 
                union all 
                 select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                    from ps.DETAIL_CDR_S1MME_18728
                 where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(11*3600 as int) 
                union all 
                 select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                   from cs.TDR_AIU_MM_18728
                 where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and STARTTIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(11*3600 as int)  
               union all ---Add a record about the end time for each subscriber.
                    select 'DAY_END' as SAI_CGI_ECGI, IMSI,UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(11*3600 as int) as PROC_STARTTIME ,199 as PROC_TYPE from  ---  PROC_STARTTIME is used as the end time.
                       (select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                         from  ps.DETAIL_CDR_GbIuPS_18728
                         where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)    and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select SAI_CGI_ECGI,IMSI,PROC_STARTTIME,PROC_TYPE
                        from ps.DETAIL_CDR_S1MME_18728
                        where IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)   and PROC_STARTTIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(9*3600 as int) and PROC_STARTTIME<=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(11*3600 as int) 
                    union all 
                        select concat(MCC,MNC,LAC,CI) as SAI_CGI_ECGI, IMSI,STARTTIME as PROC_STARTTIME,SERVICE_TYPE as PROC_TYPE
                        from cs.TDR_AIU_MM_18728
                        where  IMSI in (select IMSI from tmp_ZCS_234GMigration_Promote_Data_IMSI_py_5_11Abr21)  and STARTTIME>=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(9*3600 as int) and STARTTIME<=UNIX_TIMESTAMP('2021-04-11 00:00:00')+cast(11*3600 as int)
                        )c  
                      group by IMSI
                     )  a
            ) bb  on aa.IMSI = bb.IMSI and aa.rn = bb.rn-1 
       group by aa.IMSI,aa.SAI_CGI_ECGI
    )tbl1
    group by tbl1.IMSI,tbl1.SAI_CGI_ECGI
 
)ccc
group by IMSI,ECGI
;
--</subquery_36>

--<subquery_37>
--------Export: list of cells where subscriber traffic consuming behavior needs to be guided
--select * from tmp_ZCS_234GMigration_Promote_Data_Cells_@OutputName  limit 30;
drop table if exists  tmp_ZCS_234GMigration_Promote_Data_Cells_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Promote_Data_Cells_py_5_11Abr21 
(Promote_Data_ECGI STRING,
  cell_name STRING,
  xpos BIGINT,
  ypos BIGINT,
  access_type STRING,
  Total_Stayed_Time BIGINT,
  Affected_Low_PS_User_Count BIGINT
);

insert into tmp_ZCS_234GMigration_Promote_Data_Cells_py_5_11Abr21
select ECGI, cell_name,xpos,ypos,access_type,Total_Stayed_Time,Affected_Low_PS_User_Count
from
    (   select ECGI,count(distinct IMSI) as Affected_Low_PS_User_Count,sum(Max_Total_Time) as Total_Stayed_Time from
           ( select a.IMSI,b.ECGI,a.Max_Total_Time from
                (select IMSI, max(Days_Total_Time) as Max_Total_Time from tmp_ZCS_234GMigration_User_Location_py_5_11Abr21 
                   group by IMSI
                ) a 
              left join tmp_ZCS_234GMigration_User_Location_py_5_11Abr21 b 
               on  a.IMSI=b.IMSI and a.Max_Total_Time=b.Days_Total_Time 
           ) c  
           where c.Max_Total_Time>0.3*(UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00')+86400)*(11-9)/24
       group by ECGI
   )d
left join nethouse.dim_loc_cgisai dim on d.ECGI = dim.CGISAI 
;
--</subquery_37>


--<subquery_38>
----------------------------Export the list of ten customized-types of subscribers. (Calculate the list only when required by a site. Export it only when it is required because the list file size is large.)
--select * from tmp_ZCS_234GMigration_Userlist_@OutputName limit 30;
drop table if exists  tmp_ZCS_234GMigration_Userlist_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Userlist_py_5_11Abr21
(Category STRING,
User_IMSI STRING,
IMEI STRING,
Phone_Brand STRING,
Phone_Model STRING,
Phone_Mode  STRING,
Phone_Type STRING,
Phone_OS STRING,
TER_Supported_Mode STRING,
Band_Supported_Mode STRING,
2G_Traffic_Flag STRING,
3G_Traffic_Flag STRING,
23G_Traffic_Flag STRING,
4G_Traffic_Flag STRING,
Total_Traffic_Flag STRING,
2G_Call_Flag STRING,
3G_Call_Flag STRING,
Total_Call_Flag STRING,
4G_Cover STRING
);
insert into tmp_ZCS_234GMigration_Userlist_py_5_11Abr21
select 'High_4G_Traffic' as Category, IMSI as User_IMSI,IMEI,
Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Supported_Mode ,Band_Supported_Mode ,2G_Traffic_Flag ,
3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag ,
2G_Call_Flag ,3G_Call_Flag,Total_Call_Flag ,4G_Cover  from
 (select * from tmp_ZCS_234GMigration_Base_py_5_11Abr21 where 4G_Traffic_Flag='4G_High_Traffic_User') a
 ;
--</subquery_38>

--<subquery_39>
insert into tmp_ZCS_234GMigration_Userlist_py_5_11Abr21
select 'Low_4G_Traffic_High_23G_Traffic_with_4G_Coverage' as Category, IMSI as User_IMSI,IMEI,
Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Supported_Mode ,Band_Supported_Mode ,2G_Traffic_Flag ,
3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag ,
2G_Call_Flag ,3G_Call_Flag,Total_Call_Flag ,4G_Cover  from
 (select * from tmp_ZCS_234GMigration_Base_py_5_11Abr21 where 4G_Traffic_Flag in ('4G_Mid_Traffic_User','4G_Low_Traffic_User') and 23g_traffic_flag='23G_High_Traffic_User' and 4g_cover ='4G_Cell_Around_300') b
;
--</subquery_39>

--<subquery_40>
insert into tmp_ZCS_234GMigration_Userlist_py_5_11Abr21
select 'Low_4G_Traffic_High_23G_Traffic_without_4G_Coverage' as Category, IMSI as User_IMSI,IMEI,
Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Supported_Mode ,Band_Supported_Mode ,2G_Traffic_Flag ,
3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag ,
2G_Call_Flag ,3G_Call_Flag,Total_Call_Flag ,4G_Cover  from
 (select * from tmp_ZCS_234GMigration_Base_py_5_11Abr21 where 4G_Traffic_Flag in ('4G_Mid_Traffic_User','4G_Low_Traffic_User') and 23g_traffic_flag='23G_High_Traffic_User' and 4g_cover ='NO_4G_Cell_Around_300') c
;
--</subquery_40>

--<subquery_41>
insert into tmp_ZCS_234GMigration_Userlist_py_5_11Abr21
select 'Low_4G_Traffic_Low_23G_Traffic' as Category, IMSI as User_IMSI,IMEI,
Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Supported_Mode ,Band_Supported_Mode ,2G_Traffic_Flag ,
3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag ,
2G_Call_Flag ,3G_Call_Flag,Total_Call_Flag ,4G_Cover  from
 (select * from tmp_ZCS_234GMigration_Base_py_5_11Abr21 where 4G_Traffic_Flag in ('4G_Mid_Traffic_User','4G_Low_Traffic_User') and 23g_traffic_flag in ('23G_Mid_Traffic_User','23G_Low_Traffic_User') ) d
;
--</subquery_41>

--<subquery_42>
insert into tmp_ZCS_234GMigration_Userlist_py_5_11Abr21
select 'No_4G_Traffic_4G_Terminal_High_23G_Traffic_with_4G_Coverage' as Category, IMSI as User_IMSI,IMEI,
Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Supported_Mode ,Band_Supported_Mode ,2G_Traffic_Flag ,
3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag ,
2G_Call_Flag ,3G_Call_Flag,Total_Call_Flag ,4G_Cover  from
 (select * from tmp_ZCS_234GMigration_Base_py_5_11Abr21 where 4G_Traffic_Flag ='NO_4G_Traffic_User' and Band_Supported_Mode='4G' and 23g_traffic_flag='23G_High_Traffic_User' and 4g_cover ='4G_Cell_Around_300' ) e
;
--</subquery_42>

--<subquery_43>
insert into tmp_ZCS_234GMigration_Userlist_py_5_11Abr21
select 'No_4G_Traffic_4G_Terminal_High_23G_Traffic_without_4G_Coverage' as Category, IMSI as User_IMSI,IMEI,
Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Supported_Mode ,Band_Supported_Mode ,2G_Traffic_Flag ,
3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag ,
2G_Call_Flag ,3G_Call_Flag,Total_Call_Flag ,4G_Cover  from
 (select * from tmp_ZCS_234GMigration_Base_py_5_11Abr21 where 4G_Traffic_Flag ='NO_4G_Traffic_User' and Band_Supported_Mode='4G' and 23g_traffic_flag='23G_High_Traffic_User' and 4g_cover ='NO_4G_Cell_Around_300' ) f
;
--</subquery_43>

--<subquery_44>
insert into tmp_ZCS_234GMigration_Userlist_py_5_11Abr21
select 'No_4G_Traffic_4G_Terminal_Low_23G_Traffic' as Category, IMSI as User_IMSI,IMEI,
Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Supported_Mode ,Band_Supported_Mode ,2G_Traffic_Flag ,
3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag ,
2G_Call_Flag ,3G_Call_Flag,Total_Call_Flag ,4G_Cover  from
 (select * from tmp_ZCS_234GMigration_Base_py_5_11Abr21 where 4G_Traffic_Flag ='NO_4G_Traffic_User' and Band_Supported_Mode='4G' and 23g_traffic_flag in ('23G_Mid_Traffic_User','23G_Low_Traffic_User') ) g
;
--</subquery_44>

--<subquery_45>
insert into tmp_ZCS_234GMigration_Userlist_py_5_11Abr21
select 'No_4G_Traffic_23G_Terminal_High_23G_Traffic_with_4G_Coverage' as Category, IMSI as User_IMSI,IMEI,
Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Supported_Mode ,Band_Supported_Mode ,2G_Traffic_Flag ,
3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag ,
2G_Call_Flag ,3G_Call_Flag,Total_Call_Flag ,4G_Cover  from
 (select * from tmp_ZCS_234GMigration_Base_py_5_11Abr21 where 4G_Traffic_Flag ='NO_4G_Traffic_User' and Band_Supported_Mode in ('2G','3G') and 23g_traffic_flag='23G_High_Traffic_User' and 4g_cover ='4G_Cell_Around_300' ) h
;
--</subquery_45>

--<subquery_46>
insert into tmp_ZCS_234GMigration_Userlist_py_5_11Abr21
select 'No_4G_Traffic_23G_Terminal_High_23G_Traffic_without_4G_Coverage' as Category, IMSI as User_IMSI ,IMEI,
Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Supported_Mode ,Band_Supported_Mode ,2G_Traffic_Flag ,
3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag ,
2G_Call_Flag ,3G_Call_Flag,Total_Call_Flag ,4G_Cover  from
 (select * from tmp_ZCS_234GMigration_Base_py_5_11Abr21 where 4G_Traffic_Flag ='NO_4G_Traffic_User' and Band_Supported_Mode in ('2G','3G') and 23g_traffic_flag='23G_High_Traffic_User' and 4g_cover ='NO_4G_Cell_Around_300' ) i
;
--</subquery_46>

--<subquery_47>
insert into tmp_ZCS_234GMigration_Userlist_py_5_11Abr21
select 'No_4G_Traffic_23G_Terminal_Low_23G_Traffic' as Category, IMSI as User_IMSI ,IMEI,
Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Supported_Mode ,Band_Supported_Mode ,2G_Traffic_Flag ,
3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag ,
2G_Call_Flag ,3G_Call_Flag,Total_Call_Flag ,4G_Cover  from
 (select * from tmp_ZCS_234GMigration_Base_py_5_11Abr21 where 4G_Traffic_Flag ='NO_4G_Traffic_User' and Band_Supported_Mode in ('2G','3G') and 23g_traffic_flag in ('23G_Mid_Traffic_User','23G_Low_Traffic_User') ) j
 ;
--</subquery_47>
 
--<subquery_48>
------------------Export the list of five types of resident cells. The related subscribers need to be found first. (Calculate the list only when required by a site.)
--select * from tmp_ZCS_234GMigration_Userlist2_@OutputName limit 30;
drop table if exists  tmp_ZCS_234GMigration_Userlist2_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Userlist2_py_5_11Abr21
(Category STRING,
User_IMSI STRING,
IMEI STRING,
Phone_Brand STRING,
Phone_Model STRING,
Phone_Mode  STRING,
Phone_Type STRING,
Phone_OS STRING,
TER_Supported_Mode STRING,
Band_Supported_Mode STRING,
2G_Traffic_Flag STRING,
3G_Traffic_Flag STRING,
23G_Traffic_Flag STRING,
4G_Traffic_Flag STRING,
Total_Traffic_Flag STRING,
Max_Cell_Traffic_MB DOUBLE,
Max_PSTraffic_ECGI STRING,
Max_PSTraffic_Cell_access_type STRING,
Max_PSTraffic_Cell_xpos BIGINT,
Max_PSTraffic_Cell_ypos BIGINT,
Nearest_4G_ECGI STRING,
Nearest_4G_Cell_Name STRING,
Nearest_4G_Cell_distance DOUBLE,
2G_Call_Flag STRING,
3G_Call_Flag STRING,
Total_Call_Flag STRING,
4G_Cover STRING
);
insert into tmp_ZCS_234GMigration_Userlist2_py_5_11Abr21
select 'No_4G_Traffic_4G_Terminal_High_23G_Traffic_with_4G_Coverage' as Category, IMSI as User_IMSI,IMEI,
Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Supported_Mode ,Band_Supported_Mode ,2G_Traffic_Flag ,
3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag ,Max_Cell_Traffic_MB ,Max_PSTraffic_ECGI ,Max_PSTraffic_Cell_access_type ,
Max_PSTraffic_Cell_xpos ,Max_PSTraffic_Cell_ypos ,Nearest_4G_ECGI ,Nearest_4G_Cell_Name ,Nearest_4G_Cell_distance ,
2G_Call_Flag ,3G_Call_Flag,Total_Call_Flag ,4G_Cover  from
 (select * from tmp_ZCS_234GMigration_Base_py_5_11Abr21 where 4G_Traffic_Flag ='NO_4G_Traffic_User' and Band_Supported_Mode='4G' and 23g_traffic_flag='23G_High_Traffic_User' and 4G_Cover ='4G_Cell_Around_300' ) e
;
--</subquery_48>

--<subquery_49>
insert into tmp_ZCS_234GMigration_Userlist2_py_5_11Abr21
select 'No_4G_Traffic_4G_Terminal_High_23G_Traffic_without_4G_Coverage' as Category, IMSI as User_IMSI,IMEI,
Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Supported_Mode ,Band_Supported_Mode ,2G_Traffic_Flag ,
3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag ,Max_Cell_Traffic_MB ,Max_PSTraffic_ECGI ,Max_PSTraffic_Cell_access_type ,
Max_PSTraffic_Cell_xpos ,Max_PSTraffic_Cell_ypos ,Nearest_4G_ECGI ,Nearest_4G_Cell_Name ,Nearest_4G_Cell_distance ,
2G_Call_Flag ,3G_Call_Flag,Total_Call_Flag ,4G_Cover  from
 (select * from tmp_ZCS_234GMigration_Base_py_5_11Abr21 where 4G_Traffic_Flag ='NO_4G_Traffic_User' and Band_Supported_Mode='4G' and 23g_traffic_flag='23G_High_Traffic_User' and 4G_Cover ='NO_4G_Cell_Around_300' ) f
; 
--</subquery_49>

--<subquery_50>
insert into tmp_ZCS_234GMigration_Userlist2_py_5_11Abr21
select 'Low_4G_Traffic_High_23G_Traffic_with_4G_Coverage' as Category, IMSI as User_IMSI,IMEI,
Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Supported_Mode ,Band_Supported_Mode ,2G_Traffic_Flag ,
3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag ,Max_Cell_Traffic_MB ,Max_PSTraffic_ECGI ,Max_PSTraffic_Cell_access_type ,
Max_PSTraffic_Cell_xpos ,Max_PSTraffic_Cell_ypos ,Nearest_4G_ECGI ,Nearest_4G_Cell_Name ,Nearest_4G_Cell_distance ,
2G_Call_Flag ,3G_Call_Flag,Total_Call_Flag ,4G_Cover  from
 (select * from tmp_ZCS_234GMigration_Base_py_5_11Abr21 where 4G_Traffic_Flag in ('4G_Mid_Traffic_User','4G_Low_Traffic_User') and 23g_traffic_flag='23G_High_Traffic_User' and 4G_Cover ='4G_Cell_Around_300') b
;
--</subquery_50>

--<subquery_51>
insert into tmp_ZCS_234GMigration_Userlist2_py_5_11Abr21
select 'Low_4G_Traffic_High_23G_Traffic_without_4G_Coverage' as Category, IMSI as User_IMSI,IMEI,
Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Supported_Mode ,Band_Supported_Mode ,2G_Traffic_Flag ,
3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag ,Max_Cell_Traffic_MB ,Max_PSTraffic_ECGI ,Max_PSTraffic_Cell_access_type ,
Max_PSTraffic_Cell_xpos ,Max_PSTraffic_Cell_ypos ,Nearest_4G_ECGI ,Nearest_4G_Cell_Name ,Nearest_4G_Cell_distance ,
2G_Call_Flag ,3G_Call_Flag,Total_Call_Flag ,4G_Cover  from
 (select * from tmp_ZCS_234GMigration_Base_py_5_11Abr21 where 4G_Traffic_Flag in ('4G_Mid_Traffic_User','4G_Low_Traffic_User') and 23g_traffic_flag='23G_High_Traffic_User' and 4G_Cover ='NO_4G_Cell_Around_300') c
;
--</subquery_51>

--<subquery_52>
insert into tmp_ZCS_234GMigration_Userlist2_py_5_11Abr21
select 'No_4G_Traffic_23G_Terminal_High_23G_Traffic_without_4G_Coverage' as Category, IMSI as User_IMSI ,IMEI,
Phone_Brand ,Phone_Model ,Phone_Mode  ,Phone_Type ,Phone_OS ,TER_Supported_Mode ,Band_Supported_Mode ,2G_Traffic_Flag ,
3G_Traffic_Flag ,23G_Traffic_Flag ,4G_Traffic_Flag ,Total_Traffic_Flag ,Max_Cell_Traffic_MB ,Max_PSTraffic_ECGI ,Max_PSTraffic_Cell_access_type ,
Max_PSTraffic_Cell_xpos ,Max_PSTraffic_Cell_ypos ,Nearest_4G_ECGI ,Nearest_4G_Cell_Name ,Nearest_4G_Cell_distance ,
2G_Call_Flag ,3G_Call_Flag,Total_Call_Flag ,4G_Cover  from
 (select * from tmp_ZCS_234GMigration_Base_py_5_11Abr21 where 4G_Traffic_Flag ='NO_4G_Traffic_User' and Band_Supported_Mode in ('2G','3G') and 23g_traffic_flag='23G_High_Traffic_User' and 4G_Cover ='NO_4G_Cell_Around_300' ) i
;
--</subquery_52>


--<subquery_53>
--------Export the list of five types of resident cells. (Calculate the list only when required by a site.)
--select * from tmp_ZCS_234GMigration_Locations_@OutputName limit 30;
drop table if exists  tmp_ZCS_234GMigration_Locations_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Locations_py_5_11Abr21
(Category STRING,
ECGI STRING,
Access_Type STRING,
Cell_xpos BIGINT,
Cell_ypos BIGINT,
Impacted_Users BIGINT
);

insert into tmp_ZCS_234GMigration_Locations_py_5_11Abr21
select 'No_4G_Traffic_4G_Terminal_High_23G_Traffic_with_4G_Coverage' as Category, 
Max_PSTraffic_ECGI as ECGI,Max_PSTraffic_Cell_access_type as Access_Type,
Max_PSTraffic_Cell_xpos as Cell_xpos,Max_PSTraffic_Cell_ypos as Cell_ypos,count(distinct User_IMSI) as Impacted_Users  from
(select * from tmp_ZCS_234GMigration_Userlist2_py_5_11Abr21 where Category='No_4G_Traffic_4G_Terminal_High_23G_Traffic_with_4G_Coverage') e
group by Category, ECGI,Access_Type,Cell_xpos,Cell_ypos;
insert into tmp_ZCS_234GMigration_Locations_py_5_11Abr21
select 'No_4G_Traffic_4G_Terminal_High_23G_Traffic_without_4G_Coverage' as Category, 
Max_PSTraffic_ECGI as ECGI,Max_PSTraffic_Cell_access_type as Access_Type,
Max_PSTraffic_Cell_xpos as Cell_xpos,Max_PSTraffic_Cell_ypos as Cell_ypos,count(distinct User_IMSI) as Impacted_Users  from
(select * from tmp_ZCS_234GMigration_Userlist2_py_5_11Abr21 where Category='No_4G_Traffic_4G_Terminal_High_23G_Traffic_without_4G_Coverage') e
group by Category, ECGI,Access_Type,Cell_xpos,Cell_ypos;
insert into tmp_ZCS_234GMigration_Locations_py_5_11Abr21
select 'Low_4G_Traffic_High_23G_Traffic_with_4G_Coverage' as Category, 
Max_PSTraffic_ECGI as ECGI,Max_PSTraffic_Cell_access_type as Access_Type,
Max_PSTraffic_Cell_xpos as Cell_xpos,Max_PSTraffic_Cell_ypos as Cell_ypos,count(distinct User_IMSI) as Impacted_Users  from
(select * from tmp_ZCS_234GMigration_Userlist2_py_5_11Abr21 where Category='Low_4G_Traffic_High_23G_Traffic_with_4G_Coverage') e
group by Category, ECGI,Access_Type,Cell_xpos,Cell_ypos;
insert into tmp_ZCS_234GMigration_Locations_py_5_11Abr21
select 'Low_4G_Traffic_High_23G_Traffic_without_4G_Coverage' as Category, 
Max_PSTraffic_ECGI as ECGI,Max_PSTraffic_Cell_access_type as Access_Type,
Max_PSTraffic_Cell_xpos as Cell_xpos,Max_PSTraffic_Cell_ypos as Cell_ypos,count(distinct User_IMSI) as Impacted_Users  from
(select * from tmp_ZCS_234GMigration_Userlist2_py_5_11Abr21 where Category='Low_4G_Traffic_High_23G_Traffic_without_4G_Coverage') e
group by Category, ECGI,Access_Type,Cell_xpos,Cell_ypos;
insert into tmp_ZCS_234GMigration_Locations_py_5_11Abr21
select 'No_4G_Traffic_23G_Terminal_High_23G_Traffic_without_4G_Coverage' as Category, 
Max_PSTraffic_ECGI as ECGI,Max_PSTraffic_Cell_access_type as Access_Type,
Max_PSTraffic_Cell_xpos as Cell_xpos,Max_PSTraffic_Cell_ypos as Cell_ypos,count(distinct User_IMSI) as Impacted_Users  from
(select * from tmp_ZCS_234GMigration_Userlist2_py_5_11Abr21 where Category='No_4G_Traffic_23G_Terminal_High_23G_Traffic_without_4G_Coverage') e
group by Category, ECGI,Access_Type,Cell_xpos,Cell_ypos;
--</subquery_53>
 
 
--<subquery_54>
----------------------Obtain information about subscribers who consume no 4G traffic and heavy 2G or 3G traffic, and are in available adjacent 4G coverage.
--select * from tmp_ZCS_234GMigration_4GZero_HighPS_Users_@OutputName limit 30;
drop table if exists  tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21;
create table tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21
(IMSI STRING,
Max_PSTraffic_ECGI STRING,
Nearest_4G_ECGI  STRING,
Total_traffic_MB DOUBLE
);
insert into tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21
select IMSI,Max_PSTraffic_ECGI,Nearest_4G_ECGI,Total_traffic_MB   from 
                  (select c.*,
                            case when (Setting_Status='Check_4G_Coverage'and Nearest_4G_ECGI is not null) or 
                                              (TER_Supported_Mode='4G' and Band_Supported_Mode ='4G' and coalesce(4G_traffic_MB,0)=0  and  coalesce(Total_traffic_MB,0)>0 and Nearest_4G_ECGI is not null ) then '4G_Cell_Around_300'
                                 when (Setting_Status='Check_4G_Coverage'and Nearest_4G_ECGI is null) or
                                           (TER_Supported_Mode='4G' and Band_Supported_Mode ='4G' and coalesce(4G_traffic_MB,0)=0  and  coalesce(Total_traffic_MB,0)>0 and Nearest_4G_ECGI is null ) then 'NO_4G_Cell_Around_300'
                                 else  'No_Care'   end as 4G_Coverage
                    from
                         (  select a.*,
                                    case when 2G_traffic_MB>0 or 3G_traffic_MB>0  then 23G_Traffic_Flag
                                         else 'No_Care'     end as 23G_Traffic
                             from   tmp_ZCS_234GMigration_Base_py_5_11Abr21 a
                          )c    
                 )d  where 4G_Coverage='4G_Cell_Around_300'  and Max_PSTraffic_Cell_access_type in ('2G','3G') and  23g_traffic = '23G_High_Traffic_User'
;
--</subquery_54>

--<subquery_55>
------Export: Collect traffic consuming data of subscribers who are in 4G coverage, and consume no 4G traffic but heavy 2G or 3G traffic to draw the traffic PDF chart.
--select * from tmp_ZCS_234GMigration_Promote_Data_Users_@OutputName limit 30;
drop table if exists  tmp_ZCS_234GMigration_Promote_Data_Users_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Promote_Data_Users_py_5_11Abr21
(Scales STRING,
4GZero_HighPS_UserCount BIGINT
);
insert into tmp_ZCS_234GMigration_Promote_Data_Users_py_5_11Abr21
    select '0-10MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>0 and Total_traffic_MB<=10*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1)
union all
    select '10-20MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>10*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=20*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1)
union all
    select '20-30MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>20*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=30*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1)
union all
    select '30-40MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>30*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=40*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1)
union all
    select '40-50MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>40*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=50*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1)
union all
    select '50-60MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>50*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=60*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1)
 union all
    select '60-70MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>60*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=70*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1)
union all
    select '70-80MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>70*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=80*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1)
union all
    select '80-90MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>80*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=90*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05  00:00:00'))/86400+1)
union all
    select '90-100MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>90*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=100*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1)
 union all
    select '100-110MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>100*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=110*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '110-120MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>110*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=120*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '120-130MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>120*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=130*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '130-140MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>130*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=140*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '140-150MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>140*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=150*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '150-160MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>150*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=160*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '160-170MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>160*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=170*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '170-180MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>170*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=180*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '180-190MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>180*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=190*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '190-200MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>190*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=200*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '200-210MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>200*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=210*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '210-220MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>210*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=220*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '220-230MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>220*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=230*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '230-240MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>230*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=240*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1)
 union all
    select '240-250MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>240*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=250*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '250-260MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>250*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=260*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '260-270MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>260*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=270*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '270-280MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>270*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=280*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '280-290MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>280*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=290*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select '290-300MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>290*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) and Total_traffic_MB<=300*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1) 
 union all
    select 'More Than 300MB Per Day' as Scales, count (distinct IMSI) as 4GZero_HighPS_UserCount
    from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21 where Total_traffic_MB>300*((UNIX_TIMESTAMP('2021-04-11 00:00:00')-UNIX_TIMESTAMP('2021-04-05 00:00:00'))/86400+1)  
;
--</subquery_55>

--<subquery_56>
-------Calculate indicators of 4G subscribers who are in 4G coverage, and consume heavy 4G traffic but light 2G and 3G traffic. (Calculate the indicators only when required.)
---Step 1. Define key service types.
--select * from tmp_ZCS_234GMigration_Prot_Define_@OutputName limit 30;
drop table if exists  tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21
(Prot_Name STRING,
Prot_ID BIGINT
);
insert into tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21
select 'FaceBook' as Prot_Name, sub_prot_id from nethouse.dim_sub_prot where upper(sub_prot) like upper('%Facebook%')
union all
select 'YouTube' as Prot_Name, sub_prot_id from nethouse.dim_sub_prot where upper(sub_prot) like upper('%YouTube%')
;
--</subquery_56>

--<subquery_57>
-------Collect data of 2G or 3G indicators for subscribers who consume no 4G traffic and heavy 2G or 3G traffic. (Collect the data only when required.)
---Step 2. Collect data of 2G and 3G indicators.
--select * from tmp_ZCS_234GMigration_23GHighPS_KPIBase_@OutputName ;
drop table if exists  tmp_ZCS_234GMigration_23GHighPS_KPIBase_py_5_11Abr21;
create table tmp_ZCS_234GMigration_23GHighPS_KPIBase_py_5_11Abr21
( prot_category  BIGINT,
 prot_type BIGINT,
 imsi STRING,           
 rat INT,
 sai_cgi_ecgi STRING,     
 tcp_conn_states  DOUBLE,
 l4_ul_throughput DOUBLE,
 l4_dw_throughput DOUBLE, 
 tcp_ul_retrans_withpl  DOUBLE,
 tcp_dw_retrans_withpl  DOUBLE,
 tcp_ul_packages_withpl  DOUBLE,
 tcp_dw_packages_withpl  DOUBLE,
 tcp_ul_outofsequ  DOUBLE,
 tcp_dw_outofsequ  DOUBLE,
 tcp_rtt  DOUBLE,
 tcp_rtt_step1  DOUBLE,
 avg_ul_rtt  DOUBLE,
 avg_dw_rtt  DOUBLE,
 ul_rtt_stat_num  DOUBLE,
 dw_rtt_stat_num  DOUBLE,
 server_probe_ul_lost_pkt DOUBLE, 
 server_probe_dw_lost_pkt  DOUBLE,
 user_probe_ul_lost_pkt  DOUBLE,
 user_probe_dw_lost_pkt  DOUBLE
);

insert into tmp_ZCS_234GMigration_23GHighPS_KPIBase_py_5_11Abr21
select a.* from 
(
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_Other_18722 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_streaming_18722 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_http_browsing_18722 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_IM_18722 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_VOIP_18722 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
--union all
--select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
--            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--            when RAT=2 then concat(MCC,MNC,LAC,CI)
--            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
--        TCP_CONN_STATES,
--        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
--        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
--        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
--        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
--        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
--       from  ps.DETAIL_UFDR_SNS_18722 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_Other_18723 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_streaming_18723 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_http_browsing_18723 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_IM_18723 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_VOIP_18723 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
--union all
--select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
--            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--            when RAT=2 then concat(MCC,MNC,LAC,CI)
--            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
--        TCP_CONN_STATES,
--        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
--        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
--        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
--        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
--        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
--       from  ps.DETAIL_UFDR_SNS_18723 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_Other_18724 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_streaming_18724 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_http_browsing_18724 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_IM_18724 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_VOIP_18724 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
--union all
--select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
--            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--            when RAT=2 then concat(MCC,MNC,LAC,CI)
--            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
--        TCP_CONN_STATES,
--        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
--        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
--        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
--        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
--        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
--       from  ps.DETAIL_UFDR_SNS_18724 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_Other_18725 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_streaming_18725 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_http_browsing_18725 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_IM_18725 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_VOIP_18725 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
--union all
--select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
--            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--            when RAT=2 then concat(MCC,MNC,LAC,CI)
--            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
--        TCP_CONN_STATES,
--        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
--        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
--        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
--        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
--        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
--       from  ps.DETAIL_UFDR_SNS_18725 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_Other_18726 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_streaming_18726 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_http_browsing_18726 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_IM_18726 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_VOIP_18726 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
--union all
--select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
--            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--            when RAT=2 then concat(MCC,MNC,LAC,CI)
--            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
--        TCP_CONN_STATES,
--        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
--        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
--        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
--        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
--        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
--       from  ps.DETAIL_UFDR_SNS_18726 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_Other_18727 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_streaming_18727 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_http_browsing_18727 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_IM_18727 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_VOIP_18727 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
--union all
--select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
--            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--            when RAT=2 then concat(MCC,MNC,LAC,CI)
--            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
--        TCP_CONN_STATES,
--        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
--        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
--        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
--        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
--        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
--       from  ps.DETAIL_UFDR_SNS_18727 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_Other_18728 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_streaming_18728 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_http_browsing_18728 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_IM_18728 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_VOIP_18728 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
--union all
--select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
--            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--            when RAT=2 then concat(MCC,MNC,LAC,CI)
--            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
--        TCP_CONN_STATES,
--        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
--        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
--        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
--        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
--        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
--       from  ps.DETAIL_UFDR_SNS_18728 where imsi in (select imsi from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21) and PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)

)a
where SAI_CGI_ECGI in  (select Max_PSTraffic_ECGI from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21)
;
--</subquery_57>

--<subquery_58>
-------Collect data of 4G indicators of the 4G cell within 500 m away from the 2G or 3G cell with the heaviest consumed traffic for subscribers who consume no 4G traffic and heavy 2G or 3G traffic. (Collect the data only when required.)
---Step 3. Collect data of 4G indicators.
--select * from tmp_ZCS_234GMigration_Near4G_KPIBase_@OutputName limit 30;
drop table if exists  tmp_ZCS_234GMigration_Near4G_KPIBase_py_5_11Abr21;
create table tmp_ZCS_234GMigration_Near4G_KPIBase_py_5_11Abr21
( prot_category  BIGINT,
 prot_type BIGINT,
 imsi STRING,           
 rat INT,
 sai_cgi_ecgi STRING,     
 tcp_conn_states  DOUBLE,
 l4_ul_throughput DOUBLE,
 l4_dw_throughput DOUBLE, 
 tcp_ul_retrans_withpl  DOUBLE,
 tcp_dw_retrans_withpl  DOUBLE,
 tcp_ul_packages_withpl  DOUBLE,
 tcp_dw_packages_withpl  DOUBLE,
 tcp_ul_outofsequ  DOUBLE,
 tcp_dw_outofsequ  DOUBLE,
 tcp_rtt  DOUBLE,
 tcp_rtt_step1  DOUBLE,
 avg_ul_rtt  DOUBLE,
 avg_dw_rtt  DOUBLE,
 ul_rtt_stat_num  DOUBLE,
 dw_rtt_stat_num  DOUBLE,
 server_probe_ul_lost_pkt DOUBLE, 
 server_probe_dw_lost_pkt  DOUBLE,
 user_probe_ul_lost_pkt  DOUBLE,
 user_probe_dw_lost_pkt  DOUBLE
);

insert into tmp_ZCS_234GMigration_Near4G_KPIBase_py_5_11Abr21
select a.* from 
(
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_Other_18722 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_streaming_18722 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_http_browsing_18722 where  PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_IM_18722 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_VOIP_18722 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
--union all
--select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
--            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--            when RAT=2 then concat(MCC,MNC,LAC,CI)
--            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
--        TCP_CONN_STATES,
--        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
--        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
--        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
--        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
--        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
--       from  ps.DETAIL_UFDR_SNS_18722 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_Other_18723 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_streaming_18723 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_http_browsing_18723 where  PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_IM_18723 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_VOIP_18723 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
--union all
--select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
--            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--            when RAT=2 then concat(MCC,MNC,LAC,CI)
--            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
--        TCP_CONN_STATES,
--        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
--        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
--        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
--        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
--        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
--       from  ps.DETAIL_UFDR_SNS_18723 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_Other_18724 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_streaming_18724 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_http_browsing_18724 where  PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_IM_18724 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_VOIP_18724 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
--union all
--select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
--            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--            when RAT=2 then concat(MCC,MNC,LAC,CI)
--            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
--        TCP_CONN_STATES,
--        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
--        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
--        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
--        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
--        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
--       from  ps.DETAIL_UFDR_SNS_18724 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_Other_18725 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_streaming_18725 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_http_browsing_18725 where  PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_IM_18725 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_VOIP_18725 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
--union all
--select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
--            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--            when RAT=2 then concat(MCC,MNC,LAC,CI)
--            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
--        TCP_CONN_STATES,
--        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
--        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
--        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
--        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
--        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
--       from  ps.DETAIL_UFDR_SNS_18725 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_Other_18726 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_streaming_18726 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_http_browsing_18726 where  PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_IM_18726 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_VOIP_18726 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
--union all
--select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
--            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--            when RAT=2 then concat(MCC,MNC,LAC,CI)
--            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
--        TCP_CONN_STATES,
--        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
--        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
--        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
--        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
--        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
--       from  ps.DETAIL_UFDR_SNS_18726 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_Other_18727 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_streaming_18727 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_http_browsing_18727 where  PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_IM_18727 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_VOIP_18727 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
--union all
--select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
--            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--            when RAT=2 then concat(MCC,MNC,LAC,CI)
--            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
--        TCP_CONN_STATES,
--        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
--        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
--        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
--        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
--        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
--       from  ps.DETAIL_UFDR_SNS_18727 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_Other_18728 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_streaming_18728 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.detail_ufdr_http_browsing_18728 where  PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_IM_18728 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
union all
select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
            when RAT=2 then concat(MCC,MNC,LAC,CI)
            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
        TCP_CONN_STATES,
        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
       from  ps.DETAIL_UFDR_VOIP_18728 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)
--union all
--select  PROT_CATEGORY,PROT_TYPE,imsi,rat,
--            case when RAT=1 or RAT=5 then concat(MCC,MNC,LAC,SAC)
--            when RAT=2 then concat(MCC,MNC,LAC,CI)
--            when RAT=6 then concat(MCC,MNC,ECI)  end  as SAI_CGI_ECGI,  --Cell ID
--        TCP_CONN_STATES,
--        L4_UL_THROUGHPUT,L4_DW_THROUGHPUT,
--        TCP_UL_RETRANS_WITHPL,TCP_DW_RETRANS_WITHPL, TCP_UL_PACKAGES_WITHPL,TCP_DW_PACKAGES_WITHPL,
--        TCP_UL_OUTOFSEQU, TCP_DW_OUTOFSEQU,
--        TCP_RTT,TCP_RTT_STEP1,AVG_UL_RTT, AVG_DW_RTT,UL_RTT_STAT_NUM,DW_RTT_STAT_NUM,
--        SERVER_PROBE_UL_LOST_PKT,SERVER_PROBE_DW_LOST_PKT,USER_PROBE_UL_LOST_PKT,USER_PROBE_DW_LOST_PKT
--       from  ps.DETAIL_UFDR_SNS_18728 where PROT_TYPE in (select Prot_ID from tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21)

)a
where SAI_CGI_ECGI in  (select Nearest_4G_ECGI from tmp_ZCS_234GMigration_4GZero_HighPS_Users_py_5_11Abr21)
;
--</subquery_58>

--<subquery_59>
------Export: 4G indicators of the 4G cell within 500 m away from the 2G or 3G cell with the heaviest traffic for subscribers who consume no 4G traffic and heavy 2G or 3G traffic
---Step 4. Integrate 2G, 3G, and 4G indicators into one table.
--select * from tmp_ZCS_234GMigration_23GHighPS_KPI_@OutputName limit 30;
drop table if exists  tmp_ZCS_234GMigration_23GHighPS_KPI_py_5_11Abr21;
create table tmp_ZCS_234GMigration_23GHighPS_KPI_py_5_11Abr21
(prot_name STRING,
 rat INT,
 ps_user_count DOUBLE,
 traffic_mb    DOUBLE,     
 ul_traffic_mb      DOUBLE,
 dl_traffic_mb      DOUBLE,
 tcp_conn_succ_rate  DOUBLE,
 tcp_retra_rate       DOUBLE,
 ul_tcp_retra_rate    DOUBLE,
 dw_tcp_retra_rate    DOUBLE,
 tcp_out_of_order_rate  DOUBLE,
 ul_tcp_out_of_order_rate  DOUBLE,
 dw_tcp_out_of_order_rate  DOUBLE,
 e2e_delay_ms       DOUBLE,
 sever_side_rtt     DOUBLE,
 client_side_rtt    DOUBLE,
 server_ul_tcp_packet_loss_rate DOUBLE, 
 server_dw_tcp_packet_loss_rate  DOUBLE,
 client_ul_tcp_packet_loss_rate  DOUBLE,
 client_dw_tcp_packet_loss_rate  DOUBLE,
 Access_Type STRING
);

insert into tmp_ZCS_234GMigration_23GHighPS_KPI_py_5_11Abr21
select d.*,
            case when RAT=1 or RAT=5 then '3G'
            when RAT=2 then '2G'
            when RAT=6 then '4G'    end as Access_Type 
        from
(select Prot_Name,rat,count(distinct imsi) as PS_User_Count, 
        sum(L4_UL_THROUGHPUT+L4_DW_THROUGHPUT)/1024/1024 as Traffic_MB, ----total traffic
        sum(L4_UL_THROUGHPUT)/1024/1024 as UL_Traffic_MB, ----total uplink traffic
        sum(L4_DW_THROUGHPUT)/1024/1024 as DL_Traffic_MB, ----total downlink traffic
        case when sum( case when TCP_CONN_STATES is not null then 1 else 0 end)>0 then sum(case when TCP_CONN_STATES=0 then 1 else 0 end)/sum( case when TCP_CONN_STATES is not null then 1 else 0 end) end as TCP_Conn_Succ_Rate,  ---TCP Connection Success Rate(%)    
        case when sum(TCP_UL_PACKAGES_WITHPL+TCP_DW_PACKAGES_WITHPL)>0 then sum(TCP_UL_RETRANS_WITHPL+TCP_DW_RETRANS_WITHPL)/sum(TCP_UL_PACKAGES_WITHPL+TCP_DW_PACKAGES_WITHPL) end as TCP_Retra_Rate, ---TCP Retransmission Rate(%)    
        case when sum(TCP_UL_PACKAGES_WITHPL)>0 then sum(TCP_UL_RETRANS_WITHPL)/sum(TCP_UL_PACKAGES_WITHPL) end as UL_TCP_Retra_Rate, ---Uplink TCP Retransmission Rate(%)    
        case when sum(TCP_DW_PACKAGES_WITHPL)>0 then sum(TCP_DW_RETRANS_WITHPL)/sum(TCP_DW_PACKAGES_WITHPL) end as DW_TCP_Retra_Rate, ---Downlink TCP Retransmission Rate(%)    
        case when sum(TCP_UL_PACKAGES_WITHPL+TCP_DW_PACKAGES_WITHPL)>0 then sum(TCP_UL_OUTOFSEQU+TCP_DW_OUTOFSEQU)/sum(TCP_UL_PACKAGES_WITHPL+TCP_DW_PACKAGES_WITHPL) end as TCP_Out_of_Order_Rate,--TCP Out-of-Order Rate(%)
        case when sum(TCP_UL_PACKAGES_WITHPL)>0 then sum(TCP_UL_OUTOFSEQU)/sum(TCP_UL_PACKAGES_WITHPL) end as UL_TCP_Out_of_Order_Rate,--Uplink TCP Out-of-Order Rate(%)
        case when sum(TCP_DW_PACKAGES_WITHPL)>0 then sum(TCP_DW_OUTOFSEQU)/sum(TCP_DW_PACKAGES_WITHPL) end as DW_TCP_Out_of_Order_Rate,--Downlink TCP Out-of-Order Rate(%)
        case when sum( case when TCP_CONN_STATES=0 and TCP_RTT>0 and TCP_RTT_STEP1 >0 and TCP_RTT > TCP_RTT_STEP1 then 1 else 0 end)>0 then sum(case when TCP_RTT>0 and TCP_RTT_STEP1 >0 and TCP_RTT > TCP_RTT_STEP1 then TCP_RTT ELSE 0 END)/sum( case when TCP_CONN_STATES=0 and TCP_RTT>0 and TCP_RTT_STEP1 >0 and TCP_RTT > TCP_RTT_STEP1 then 1 else 0 end) end as E2E_Delay_ms, --E2E Delay(ms)
        case when sum(case when TCP_CONN_STATES =0 then UL_RTT_STAT_NUM end)>0 then  sum(case when TCP_CONN_STATES =0 Then AVG_UL_RTT*UL_RTT_STAT_NUM end)/sum(case when TCP_CONN_STATES =0 then UL_RTT_STAT_NUM end) end as Sever_Side_RTT,   --Server Side Round Trip Time(ms)    
        case when sum(case when TCP_CONN_STATES =0 Then DW_RTT_STAT_NUM end)>0 then  sum(case when TCP_CONN_STATES=0 Then AVG_DW_RTT*DW_RTT_STAT_NUM end)/sum(case when TCP_CONN_STATES =0 Then DW_RTT_STAT_NUM end) end as Client_Side_RTT,   --Client Side Round Trip Time(ms)
        case when SUM(TCP_UL_PACKAGES_WITHPL) >0 then sum(case when TCP_CONN_STATES =0 then SERVER_PROBE_UL_LOST_PKT end)/SUM(TCP_UL_PACKAGES_WITHPL) end as Server_UL_TCP_Packet_Loss_Rate,--Server Side Uplink TCP Packet Loss Rate(%)    
        case when SUM(TCP_DW_PACKAGES_WITHPL) >0 then sum(case when TCP_CONN_STATES =0 Then SERVER_PROBE_DW_LOST_PKT end) /SUM(TCP_DW_PACKAGES_WITHPL) end as Server_DW_TCP_Packet_Loss_Rate, --Server Side Downlink TCP Packet Loss Rate(%)
        case when SUM(TCP_UL_PACKAGES_WITHPL) >0 then sum(case when TCP_CONN_STATES =0 then USER_PROBE_UL_LOST_PKT end)/SUM(TCP_UL_PACKAGES_WITHPL) end as Client_UL_TCP_Packet_Loss_Rate, --Client Side Uplink TCP Packet Loss Rate(%)    
        case when SUM(TCP_DW_PACKAGES_WITHPL) >0 then sum(case when TCP_CONN_STATES =0 Then USER_PROBE_DW_LOST_PKT end)/SUM(TCP_DW_PACKAGES_WITHPL) end as Client_DW_TCP_Packet_Loss_Rate --Client Side Downlink TCP Packet Loss Rate(%)    
    FROM  
        (select a.*,b.PROT_Name from 
            (select * from tmp_ZCS_234GMigration_23GHighPS_KPIBase_py_5_11Abr21
             union all
             select * from tmp_ZCS_234GMigration_Near4G_KPIBase_py_5_11Abr21
            )a
        left join tmp_ZCS_234GMigration_Prot_Define_py_5_11Abr21 b
        on a.PROT_TYPE=b.PROT_ID
        ) c
   group by Prot_Name,rat
) d
;
--</subquery_59>

